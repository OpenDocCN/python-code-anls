# `stable-diffusion-webui\modules\script_callbacks.py`

```
# 导入 inspect 模块，用于获取对象信息
import inspect
# 导入 os 模块，提供了一种使用操作系统功能的接口
import os
# 导入 namedtuple 类型，用于创建命名元组
from collections import namedtuple
# 导入 Optional 和 Any 类型，用于类型提示
from typing import Optional, Any
# 导入 FastAPI 类，用于创建 Web API
from fastapi import FastAPI
# 导入 Blocks 模块，用于定义数据块
from gradio import Blocks
# 导入 errors 和 timer 模块
from modules import errors, timer

# 定义一个函数，用于报告异常
def report_exception(c, job):
    errors.report(f"Error executing callback {job} for {c.script}", exc_info=True)

# 定义一个类，用于保存图像保存的参数
class ImageSaveParams:
    def __init__(self, image, p, filename, pnginfo):
        self.image = image
        """the PIL image itself"""

        self.p = p
        """p object with processing parameters; either StableDiffusionProcessing or an object with same fields"""

        self.filename = filename
        """name of file that the image would be saved to"""

        self.pnginfo = pnginfo
        """dictionary with parameters for image's PNG info data; infotext will have the key 'parameters'"""

# 定义一个类，用于保存额外噪音的参数
class ExtraNoiseParams:
    def __init__(self, noise, x, xi):
        self.noise = noise
        """Random noise generated by the seed"""

        self.x = x
        """Latent representation of the image"""

        self.xi = xi
        """Noisy latent representation of the image"""

# 定义一个类，用于保存 CFGDenoiser 的参数
class CFGDenoiserParams:
    def __init__(self, x, image_cond, sigma, sampling_step, total_sampling_steps, text_cond, text_uncond):
        self.x = x
        """Latent image representation in the process of being denoised"""

        self.image_cond = image_cond
        """Conditioning image"""

        self.sigma = sigma
        """Current sigma noise step value"""

        self.sampling_step = sampling_step
        """Current Sampling step number"""

        self.total_sampling_steps = total_sampling_steps
        """Total number of sampling steps planned"""

        self.text_cond = text_cond
        """ Encoder hidden states of text conditioning from prompt"""

        self.text_uncond = text_uncond
        """ Encoder hidden states of text conditioning from negative prompt"""

# 定义一个类，用于保存 CFGDenoised 的参数
class CFGDenoisedParams:
    # 初始化函数，接受参数 x（待去噪的潜在图像表示）、sampling_step（当前采样步数）、total_sampling_steps（计划的总采样步数）、inner_model（用于去噪的内部模型引用）
    def __init__(self, x, sampling_step, total_sampling_steps, inner_model):
        # 设置实例变量 x 为传入的潜在图像表示
        self.x = x
        """Latent image representation in the process of being denoised"""

        # 设置实例变量 sampling_step 为传入的当前采样步数
        self.sampling_step = sampling_step
        """Current Sampling step number"""

        # 设置实例变量 total_sampling_steps 为传入的计划的总采样步数
        self.total_sampling_steps = total_sampling_steps
        """Total number of sampling steps planned"""

        # 设置实例变量 inner_model 为传入的用于去噪的内部模型引用
        self.inner_model = inner_model
        """Inner model reference used for denoising"""
# 定义类 AfterCFGCallbackParams，包含 x、sampling_step 和 total_sampling_steps 三个属性
class AfterCFGCallbackParams:
    def __init__(self, x, sampling_step, total_sampling_steps):
        self.x = x
        """Latent image representation in the process of being denoised"""

        self.sampling_step = sampling_step
        """Current Sampling step number"""

        self.total_sampling_steps = total_sampling_steps
        """Total number of sampling steps planned"""


# 定义类 UiTrainTabParams，包含 txt2img_preview_params 属性
class UiTrainTabParams:
    def __init__(self, txt2img_preview_params):
        self.txt2img_preview_params = txt2img_preview_params


# 定义类 ImageGridLoopParams，包含 imgs、cols 和 rows 三个属性
class ImageGridLoopParams:
    def __init__(self, imgs, cols, rows):
        self.imgs = imgs
        self.cols = cols
        self.rows = rows


# 使用 namedtuple 定义 ScriptCallback 元组，包含 script 和 callback 两个字段
ScriptCallback = namedtuple("ScriptCallback", ["script", "callback"])
# 定义 callback_map 字典，包含各种回调函数列表
callback_map = dict(
    callbacks_app_started=[],
    callbacks_model_loaded=[],
    callbacks_ui_tabs=[],
    callbacks_ui_train_tabs=[],
    callbacks_ui_settings=[],
    callbacks_before_image_saved=[],
    callbacks_image_saved=[],
    callbacks_extra_noise=[],
    callbacks_cfg_denoiser=[],
    callbacks_cfg_denoised=[],
    callbacks_cfg_after_cfg=[],
    callbacks_before_component=[],
    callbacks_after_component=[],
    callbacks_image_grid=[],
    callbacks_infotext_pasted=[],
    callbacks_script_unloaded=[],
    callbacks_before_ui=[],
    callbacks_on_reload=[],
    callbacks_list_optimizers=[],
    callbacks_list_unets=[],
)


# 定义清空回调函数的函数 clear_callbacks
def clear_callbacks():
    # 遍历 callback_map 中的所有回调函数列表，并清空
    for callback_list in callback_map.values():
        callback_list.clear()


# 定义 app_started_callback 函数，接受 demo 和 app 两个参数
def app_started_callback(demo: Optional[Blocks], app: FastAPI):
    # 遍历 callbacks_app_started 回调函数列表中的所有回调函数
    for c in callback_map['callbacks_app_started']:
        try:
            # 调用回调函数的 callback 方法，传入 demo 和 app 参数
            c.callback(demo, app)
            # 记录启动计时器
            timer.startup_timer.record(os.path.basename(c.script))
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'app_started_callback')


# 定义 app_reload_callback 函数
def app_reload_callback():
    # 遍历回调函数映射中的重新加载回调列表
    for c in callback_map['callbacks_on_reload']:
        # 尝试执行回调函数
        try:
            c.callback()
        # 捕获可能发生的异常
        except Exception:
            # 报告异常并记录相关信息
            report_exception(c, 'callbacks_on_reload')
# 当模型加载完成时的回调函数，遍历所有注册的回调函数并执行
def model_loaded_callback(sd_model):
    for c in callback_map['callbacks_model_loaded']:
        try:
            # 调用回调函数，传入模型参数
            c.callback(sd_model)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'model_loaded_callback')


# UI 标签页回调函数，遍历所有注册的回调函数并执行
def ui_tabs_callback():
    res = []

    for c in callback_map['callbacks_ui_tabs']:
        try:
            # 调用回调函数，获取返回结果并添加到结果列表中
            res += c.callback() or []
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'ui_tabs_callback')

    return res


# UI 训练标签页回调函数，遍历所有注册的回调函数并执行
def ui_train_tabs_callback(params: UiTrainTabParams):
    for c in callback_map['callbacks_ui_train_tabs']:
        try:
            # 调用回调函数，传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'callbacks_ui_train_tabs')


# UI 设置回调函数，遍历所有注册的回调函数并执行
def ui_settings_callback():
    for c in callback_map['callbacks_ui_settings']:
        try:
            # 调用回调函数
            c.callback()
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'ui_settings_callback')


# 图像保存前回调函数，遍历所有注册的回调函数并执行
def before_image_saved_callback(params: ImageSaveParams):
    for c in callback_map['callbacks_before_image_saved']:
        try:
            # 调用回调函数，传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'before_image_saved_callback')


# 图像保存后回调函数，遍历所有注册的回调函数并执行
def image_saved_callback(params: ImageSaveParams):
    for c in callback_map['callbacks_image_saved']:
        try:
            # 调用回调函数，传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'image_saved_callback')


# 额外噪声回调函数，遍历所有注册的回调函数并执行
def extra_noise_callback(params: ExtraNoiseParams):
    for c in callback_map['callbacks_extra_noise']:
        try:
            # 调用回调函数，传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'callbacks_extra_noise')


# CFG 去噪回调函数，遍历所有注册的回调函数并执行
def cfg_denoiser_callback(params: CFGDenoiserParams):
    for c in callback_map['callbacks_cfg_denoiser']:
        try:
            # 调用回调函数，传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'cfg_denoiser_callback')


# CFG 去噪完成回调函数，遍历所有注册的回调函数并执行
def cfg_denoised_callback(params: CFGDenoisedParams):
    # 遍历回调函数映射中的'denoised'回调列表
    for c in callback_map['callbacks_cfg_denoised']:
        # 尝试调用回调函数并传入参数
        try:
            c.callback(params)
        # 捕获任何异常
        except Exception:
            # 报告异常并记录回调函数信息
            report_exception(c, 'cfg_denoised_callback')
# 定义一个函数，用于执行在 CFG 之后的回调函数
def cfg_after_cfg_callback(params: AfterCFGCallbackParams):
    # 遍历回调函数映射中的 CFG 之后的回调函数列表
    for c in callback_map['callbacks_cfg_after_cfg']:
        try:
            # 调用回调函数并传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'cfg_after_cfg_callback')


# 定义一个函数，用于执行在组件之前的回调函数
def before_component_callback(component, **kwargs):
    # 遍历回调函数映射中的组件之前的回调函数列表
    for c in callback_map['callbacks_before_component']:
        try:
            # 调用回调函数并传入组件和其他关键字参数
            c.callback(component, **kwargs)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'before_component_callback')


# 定义一个函数，用于执行在组件之后的回调函数
def after_component_callback(component, **kwargs):
    # 遍历回调函数映射中的组件之后的回调函数列表
    for c in callback_map['callbacks_after_component']:
        try:
            # 调用回调函数并传入组件和其他关键字参数
            c.callback(component, **kwargs)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'after_component_callback')


# 定义一个函数，用于执行图像网格回调函数
def image_grid_callback(params: ImageGridLoopParams):
    # 遍历回调函数映射中的图像网格回调函数列表
    for c in callback_map['callbacks_image_grid']:
        try:
            # 调用回调函数并传入参数
            c.callback(params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'image_grid')


# 定义一个函数，用于执行信息文本粘贴回调函数
def infotext_pasted_callback(infotext: str, params: dict[str, Any]):
    # 遍历回调函数映射中的信息文本粘贴回调函数列表
    for c in callback_map['callbacks_infotext_pasted']:
        try:
            # 调用回调函数并传入信息文本和参数
            c.callback(infotext, params)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'infotext_pasted')


# 定义一个函数，用于执行脚本卸载回调函数
def script_unloaded_callback():
    # 遍历回调函数映射中的脚本卸载回调函数列表（倒序）
    for c in reversed(callback_map['callbacks_script_unloaded']):
        try:
            # 调用回调函数
            c.callback()
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'script_unloaded')


# 定义一个函数，用于执行 UI 之前的回调函数
def before_ui_callback():
    # 遍历回调函数映射中的 UI 之前的回调函数列表（倒序）
    for c in reversed(callback_map['callbacks_before_ui']):
        try:
            # 调用回调函数
            c.callback()
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'before_ui')


# 定义一个函数，用于执行列出优化器的回调函数
def list_optimizers_callback():
    # 初始化结果列表
    res = []

    # 遍历回调函数映射中的列出优化器的回调函数列表
    for c in callback_map['callbacks_list_optimizers']:
        try:
            # 调用回调函数并传入结果列表
            c.callback(res)
        except Exception:
            # 捕获异常并报告
            report_exception(c, 'list_optimizers')

    # 返回结果列表
    return res


# 定义一个函数，用于执行列出 U-Net 的回调函数
def list_unets_callback():
    # 初始化结果列表
    res = []
    # 遍历回调映射中的'unets'回调列表
    for c in callback_map['callbacks_list_unets']:
        # 尝试调用回调函数并传入参数res
        try:
            c.callback(res)
        # 捕获任何异常并处理
        except Exception:
            # 报告异常并指定异常类型为'list_unets'
            report_exception(c, 'list_unets')

    # 返回结果res
    return res
# 将回调函数添加到回调函数列表中
def add_callback(callbacks, fun):
    # 获取调用栈信息，排除当前文件
    stack = [x for x in inspect.stack() if x.filename != __file__]
    # 获取调用函数所在的文件名
    filename = stack[0].filename if stack else 'unknown file'

    # 创建 ScriptCallback 对象并添加到回调函数列表中
    callbacks.append(ScriptCallback(filename, fun))


# 移除当前脚本的回调函数
def remove_current_script_callbacks():
    # 获取调用栈信息，排除当前文件
    stack = [x for x in inspect.stack() if x.filename != __file__]
    # 获取调用函数所在的文件名
    filename = stack[0].filename if stack else 'unknown file'
    # 如果文件名为未知，则直接返回
    if filename == 'unknown file':
        return
    # 遍历回调函数映射中的值
    for callback_list in callback_map.values():
        # 遍历需要移除的回调函数列表
        for callback_to_remove in [cb for cb in callback_list if cb.script == filename]:
            # 移除回调函数
            callback_list.remove(callback_to_remove)


# 移除特定回调函数
def remove_callbacks_for_function(callback_func):
    # 遍历回调函数映射中的值
    for callback_list in callback_map.values():
        # 遍历需要移除的回调函数列表
        for callback_to_remove in [cb for cb in callback_list if cb.callback == callback_func]:
            # 移除回调函数
            callback_list.remove(callback_to_remove)


# 注册在应用启动时调用的函数
def on_app_started(callback):
    """register a function to be called when the webui started, the gradio `Block` component and
    fastapi `FastAPI` object are passed as the arguments"""
    # 将回调函数添加到应用启动回调函数列表中
    add_callback(callback_map['callbacks_app_started'], callback)


# 注册在重新加载服务器之前调用的函数
def on_before_reload(callback):
    """register a function to be called just before the server reloads."""
    # 将回调函数添加到重新加载回调函数列表中
    add_callback(callback_map['callbacks_on_reload'], callback)


# 注册在模型加载时调用的函数
def on_model_loaded(callback):
    """register a function to be called when the stable diffusion model is created; the model is
    passed as an argument; this function is also called when the script is reloaded. """
    # 将回调函数添加到模型加载回调函数列表中
    add_callback(callback_map['callbacks_model_loaded'], callback)


# 注册在 UI 创建新选项卡时调用的函数
def on_ui_tabs(callback):
    """register a function to be called when the UI is creating new tabs.
    The function must either return a None, which means no new tabs to be added, or a list, where
    each element is a tuple:
        (gradio_component, title, elem_id)

    gradio_component is a gradio component to be used for contents of the tab (usually gr.Blocks)"""
    # 将回调函数添加到 UI 选项卡回调函数列表中
    add_callback(callback_map['callbacks_ui_tabs'], callback)
    # title 是在用户界面中显示给用户的选项卡文本
    # elem_id 是选项卡的 HTML id
    """
    # 将回调函数添加到回调映射中的 'callbacks_ui_tabs' 键对应的回调列表中
    add_callback(callback_map['callbacks_ui_tabs'], callback)
# 注册一个函数，当 UI 创建新的训练选项卡时调用。使用 gr.Tab 创建新选项卡。
def on_ui_train_tabs(callback):
    add_callback(callback_map['callbacks_ui_train_tabs'], callback)

# 注册一个函数，在填充 UI 设置之前调用；通过使用 shared.opts.add_option(shared.OptionInfo(...)) 添加您的设置。
def on_ui_settings(callback):
    add_callback(callback_map['callbacks_ui_settings'], callback)

# 注册一个函数，在图像保存到文件之前调用。回调函数带有一个参数：
# - params: ImageSaveParams - 图像保存参数。您可以更改此对象中的字段。
def on_before_image_saved(callback):
    add_callback(callback_map['callbacks_before_image_saved'], callback)

# 注册一个函数，在图像保存到文件后调用。回调函数带有一个参数：
# - params: ImageSaveParams - 图像保存参数。更改此对象中的字段不起作用。
def on_image_saved(callback):
    add_callback(callback_map['callbacks_image_saved'], callback)

# 注册一个函数，在 img2img 或 hires fix 中添加额外噪音之前调用。
# 回调函数带有一个参数：
# - params: ExtraNoiseParams - 包含由种子和图像的潜在表示确定的噪音
def on_extra_noise(callback):
    add_callback(callback_map['callbacks_extra_noise'], callback)

# 注册一个函数，在 kdiffusion cfg_denoiser 方法中构建内部模型输入后调用。
# 回调函数带有一个参数：
# - params: CFGDenoiserParams - 传递给内部模型和采样状态详细信息的参数。
def on_cfg_denoiser(callback):
    add_callback(callback_map['callbacks_cfg_denoiser'], callback)

# 注册一个函数，在 cfg_denoiser 方法中调用，用于构建内部模型输入后调用。
# 回调函数带有一个参数：
# - params: CFGDenoiserParams - 传递给内部模型和采样状态详细信息的参数。
def on_cfg_denoised(callback):
    """
    在 kdiffusion cfg_denoiser 方法中注册一个函数，该函数在构建内部模型输入后被调用。
    回调函数接收一个参数：
        - params: CFGDenoisedParams - 传递给内部模型和采样状态详细信息的参数。
    """
    # 将回调函数添加到回调函数映射中的 callbacks_cfg_denoised 键对应的列表中
    add_callback(callback_map['callbacks_cfg_denoised'], callback)
# 注册一个函数，在 kdiffussion cfg_denoiser 方法中的 cfg 计算完成后被调用。
# 回调函数被调用时带有一个参数:
#     - params: AfterCFGCallbackParams - 传递给脚本用于 cfg 计算后处理的参数。
def on_cfg_after_cfg(callback):
    add_callback(callback_map['callbacks_cfg_after_cfg'], callback)


# 注册一个函数，在创建组件之前被调用。
# 回调函数带有以下参数:
#     - component - 即将创建的 gradio 组件。
#     - **kwargs - 传递给 gradio.components.IOComponent.__init__ 函数的参数
# 使用 kwargs 的 elem_id/label 字段来确定是哪个组件。
# 这对于在普通 UI 中间注入自定义组件非常有用。
def on_before_component(callback):
    add_callback(callback_map['callbacks_before_component'], callback)


# 注册一个函数，在创建组件之后被调用。参见 on_before_component 了解更多信息。
def on_after_component(callback):
    add_callback(callback_map['callbacks_after_component'], callback)


# 注册一个函数，在制作图像网格之前被调用。
# 回调函数带有一个参数:
#     - params: ImageGridLoopParams - 用于网格创建的参数。可以被修改。
def on_image_grid(callback):
    add_callback(callback_map['callbacks_image_grid'], callback)


# 注册一个函数，在应用 infotext 之前被调用。
# 回调函数带有两个参数:
#     - infotext: str - 原始 infotext。
#     - result: dict[str, any] - 解析后的 infotext 参数。
def on_infotext_pasted(callback):
    add_callback(callback_map['callbacks_infotext_pasted'], callback)


# 注册一个函数，在脚本卸载之前被调用。任何脚本进行的钩子/劫持/修改都应该在这里被还原。
def on_script_unloaded(callback):
    add_callback(callback_map['callbacks_script_unloaded'], callback)
    # 调用回调函数，传入回调函数映射中 'callbacks_script_unloaded' 对应的回调函数
    add_callback(callback_map['callbacks_script_unloaded'], callback)
# 注册一个函数，在创建 UI 之前调用
def on_before_ui(callback):
    # 调用 add_callback 函数，将回调函数添加到 callbacks_before_ui 列表中
    add_callback(callback_map['callbacks_before_ui'], callback)


# 注册一个函数，在 UI 制作交叉注意力优化选项列表时调用
# 该函数将被调用并传入一个参数，一个列表，应该向其中添加 modules.sd_hijack_optimizations.SdOptimization 类型的对象
def on_list_optimizers(callback):
    # 调用 add_callback 函数，将回调函数添加到 callbacks_list_optimizers 列表中
    add_callback(callback_map['callbacks_list_optimizers'], callback)


# 注册一个函数，在 UI 制作 unet 的替代选项列表时调用
# 该函数将被调用并传入一个参数，一个列表，应该向其中添加 modules.sd_unet.SdUnetOption 类型的对象
def on_list_unets(callback):
    # 调用 add_callback 函数，将回调函数添加到 callbacks_list_unets 列表中
    add_callback(callback_map['callbacks_list_unets'], callback)
```