# `.\numpy\.spin\cmds.py`

```
# å¯¼å…¥å¿…è¦çš„åº“
import os  # å¯¼å…¥æ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—
import shutil  # å¯¼å…¥é«˜çº§æ–‡ä»¶æ“ä½œæ¨¡å—
import pathlib  # å¯¼å…¥æ“ä½œè·¯å¾„çš„æ¨¡å—
import shutil  # å†æ¬¡å¯¼å…¥é«˜çº§æ–‡ä»¶æ“ä½œæ¨¡å—ï¼Œå®é™…ä¸Šä¸éœ€è¦å¤šæ¬¡å¯¼å…¥åŒä¸€ä¸ªæ¨¡å—
import pathlib  # å†æ¬¡å¯¼å…¥æ“ä½œè·¯å¾„çš„æ¨¡å—ï¼Œå®é™…ä¸Šä¸éœ€è¦å¤šæ¬¡å¯¼å…¥åŒä¸€ä¸ªæ¨¡å—
import importlib  # å¯¼å…¥å¯¼å…¥æ¨¡å—çš„åº“
import subprocess  # å¯¼å…¥å­è¿›ç¨‹ç®¡ç†æ¨¡å—

import click  # å¯¼å…¥å‘½ä»¤è¡Œè§£ææ¨¡å—click
from spin import util  # ä»spinåŒ…ä¸­å¯¼å…¥utilæ¨¡å—
from spin.cmds import meson  # ä»spin.cmdsåŒ…ä¸­å¯¼å…¥mesonæ¨¡å—

# æ£€æŸ¥meson gitå­æ¨¡å—æ˜¯å¦å­˜åœ¨
curdir = pathlib.Path(__file__).parent  # è·å–å½“å‰æ–‡ä»¶çš„çˆ¶ç›®å½•è·¯å¾„
meson_import_dir = curdir.parent / 'vendored-meson' / 'meson' / 'mesonbuild'  # æ„é€ mesonå­æ¨¡å—çš„è·¯å¾„
if not meson_import_dir.exists():  # å¦‚æœmesonå­æ¨¡å—è·¯å¾„ä¸å­˜åœ¨
    raise RuntimeError(  # æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯
        'The `vendored-meson/meson` git submodule does not exist! ' +  # é”™è¯¯ä¿¡æ¯
        'Run `git submodule update --init` to fix this problem.'  # æç¤ºç”¨æˆ·ä¿®å¤çš„å»ºè®®
    )


def _get_numpy_tools(filename):
    """åŠ è½½å¹¶è¿”å›æŒ‡å®šæ–‡ä»¶ä¸­çš„å·¥å…·æ¨¡å—"""
    filepath = pathlib.Path('tools', filename)  # åˆ›å»ºæ–‡ä»¶è·¯å¾„å¯¹è±¡
    spec = importlib.util.spec_from_file_location(filename.stem, filepath)  # æ ¹æ®æ–‡ä»¶è·¯å¾„è·å–æ¨¡å—çš„è§„èŒƒ
    module = importlib.util.module_from_spec(spec)  # æ ¹æ®è§„èŒƒåˆ›å»ºæ¨¡å—å¯¹è±¡
    spec.loader.exec_module(module)  # æ‰§è¡Œæ¨¡å—åŠ è½½
    return module  # è¿”å›åŠ è½½çš„æ¨¡å—å¯¹è±¡


@click.command()
@click.argument(
    "token",
    required=True
)
@click.argument(
    "revision-range",
    required=True
)
@click.pass_context
def changelog(ctx, token, revision_range):
    """ğŸ‘© è·å–æä¾›çš„ç‰ˆæœ¬èŒƒå›´çš„å˜æ›´æ—¥å¿—

    ç¤ºä¾‹ï¼š

    $ spin authors -t $GH_TOKEN --revision-range v1.25.0..v1.26.0
    """
    try:
        from github.GithubException import GithubException  # å¯¼å…¥GitHubå¼‚å¸¸å¤„ç†ç±»
        from git.exc import GitError  # å¯¼å…¥Gitå¼‚å¸¸å¤„ç†ç±»
        changelog = _get_numpy_tools(pathlib.Path('changelog.py'))  # åŠ è½½å¹¶è·å–changelog.pyä¸­çš„å·¥å…·æ¨¡å—
    except ModuleNotFoundError as e:
        raise click.ClickException(
            f"{e.msg}. Install the missing packages to use this command."
        )  # å¦‚æœæ¨¡å—æœªæ‰¾åˆ°ï¼ŒæŠ›å‡ºClickå¼‚å¸¸å¹¶æç¤ºå®‰è£…ç¼ºå¤±çš„åŒ…
    click.secho(
        f"Generating change log for range {revision_range}",
        bold=True, fg="bright_green",  # è¾“å‡ºæ¶ˆæ¯åˆ°æ§åˆ¶å°ï¼Œä½¿ç”¨æ˜äº®ç»¿è‰²åŠ ç²—æ˜¾ç¤º
    )
    try:
        changelog.main(token, revision_range)  # è°ƒç”¨åŠ è½½çš„changelogæ¨¡å—çš„mainå‡½æ•°ç”Ÿæˆå˜æ›´æ—¥å¿—
    except GithubException as e:
        raise click.ClickException(
            f"GithubException raised with status: {e.status} "
            f"and message: {e.data['message']}"
        )  # å¤„ç†GitHubå¼‚å¸¸å¹¶æŠ›å‡ºClickå¼‚å¸¸
    except GitError as e:
        raise click.ClickException(
            f"Git error in command `{' '.join(e.command)}` "
            f"with error message: {e.stderr}"
        )  # å¤„ç†Gitå¼‚å¸¸å¹¶æŠ›å‡ºClickå¼‚å¸¸


@click.command()
@click.option(
    "-j", "--jobs",
    help="Number of parallel tasks to launch",
    type=int
)
@click.option(
    "--clean", is_flag=True,
    help="Clean build directory before build"
)
@click.option(
    "-v", "--verbose", is_flag=True,
    help="Print all build output, even installation"
)
@click.option(
    "--with-scipy-openblas", type=click.Choice(["32", "64"]),
    default=None,
    help="Build with pre-installed scipy-openblas32 or scipy-openblas64 wheel"
)
@click.argument("meson_args", nargs=-1)
@click.pass_context
def build(ctx, meson_args, with_scipy_openblas, jobs=None, clean=False, verbose=False, quiet=False, *args, **kwargs):
    """ğŸ”§ ä½¿ç”¨Meson/ninjaæ„å»ºå¹¶å®‰è£…è½¯ä»¶åŒ…

    MESON_ARGSå°†ä¼šä¼ é€’å¦‚ä¸‹ï¼Œä¾‹å¦‚ï¼š

    spin build -- -Dpkg_config_path=/lib64/pkgconfig

    è½¯ä»¶åŒ…å°†å®‰è£…åˆ°build-installç›®å½•

    é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºå‘å¸ƒç‰ˆæœ¬æ„å»ºï¼Œä¸ºäº†èƒ½å¤Ÿä½¿ç”¨è°ƒè¯•å™¨ï¼Œéœ€è¦é€‚å½“è®¾ç½®CFLAGS
    ä¾‹å¦‚ï¼Œåœ¨Linuxä¸Šä½¿ç”¨
    """
    CFLAGS="-O0 -g" spin build
    """
    # è®¾å®šç¼–è¯‘é€‰é¡¹ CFLAGS ä¸º "-O0 -g" å¹¶æ‰§è¡Œ spin æ„å»ºå‘½ä»¤
    # XXX ä¿æŒä¸ä¸Šæ¸¸æ„å»ºçš„åŒæ­¥
    å¦‚æœè®¾ç½®äº† with_scipy_openblas å‚æ•°:
        ä½¿ç”¨ _config_openblas å‡½æ•°é…ç½® OpenBLAS
    ä»å‚æ•°å­—å…¸ ctx.params ä¸­ç§»é™¤ "with_scipy_openblas" é”®ï¼Œå¦‚æœå­˜åœ¨çš„è¯
    å°†æ§åˆ¶æµè½¬å‘ç»™ meson.build å‡½æ•°è¿›è¡Œåç»­æ„å»ºå¤„ç†
@click.command()
@click.argument("pytest_args", nargs=-1)
@click.option(
    "-m",
    "markexpr",
    metavar='MARKEXPR',
    default="not slow",
    help="Run tests with the given markers"
)
@click.option(
    "-j",
    "n_jobs",
    metavar='N_JOBS',
    default="1",
    help=("Number of parallel jobs for testing. "
          "Can be set to `auto` to use all cores.")
)
@click.option(
    "--tests", "-t",
    metavar='TESTS',
    help=("""
Which tests to run. Can be a module, function, class, or method:

 \b
 numpy.random
 numpy.random.tests.test_generator_mt19937
 numpy.random.tests.test_generator_mt19937::TestMultivariateHypergeometric
 numpy.random.tests.test_generator_mt19937::TestMultivariateHypergeometric::test_edge_cases
 \b
""")
)
@click.option(
    '--verbose', '-v', is_flag=True, default=False
)
@click.pass_context
def docs(ctx, sphinx_target, clean, first_build, jobs, *args, **kwargs):
    """ğŸ“– Build Sphinx documentation

    By default, SPHINXOPTS="-W", raising errors on warnings.
    To build without raising on warnings:

      SPHINXOPTS="" spin docs

    To list all Sphinx targets:

      spin docs targets

    To build another Sphinx target:

      spin docs TARGET

    E.g., to build a zipfile of the html docs for distribution:

      spin docs dist

    """
    meson.docs.ignore_unknown_options = True  # è®¾ç½®å¿½ç•¥æœªçŸ¥é€‰é¡¹ä¸ºçœŸ

    # See https://github.com/scientific-python/spin/pull/199
    # Can be changed when spin updates to 0.11, and moved to pyproject.toml
    if clean:
        clean_dirs = [  # æ¸…ç†ç›®å½•åˆ—è¡¨
            './doc/build/',
            './doc/source/reference/generated',
            './doc/source/reference/random/bit_generators/generated',
            './doc/source/reference/random/generated',
        ]

        for target_dir in clean_dirs:
            if os.path.isdir(target_dir):
                print(f"Removing {target_dir!r}")  # æ‰“å°è¦ç§»é™¤çš„ç›®å½•
                shutil.rmtree(target_dir)  # é€’å½’åœ°ç§»é™¤ç›®å½•åŠå…¶å†…å®¹

    # Run towncrier without staging anything for commit. This is the way to get
    # release notes snippets included in a local doc build.
    cmd = ['towncrier', 'build', '--version', '2.x.y', '--keep', '--draft']
    p = subprocess.run(cmd, check=True, capture_output=True, text=True)
    outfile = curdir.parent / 'doc' / 'source' / 'release' / 'notes-towncrier.rst'
    with open(outfile, 'w') as f:
        f.write(p.stdout)  # å°†towncrierçš„è¾“å‡ºå†™å…¥release notesæ–‡ä»¶

    ctx.forward(meson.docs)  # è½¬å‘ç»™meson.docså‘½ä»¤
# å®šä¹‰åä¸º `test` çš„å‡½æ•°ï¼Œç”¨äºè¿è¡Œæµ‹è¯•
def test(ctx, pytest_args, markexpr, n_jobs, tests, verbose, *args, **kwargs):
    """ğŸ”§ Run tests

    PYTEST_ARGS are passed through directly to pytest, e.g.:

      spin test -- --pdb

    To run tests on a directory or file:

     \b
     spin test numpy/linalg
     spin test numpy/linalg/tests/test_linalg.py

    To report the durations of the N slowest tests:

      spin test -- --durations=N

    To run tests that match a given pattern:

     \b
     spin test -- -k "geometric"
     spin test -- -k "geometric and not rgeometric"

    By default, spin will run `-m 'not slow'`. To run the full test suite, use
    `spin -m full`

    For more, see `pytest --help`.
    """  # noqa: E501
    
    # å¦‚æœæœªæä¾› pytest_args å’Œ tests å‚æ•°ï¼Œåˆ™è®¾ç½®é»˜è®¤å€¼ ('numpy',)
    if (not pytest_args) and (not tests):
        pytest_args = ('numpy',)

    # å¦‚æœ pytest_args ä¸­ä¸åŒ…å« '-m' å‚æ•°ï¼Œå¹¶ä¸” markexpr ä¸æ˜¯ "full"ï¼Œåˆ™å°† markexpr æ·»åŠ åˆ° pytest_args å‰é¢
    if '-m' not in pytest_args:
        if markexpr != "full":
            pytest_args = ('-m', markexpr) + pytest_args

    # å¦‚æœ n_jobs ä¸ä¸º "1" å¹¶ä¸” pytest_args ä¸­ä¸åŒ…å« '-n' å‚æ•°ï¼Œåˆ™å°† n_jobs æ·»åŠ åˆ° pytest_args å‰é¢
    if (n_jobs != "1") and ('-n' not in pytest_args):
        pytest_args = ('-n', str(n_jobs)) + pytest_args

    # å¦‚æœæä¾›äº† tests å‚æ•°ï¼Œå¹¶ä¸” pytest_args ä¸­ä¸åŒ…å« '--pyargs' å‚æ•°ï¼Œåˆ™å°† tests æ·»åŠ åˆ° pytest_args å‰é¢
    if tests and not ('--pyargs' in pytest_args):
        pytest_args = ('--pyargs', tests) + pytest_args

    # å¦‚æœ verbose ä¸º Trueï¼Œåˆ™å°† '-v' å‚æ•°æ·»åŠ åˆ° pytest_args å‰é¢
    if verbose:
        pytest_args = ('-v',) + pytest_args

    # å°†æ›´æ–°åçš„ pytest_args å­˜å‚¨åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡çš„ 'pytest_args' é”®ä¸­
    ctx.params['pytest_args'] = pytest_args

    # åˆ é™¤ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çš„ 'markexpr', 'n_jobs', 'tests', 'verbose' å‚æ•°
    for extra_param in ('markexpr', 'n_jobs', 'tests', 'verbose'):
        del ctx.params[extra_param]
    
    # å°†æ§åˆ¶æµè½¬å‘åˆ° meson.test å‘½ä»¤
    ctx.forward(meson.test)


# åˆ›å»ºä¸€ä¸ªå‘½ä»¤è¡Œæ¥å£çš„å‘½ä»¤ï¼Œç”¨äºè¿è¡Œ doctests
@click.command()
@click.argument("pytest_args", nargs=-1)
@click.option(
    "-j",
    "n_jobs",
    metavar='N_JOBS',
    default="1",
    help=("Number of parallel jobs for testing. "
          "Can be set to `auto` to use all cores.")
)
@click.option(
    '--verbose', '-v', is_flag=True, default=False
)
@click.pass_context
def check_docs(ctx, pytest_args, n_jobs, verbose, *args, **kwargs):
    """ğŸ”§ Run doctests of objects in the public API.

    PYTEST_ARGS are passed through directly to pytest, e.g.:

      spin check-docs -- --pdb

    To run tests on a directory:

     \b
     spin check-docs numpy/linalg

    To report the durations of the N slowest doctests:

      spin check-docs -- --durations=N

    To run doctests that match a given pattern:

     \b
     spin check-docs -- -k "slogdet"
     spin check-docs numpy/linalg -- -k "det and not slogdet"

    \b
    Note:
    -----

    \b
     - This command only runs doctests and skips everything under tests/
     - This command only doctests public objects: those which are accessible
       from the top-level `__init__.py` file.

    """  # noqa: E501
    
    try:
        # é˜²æ­¢ä¹‹åå‡ºç°æ¨¡å—æœªæ‰¾åˆ°çš„å¼‚å¸¸
        import scipy_doctest
    except ModuleNotFoundError as e:
        raise ModuleNotFoundError("scipy-doctest not installed") from e

    # å¦‚æœæœªæä¾› pytest_args å‚æ•°ï¼Œåˆ™è®¾ç½®é»˜è®¤å€¼ ('numpy',)
    if (not pytest_args):
        pytest_args = ('numpy',)

    # å¦‚æœ n_jobs ä¸ä¸º "1" å¹¶ä¸” pytest_args ä¸­ä¸åŒ…å« '-n' å‚æ•°ï¼Œåˆ™å°† n_jobs æ·»åŠ åˆ° pytest_args å‰é¢
    if (n_jobs != "1") and ('-n' not in pytest_args):
        pytest_args = ('-n', str(n_jobs)) + pytest_args

    # å¦‚æœ verbose ä¸º Trueï¼Œåˆ™å°† '-v' å‚æ•°æ·»åŠ åˆ° pytest_args å‰é¢
    if verbose:
        pytest_args = ('-v',) + pytest_args

    # æ­¤å¤„åº”ç»§ç»­å®Œæˆåç»­çš„ doctesting è®¾ç½®ï¼Œä½†ä»£ç è¢«çœç•¥äº†

    # turn doctesting on:
    # æ­¤å¤„åº”ç»§ç»­å®Œæˆåç»­çš„ doctesting è®¾ç½®ï¼Œä½†ä»£ç è¢«çœç•¥äº†
    # å®šä¹‰åŒ…å« doctest çš„å‚æ•°å…ƒç»„ï¼Œç”¨äº pytest çš„é…ç½®
    doctest_args = (
        '--doctest-modules',   # å¯ç”¨å¯¹æ¨¡å—ä¸­æ–‡æ¡£æµ‹è¯•çš„æ”¯æŒ
        '--doctest-collect=api'  # æŒ‡å®šä»…æ”¶é›†åç§°åŒ…å« 'api' çš„æ–‡æ¡£æµ‹è¯•
    )
    
    # å°† doctest_args æ·»åŠ åˆ° pytest_args ä¸­ï¼Œæ‰©å±• pytest çš„å‚æ•°åˆ—è¡¨
    pytest_args = pytest_args + doctest_args
    
    # å°† pytest_args èµ‹å€¼ç»™ä¸Šä¸‹æ–‡å¯¹è±¡ ctx çš„ 'pytest_args' é”®
    ctx.params['pytest_args'] = pytest_args
    
    # å¾ªç¯å¤„ç†é¢å¤–å‚æ•°åˆ—è¡¨ ('n_jobs', 'verbose')ï¼Œä» ctx.params ä¸­åˆ é™¤è¿™äº›å‚æ•°
    for extra_param in ('n_jobs', 'verbose'):
        del ctx.params[extra_param]
    
    # ä½¿ç”¨ ctx.forward è°ƒç”¨ meson.test å‘½ä»¤ï¼Œå°†æ§åˆ¶æƒè½¬å‘ç»™è¯¥å‘½ä»¤æ‰§è¡Œ
    ctx.forward(meson.test)
# å®šä¹‰å‡½æ•°_set_mem_rlimitï¼Œç”¨äºè®¾ç½®åœ°å€ç©ºé—´çš„èµ„æºé™åˆ¶
def _set_mem_rlimit(max_mem=None):
    # å¯¼å…¥èµ„æºç®¡ç†æ¨¡å—å’Œè¿›ç¨‹ç®¡ç†æ¨¡å—
    import resource
    import psutil

    # è·å–ç³»ç»Ÿè™šæ‹Ÿå†…å­˜ä¿¡æ¯
    mem = psutil.virtual_memory()

    # å¦‚æœæœªæŒ‡å®šæœ€å¤§å†…å­˜é™åˆ¶ï¼Œåˆ™å°†å…¶è®¾å®šä¸ºç³»ç»Ÿæ€»å†…å­˜çš„70%
    if max_mem is None:
        max_mem = int(mem.total * 0.7)

    # è·å–å½“å‰åœ°å€ç©ºé—´é™åˆ¶
    cur_limit = resource.getrlimit(resource.RLIMIT_AS)
    
    # å¦‚æœå½“å‰é™åˆ¶å¤§äº0ï¼Œåˆ™å°†æœ€å¤§å†…å­˜é™åˆ¶è®¾ä¸ºå½“å‰é™åˆ¶å’ŒæŒ‡å®šé™åˆ¶ä¸­è¾ƒå°çš„ä¸€ä¸ª
    if cur_limit[0] > 0:
        max_mem = min(max_mem, cur_limit[0])

    # å°è¯•è®¾ç½®åœ°å€ç©ºé—´é™åˆ¶ä¸ºæŒ‡å®šçš„æœ€å¤§å†…å­˜å’Œå½“å‰é™åˆ¶çš„æœ€å¤§å€¼
    try:
        resource.setrlimit(resource.RLIMIT_AS, (max_mem, cur_limit[1]))
    except ValueError:
        # åœ¨ macOS ä¸Šå¯èƒ½ä¼šå‡ºç°å¼‚å¸¸ï¼šå½“å‰é™åˆ¶è¶…è¿‡æœ€å¤§é™åˆ¶
        pass


# å®šä¹‰å‡½æ•°_commit_to_shaï¼Œç”¨äºè·å–ç»™å®šæäº¤çš„ SHA å€¼
def _commit_to_sha(commit):
    # è¿è¡Œ git å‘½ä»¤è·å–æŒ‡å®šæäº¤çš„ SHA å€¼
    p = util.run(['git', 'rev-parse', commit], output=False, echo=False)
    
    # å¦‚æœå‘½ä»¤æ‰§è¡Œè¿”å›å€¼ä¸ä¸º0ï¼ŒæŠ›å‡ºå¼‚å¸¸
    if p.returncode != 0:
        raise click.ClickException(
            f'Could not find SHA matching commit `{commit}`'
        )

    # è¿”å›å‘½ä»¤è¾“å‡ºçš„ SHA å€¼ï¼Œå¹¶è½¬æ¢ä¸º ASCII ç¼–ç çš„å­—ç¬¦ä¸²
    return p.stdout.decode('ascii').strip()


# å®šä¹‰å‡½æ•°_dirty_git_working_dirï¼Œç”¨äºæ£€æŸ¥å½“å‰ Git å·¥ä½œç›®å½•æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
def _dirty_git_working_dir():
    # æ£€æŸ¥å·¥ä½œç›®å½•ä¸­æ˜¯å¦æœ‰å˜æ›´çš„æ–‡ä»¶
    p0 = util.run(['git', 'diff-files', '--quiet'])
    
    # æ£€æŸ¥æš‚å­˜åŒºä¸­æ˜¯å¦æœ‰å·²ç»æš‚å­˜ä½†æœªæäº¤çš„æ›´æ”¹
    p1 = util.run(['git', 'diff-index', '--quiet', '--cached', 'HEAD'])

    # å¦‚æœå·¥ä½œç›®å½•æˆ–æš‚å­˜åŒºæœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œåˆ™è¿”å› Trueï¼Œå¦åˆ™è¿”å› False
    return (p0.returncode != 0 or p1.returncode != 0)


# å®šä¹‰å‡½æ•°_run_asvï¼Œç”¨äºæ‰§è¡Œç»™å®šçš„ ASV å‘½ä»¤
def _run_asv(cmd):
    # è·å–å½“å‰ç¯å¢ƒçš„ PATH å˜é‡
    PATH = os.environ['PATH']
    
    # æŒ‡å®šé¢å¤–çš„è·¯å¾„åˆ—è¡¨ï¼Œç”¨äºåŒ…å« CCache å’Œ F90Cache çš„è·¯å¾„
    EXTRA_PATH = os.pathsep.join([
        '/usr/lib/ccache', '/usr/lib/f90cache',
        '/usr/local/lib/ccache', '/usr/local/lib/f90cache'
    ])
    
    # æ›´æ–°ç¯å¢ƒå˜é‡çš„ PATHï¼Œæ·»åŠ é¢å¤–çš„è·¯å¾„
    env = os.environ
    env['PATH'] = f'{EXTRA_PATH}{os.pathsep}{PATH}'

    # æ§åˆ¶ BLAS/LAPACK çº¿ç¨‹æ•°ï¼Œè®¾ç½®ä¸º 1
    env['OPENBLAS_NUM_THREADS'] = '1'
    env['MKL_NUM_THREADS'] = '1'

    # å°è¯•é™åˆ¶å†…å­˜ä½¿ç”¨ï¼Œå¦‚æœå¤±è´¥åˆ™å¿½ç•¥å¼‚å¸¸ï¼ˆImportError æˆ– RuntimeErrorï¼‰
    try:
        _set_mem_rlimit()
    except (ImportError, RuntimeError):
        pass

    # åœ¨ benchmarks ç›®å½•ä¸‹æ‰§è¡Œç»™å®šçš„å‘½ä»¤ï¼Œä½¿ç”¨æ›´æ–°åçš„ç¯å¢ƒå˜é‡
    util.run(cmd, cwd='benchmarks', env=env)


# å®šä¹‰ lint å‘½ä»¤ï¼Œç”¨äºè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥
@click.command()
@click.option(
    "-b", "--branch",
    metavar='branch',
    default="main",
)
@click.option(
    '--uncommitted',
    is_flag=True,
    default=False,
    required=False,
)
@click.pass_context
def lint(ctx, branch, uncommitted):
    """ğŸ”¦ Run lint checks on diffs.
    Provide target branch name or `uncommitted` to check changes before committing:

    \b
    Examples:

    \b
    For lint checks of your development brach with `main` or a custom branch:

    \b
    $ spin lint # defaults to main
    $ spin lint --branch custom_branch

    \b
    To check just the uncommitted changes before committing

    \b
    $ spin lint --uncommitted
    """
    try:
        # è·å– numpy å·¥å…·åŒ…ä¸­çš„ linter.py æ¨¡å—
        linter = _get_numpy_tools(pathlib.Path('linter.py'))
    except ModuleNotFoundError as e:
        # å¦‚æœæ¨¡å—æœªæ‰¾åˆ°ï¼ŒæŠ›å‡º Click å¼‚å¸¸ï¼Œå¹¶æé†’å®‰è£…ä¾èµ–
        raise click.ClickException(
            f"{e.msg}. Install using requirements/linter_requirements.txt"
        )

    # åˆ›å»º DiffLinter å®ä¾‹ï¼Œå¹¶è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥
    linter.DiffLinter(branch).run_lint(uncommitted)


# å®šä¹‰ä¸€ä¸ª lint å‘½ä»¤çš„å­å‘½ä»¤ï¼Œç”¨äºè¿è¡ŒåŸºå‡†æµ‹è¯•
@click.command()
@click.option(
    '--tests', '-t',
    default=None, metavar='TESTS', multiple=True,
    help="Which tests to run"
)
@click.option(
    '--compare', '-c',
    is_flag=True,
    default=False,
    help="Compare benchmarks between the current branch and main "
         "(unless other branches specified). "
         "The benchmarks are each executed in a new isolated "
         "environment."



# è®¾ç½®å¸®åŠ©ä¿¡æ¯å­—ç¬¦ä¸²ï¼Œç”¨äºè§£é‡Šæ¯”è¾ƒå½“å‰åˆ†æ”¯ä¸ä¸»åˆ†æ”¯ï¼ˆé™¤éæŒ‡å®šå…¶ä»–åˆ†æ”¯ï¼‰çš„åŸºå‡†æ€§èƒ½ã€‚
# æ¯ä¸ªåŸºå‡†æµ‹è¯•åœ¨ä¸€ä¸ªæ–°çš„éš”ç¦»ç¯å¢ƒä¸­æ‰§è¡Œã€‚
@click.option(
    '--verbose', '-v', is_flag=True, default=False
)

# å®šä¹‰ä¸€ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ `--verbose` æˆ–è€… `-v`ï¼Œæ˜¯ä¸€ä¸ªå¸ƒå°”æ ‡å¿—ï¼Œé»˜è®¤ä¸º Falseï¼Œç”¨äºæ§åˆ¶è¯¦ç»†è¾“å‡ºæ¨¡å¼


@click.option(
    '--quick', '-q', is_flag=True, default=False,
    help="Run each benchmark only once (timings won't be accurate)"
)

# å®šä¹‰ä¸€ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ `--quick` æˆ–è€… `-q`ï¼Œæ˜¯ä¸€ä¸ªå¸ƒå°”æ ‡å¿—ï¼Œé»˜è®¤ä¸º Falseï¼Œå¸®åŠ©ä¿¡æ¯è¯´æ˜å¯ä»¥å¿«é€Ÿè¿è¡Œæ¯ä¸ªåŸºå‡†æµ‹è¯•ä¸€æ¬¡ï¼ˆæ—¶é—´ä¸å‡†ç¡®ï¼‰


@click.argument(
    'commits', metavar='',
    required=False,
    nargs=-1
)

# å®šä¹‰ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•° `commits`ï¼Œæ²¡æœ‰é»˜è®¤å€¼ï¼Œå¯é€‰å‚æ•°ï¼Œæ¥å—ä»»æ„æ•°é‡çš„å‚æ•°å€¼ï¼Œç”¨äºæŒ‡å®šè¦æ¯”è¾ƒçš„æäº¤æˆ–åˆ†æ”¯


@click.pass_context

# å£°æ˜ä¸€ä¸ª Click ä¸Šä¸‹æ–‡å¯¹è±¡çš„è£…é¥°å™¨ï¼Œå…è®¸åœ¨å‘½ä»¤å‡½æ•°ä¸­è®¿é—®å’Œæ“ä½œä¸Šä¸‹æ–‡å¯¹è±¡ `ctx`


def bench(ctx, tests, compare, verbose, quick, commits):

# å®šä¹‰ä¸€ä¸ªå‘½ä»¤è¡Œå‘½ä»¤ `bench`ï¼Œæ¥æ”¶å¤šä¸ªå‚æ•°ï¼š`tests`ï¼ˆè¦è¿è¡Œçš„åŸºå‡†æµ‹è¯•åˆ—è¡¨ï¼‰ã€`compare`ï¼ˆæ˜¯å¦è¿›è¡Œæ¯”è¾ƒæ¨¡å¼ï¼‰ã€`verbose`ï¼ˆæ˜¯å¦è¯¦ç»†è¾“å‡ºï¼‰ã€`quick`ï¼ˆæ˜¯å¦å¿«é€Ÿæ¨¡å¼ï¼‰ã€`commits`ï¼ˆè¦æ¯”è¾ƒçš„æäº¤æˆ–åˆ†æ”¯åˆ—è¡¨ï¼‰


if not commits:
    commits = ('main', 'HEAD')
elif len(commits) == 1:
    commits = commits + ('HEAD',)
elif len(commits) > 2:
    raise click.ClickException(
        'Need a maximum of two revisions to compare'
    )

# å¦‚æœæ²¡æœ‰æŒ‡å®š `commits`ï¼Œé»˜è®¤æ¯”è¾ƒ `'main'` å’Œ `'HEAD'`ï¼›å¦‚æœåªæŒ‡å®šäº†ä¸€ä¸ªæäº¤ï¼Œåˆ™ä¸ `'HEAD'` æ¯”è¾ƒï¼›å¦‚æœæŒ‡å®šäº†è¶…è¿‡ä¸¤ä¸ªæäº¤ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚


bench_args = []
for t in tests:
    bench_args += ['--bench', t]

# æ„å»ºåŸºå‡†æµ‹è¯•å‚æ•°åˆ—è¡¨ `bench_args`ï¼Œæ¯ä¸ªæµ‹è¯•æ·»åŠ  `--bench` é€‰é¡¹ï¼Œç”¨äºæŒ‡å®šè¦è¿è¡Œçš„åŸºå‡†æµ‹è¯•


if verbose:
    bench_args = ['-v'] + bench_args

# å¦‚æœ `verbose` ä¸ºçœŸï¼Œåˆ™åœ¨ `bench_args` åˆ—è¡¨å‰æ·»åŠ  `-v` é€‰é¡¹ï¼Œè¡¨ç¤ºå¯ç”¨è¯¦ç»†è¾“å‡ºæ¨¡å¼


if quick:
    bench_args = ['--quick'] + bench_args

# å¦‚æœ `quick` ä¸ºçœŸï¼Œåˆ™åœ¨ `bench_args` åˆ—è¡¨å‰æ·»åŠ  `--quick` é€‰é¡¹ï¼Œè¡¨ç¤ºå¯ç”¨å¿«é€Ÿæ¨¡å¼


if not compare:
    # No comparison requested; we build and benchmark the current version

# å¦‚æœä¸éœ€è¦æ¯”è¾ƒæ¨¡å¼ï¼Œåˆ™æ„å»ºå’Œè¿è¡Œå½“å‰ç‰ˆæœ¬çš„åŸºå‡†æµ‹è¯•


else:
    # Ensure that we don't have uncommited changes
    commit_a, commit_b = [_commit_to_sha(c) for c in commits]

    if commit_b == 'HEAD' and _dirty_git_working_dir():
        click.secho(
            "WARNING: you have uncommitted changes --- "
            "these will NOT be benchmarked!",
            fg="red"
        )

# å¦åˆ™ï¼Œç¡®ä¿æ²¡æœ‰æœªæäº¤çš„æ›´æ”¹ï¼›å°†æäº¤æˆ–åˆ†æ”¯è½¬æ¢ä¸º SHA å€¼ï¼Œå¹¶æ£€æŸ¥å·¥ä½œç›®å½•æ˜¯å¦å¹²å‡€


@click.command(context_settings={
    'ignore_unknown_options': True
})

# å£°æ˜ä¸€ä¸ª Click å‘½ä»¤ `python`ï¼Œè®¾ç½®ä¸Šä¸‹æ–‡è®¾ç½® `ignore_unknown_options` ä¸º Trueï¼Œå…è®¸ä¼ é€’æœªçŸ¥é€‰é¡¹ç»™ Python


@click.argument("python_args", metavar='', nargs=-1)

# å®šä¹‰ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•° `python_args`ï¼Œæ²¡æœ‰é»˜è®¤å€¼ï¼Œæ¥å—ä»»æ„æ•°é‡çš„å‚æ•°å€¼ï¼Œç”¨äºä¼ é€’ç»™ Python è§£é‡Šå™¨çš„é€‰é¡¹
    # è¿è¡Œå‘½ä»¤ `spin python -c 'import sys; print(sys.path)'` æ¥è·å– Python çš„æ¨¡å—æœç´¢è·¯å¾„
    """
    # è·å–å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡
    env = os.environ
    # è®¾ç½®ç¯å¢ƒå˜é‡ä¸­çš„ 'PYTHONWARNINGS' é”®çš„å€¼ä¸º 'all'ï¼Œå¦‚æœè¯¥é”®ä¸å­˜åœ¨åˆ™è®¾ä¸º 'all'
    env['PYTHONWARNINGS'] = env.get('PYTHONWARNINGS', 'all')
    # è°ƒç”¨ ctx å¯¹è±¡çš„ forward æ–¹æ³•ï¼Œä¼ é€’å‚æ•° meson.pythonï¼Œæ‰§è¡Œç›¸å…³çš„æ“ä½œ
    ctx.forward(meson.python)
@click.command(context_settings={
    'ignore_unknown_options': True  # è®¾ç½®å‘½ä»¤ä¸Šä¸‹æ–‡ï¼Œå…è®¸å¿½ç•¥æœªçŸ¥é€‰é¡¹
})
@click.argument("ipython_args", metavar='', nargs=-1)  # å®šä¹‰å‘½ä»¤è¡Œå‚æ•° ipython_argsï¼Œæ¥å—ä»»æ„æ•°é‡å‚æ•°
@click.pass_context  # ä¼ é€’ä¸Šä¸‹æ–‡å¯¹è±¡ç»™å‡½æ•° ipython
def ipython(ctx, ipython_args):
    """ğŸ’» Launch IPython shell with PYTHONPATH set

    OPTIONS are passed through directly to IPython, e.g.:

    spin ipython -i myscript.py
    """
    env = os.environ  # è·å–å½“å‰ç¯å¢ƒå˜é‡
    env['PYTHONWARNINGS'] = env.get('PYTHONWARNINGS', 'all')  # è®¾ç½® PYTHONWARNINGS ç¯å¢ƒå˜é‡å€¼ä¸º 'all'

    ctx.invoke(build)  # è°ƒç”¨ build å‘½ä»¤

    ppath = meson._set_pythonpath()  # è®¾ç½® PYTHONPATH

    print(f'ğŸ’» Launching IPython with PYTHONPATH="{ppath}"')  # æ‰“å°å¯åŠ¨ IPython çš„ä¿¡æ¯
    preimport = (r"import numpy as np; "
                 r"print(f'\nPreimported NumPy {np.__version__} as np')")
                 # é¢„å…ˆå¯¼å…¥ numpy åº“å¹¶æ‰“å°ç‰ˆæœ¬ä¿¡æ¯
    util.run(["ipython", "--ignore-cwd",
              f"--TerminalIPythonApp.exec_lines={preimport}"] +
             list(ipython_args))  # è¿è¡Œ ipython å‘½ä»¤ï¼Œå¹¶ä¼ é€’å‚æ•° ipython_args


@click.command(context_settings={"ignore_unknown_options": True})  # è®¾ç½®å‘½ä»¤ä¸Šä¸‹æ–‡ï¼Œå…è®¸å¿½ç•¥æœªçŸ¥é€‰é¡¹
@click.pass_context  # ä¼ é€’ä¸Šä¸‹æ–‡å¯¹è±¡ç»™å‡½æ•° mypy
def mypy(ctx):
    """ğŸ¦† Run Mypy tests for NumPy
    """
    env = os.environ  # è·å–å½“å‰ç¯å¢ƒå˜é‡
    env['NPY_RUN_MYPY_IN_TESTSUITE'] = '1'  # è®¾ç½®ç¯å¢ƒå˜é‡ NPY_RUN_MYPY_IN_TESTSUITE çš„å€¼ä¸º '1'
    ctx.params['pytest_args'] = [os.path.join('numpy', 'typing')]  # è®¾ç½®å‚æ•° pytest_argsï¼ŒæŒ‡å®šç›®å½•è·¯å¾„
    ctx.params['markexpr'] = 'full'  # è®¾ç½®å‚æ•° markexpr çš„å€¼ä¸º 'full'
    ctx.forward(test)  # è½¬å‘å‘½ä»¤åˆ° test å‡½æ•°


@click.command(context_settings={
    'ignore_unknown_options': True  # è®¾ç½®å‘½ä»¤ä¸Šä¸‹æ–‡ï¼Œå…è®¸å¿½ç•¥æœªçŸ¥é€‰é¡¹
})
@click.option(
    "--with-scipy-openblas", type=click.Choice(["32", "64"]),  # å®šä¹‰é€‰é¡¹ --with-scipy-openblasï¼Œå¯é€‰å€¼ä¸º "32" æˆ– "64"
    default=None, required=True,
    help="Build with pre-installed scipy-openblas32 or scipy-openblas64 wheel"
)  # è®¾ç½®é€‰é¡¹è¯´æ˜æ–‡æ¡£
def config_openblas(with_scipy_openblas):
    """ğŸ”§ Create .openblas/scipy-openblas.pc file

    Also create _distributor_init_local.py

    Requires a pre-installed scipy-openblas64 or scipy-openblas32
    """
    _config_openblas(with_scipy_openblas)  # è°ƒç”¨å‡½æ•° _config_openblasï¼Œä¼ é€’é€‰é¡¹å€¼


def _config_openblas(blas_variant):
    import importlib  # å¯¼å…¥ importlib åº“
    basedir = os.getcwd()  # è·å–å½“å‰å·¥ä½œç›®å½•
    openblas_dir = os.path.join(basedir, ".openblas")  # åˆ›å»º .openblas ç›®å½•çš„è·¯å¾„
    pkg_config_fname = os.path.join(openblas_dir, "scipy-openblas.pc")  # åˆ›å»º pkg_config æ–‡ä»¶åè·¯å¾„
    if blas_variant:  # å¦‚æœå­˜åœ¨ blas_variant å‚æ•°
        module_name = f"scipy_openblas{blas_variant}"  # æ„å»ºæ¨¡å—å
        try:
            openblas = importlib.import_module(module_name)  # å¯¼å…¥æŒ‡å®šæ¨¡å—
        except ModuleNotFoundError:
            raise RuntimeError(f"'pip install {module_name} first")  # å¦‚æœæ¨¡å—æœªæ‰¾åˆ°ï¼Œåˆ™å¼•å‘è¿è¡Œæ—¶é”™è¯¯
        local = os.path.join(basedir, "numpy", "_distributor_init_local.py")  # åˆ›å»ºæœ¬åœ°æ–‡ä»¶è·¯å¾„
        with open(local, "wt", encoding="utf8") as fid:
            fid.write(f"import {module_name}\n")  # å†™å…¥æ–‡ä»¶å¯¼å…¥æ¨¡å—è¯­å¥
        os.makedirs(openblas_dir, exist_ok=True)  # åˆ›å»º .openblas ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨çš„è¯
        with open(pkg_config_fname, "wt", encoding="utf8") as fid:
            fid.write(
                openblas.get_pkg_config(use_preloading=True)  # è·å–å¹¶å†™å…¥ pkg_config æ–‡ä»¶å†…å®¹
            )


@click.command()  # å®šä¹‰å‘½ä»¤
@click.option(
    "-v", "--version-override",  # å®šä¹‰é€‰é¡¹ -v æˆ– --version-override
    help="NumPy version of release",  # è®¾ç½®é€‰é¡¹è¯´æ˜æ–‡æ¡£
    required=False  # é€‰é¡¹éå¿…éœ€
)
@click.pass_context  # ä¼ é€’ä¸Šä¸‹æ–‡å¯¹è±¡ç»™å‡½æ•° notes
def notes(ctx, version_override):
    """ğŸ‰ Generate release notes and validate

    \b
    Example:

    \b
    $ spin notes --version-override 2.0

    \b
    To automatically pick the version

    \b
    $ spin notes
    """
    project_config = util.get_config()  # è·å–é¡¹ç›®é…ç½®ä¿¡æ¯
    version = version_override or project_config['project.version']  # è·å–ç‰ˆæœ¬å·æˆ–ä»é…ç½®ä¸­è·å–
    # æ‰“å°æ¶ˆæ¯ï¼Œç”Ÿæˆ NumPy ç‰ˆæœ¬çš„å‘å¸ƒè¯´æ˜
    click.secho(
        f"Generating release notes for NumPy {version}",
        bold=True, fg="bright_green",
    )

    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `towncrier`
    if not shutil.which("towncrier"):
        # å¦‚æœæœªå®‰è£…ï¼ŒæŠ›å‡º Click å¼‚å¸¸
        raise click.ClickException(
            f"please install `towncrier` to use this command"
        )

    # æ‰“å°æ¶ˆæ¯ï¼Œè¯»å–å³å°†å‘å¸ƒçš„å˜æ›´ä¿¡æ¯çš„ç›®å½•è·¯å¾„
    click.secho(
        f"Reading upcoming changes from {project_config['tool.towncrier.directory']}",
        bold=True, fg="bright_yellow"
    )

    # å‡†å¤‡æ‰§è¡Œ towncrier çš„æ„å»ºå‘½ä»¤
    cmd = ["towncrier", "build", "--version", version, "--yes"]
    # è°ƒç”¨å·¥å…·å‡½æ•°æ‰§è¡Œå‘½ä»¤ï¼Œæ•è·è¾“å‡º
    p = util.run(cmd=cmd, sys_exit=False, output=True, encoding="utf-8")
    # å¦‚æœå‘½ä»¤è¿”å›éé›¶çŠ¶æ€ç ï¼ŒæŠ›å‡º Click å¼‚å¸¸
    if p.returncode != 0:
        raise click.ClickException(
            f"`towncrier` failed returned {p.returncode} with error `{p.stderr}`"
        )

    # æ„å»ºè¾“å‡ºè·¯å¾„ï¼Œç”¨äºå­˜å‚¨å‘å¸ƒè¯´æ˜
    output_path = project_config['tool.towncrier.filename'].format(version=version)
    # æ‰“å°æ¶ˆæ¯ï¼Œå‘å¸ƒè¯´æ˜æˆåŠŸå†™å…¥æŒ‡å®šè·¯å¾„
    click.secho(
        f"Release notes successfully written to {output_path}",
        bold=True, fg="bright_yellow"
    )

    # æ‰“å°æ¶ˆæ¯ï¼ŒéªŒè¯æ‰€æœ‰æ–°é—»ç‰‡æ®µçš„ä½¿ç”¨æƒ…å†µ
    click.secho(
        "Verifying consumption of all news fragments",
        bold=True, fg="bright_green",
    )

    # å°è¯•è°ƒç”¨ `_get_numpy_tools` å‡½æ•°æ¥è·å– NumPy å·¥å…·ï¼Œç”¨äºæµ‹è¯•æ‰€æœ‰æ–°é—»ç‰‡æ®µçš„ä½¿ç”¨æƒ…å†µ
    try:
        test_notes = _get_numpy_tools(pathlib.Path('ci', 'test_all_newsfragments_used.py'))
    except ModuleNotFoundError as e:
        # å¦‚æœæ¨¡å—æœªæ‰¾åˆ°ï¼ŒæŠ›å‡º Click å¼‚å¸¸ï¼Œæç¤ºå®‰è£…ç¼ºå¤±çš„åŒ…
        raise click.ClickException(
            f"{e.msg}. Install the missing packages to use this command."
        )

    # è°ƒç”¨è·å–çš„å·¥å…·å¯¹è±¡çš„ `main` æ–¹æ³•ï¼Œæ‰§è¡Œæµ‹è¯•æ‰€æœ‰æ–°é—»ç‰‡æ®µæ˜¯å¦è¢«ä½¿ç”¨
    test_notes.main()
```