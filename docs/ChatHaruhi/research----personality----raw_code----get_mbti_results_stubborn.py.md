# `.\Chat-Haruhi-Suzumiya\research\personality\raw_code\get_mbti_results_stubborn.py`

```py
# -*- coding: utf-8 -*-
"""mbti_exp.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1tqCgRc3d2rWQoic5oV3AKqU-l_PCF1aU

读取数据
"""
# 导入用于调试的pdb模块
import pdb 

# 设置输入文件名
input_name = 'mbti_questions.jsonl'

# 导入json模块
import json

# 创建一个空列表datas用于存储读取的数据
datas = []

# 打开文件input_name，并按行解析JSON数据后加入datas列表
with open(input_name, encoding='utf-8') as f:
    for line in f:
        data = json.loads(line)
        datas.append(data)

# 打印datas列表的长度
print(len(datas))

"""设置环境"""

# 导入操作系统模块os
import os
# 导入OpenAI模块
import openai

# 设置环境变量OPENAI_API_KEY为指定的密钥
os.environ["OPENAI_API_KEY"] = "sk-"

# 安装所需的Python包
#!pip -q install gradio wget openai chromadb==0.4.7 langchain transformers tiktoken zhipuai

# 下面是注释掉的IPython魔法命令，以确保Python兼容性
# %cd content/Haruhi-2-Dev

# 下面是注释掉的IPython魔法命令，以确保Python兼容性
#!mkdir content
# %cd content
#!rm -rf /content/Haruhi-2-Dev
#!git clone https://github.com/LC1332/Haruhi-2-Dev
# %cd Haruhi-2-Dev
# %pwd

"""设置ChatHaruhi"""
# 设置Haruhi路径
haruhi_path = './content/Haruhi-2-Dev'

# 导入zipfile模块和ChatHaruhi类
import zipfile
from chatharuhi import ChatHaruhi

# 内置映射表NAME_DICT，将角色名映射为英文标识
NAME_DICT = {'汤师爷': 'tangshiye', '慕容复': 'murongfu', '李云龙': 'liyunlong', 'Luna': 'Luna', '王多鱼': 'wangduoyu',
             'Ron': 'Ron', '鸠摩智': 'jiumozhi', 'Snape': 'Snape',
             '凉宫春日': 'haruhi', 'Malfoy': 'Malfoy', '虚竹': 'xuzhu', '萧峰': 'xiaofeng', '段誉': 'duanyu',
             'Hermione': 'Hermione', 'Dumbledore': 'Dumbledore', '王语嫣': 'wangyuyan',
             'Harry': 'Harry', 'McGonagall': 'McGonagall', '白展堂': 'baizhantang', '佟湘玉': 'tongxiangyu',
             '郭芙蓉': 'guofurong', '旅行者': 'wanderer', '钟离': 'zhongli',
             '胡桃': 'hutao', 'Sheldon': 'Sheldon', 'Raj': 'Raj', 'Penny': 'Penny', '韦小宝': 'weixiaobao',
             '乔峰': 'qiaofeng', '神里绫华': 'ayaka', '雷电将军': 'raidenShogun', '于谦': 'yuqian'}

# 创建空字典ai_roles_obj用于存储角色名和ChatHaruhi对象的映射关系
ai_roles_obj = {}

# 遍历NAME_DICT中的每个角色英文标识
for ai_role_en in NAME_DICT.values():
    # 构建角色对应的ZIP文件路径
    zip_file_path = f"{haruhi_path}/data/character_in_zip/{ai_role_en}.zip"
    # 如果ZIP文件不存在，则打印未找到的信息并继续下一个循环
    if not os.path.exists(zip_file_path):
        print('unfound zip file ', zip_file_path)
        continue

    # 设定解压后的目标文件夹路径
    destination_folder = f"characters/{ai_role_en}"

    # 使用zipfile模块解压ZIP文件到目标文件夹
    with zipfile.ZipFile(zip_file_path, 'r') as zip_ref:
        zip_ref.extractall(destination_folder)

    # 构建角色数据文件夹和系统提示文件的路径
    db_folder = f"{haruhi_path}/characters/{ai_role_en}/content/{ai_role_en}"
    system_prompt = f"{haruhi_path}/characters/{ai_role_en}/content/system_prompt.txt"
    
    # 创建ChatHaruhi对象并存储到ai_roles_obj字典中
    ai_roles_obj[ai_role_en] = ChatHaruhi(system_prompt=system_prompt,
                                          llm="openai",
                                          story_db=db_folder,
                                          verbose=True)

# 打印存储了所有ChatHaruhi对象的字典
print(ai_roles_obj)

# 设置所有ChatHaruhi对象的聊天温度为0
for key in ai_roles_obj.keys():
    ai_roles_obj[key].llm.chat.temperature = 0
tester = {'汤师爷': '张牧之', '慕容复': '王语嫣', \
          '李云龙': '赵刚', 'Luna': 'Harry', '王多鱼': '夏竹',
          'Ron': 'Hermione', '鸠摩智': '慕容复', 'Snape': 'Dumbledore',
             '凉宫春日': '阿虚', 'Malfoy': 'Crabbe', \
          '虚竹': '乔峰', '萧峰': '阿朱', '段誉': '乔峰',\
             'Hermione': 'Harry', 'Dumbledore': 'McGonagall', '王语嫣': '段誉',\
             'Harry': 'Hermione', 'McGonagall': 'Dumbledore', '白展堂': '佟湘玉',\
           '佟湘玉': '白展堂',
             '郭芙蓉': '白展堂', '旅行者': '派蒙', '钟离': '旅行者',
             '胡桃': '旅行者', 'Sheldon': 'Leonard', 'Raj': 'Leonard', 'Penny': 'Leonard', \
          '韦小宝': '双儿',
             '乔峰': '阿朱', '神里绫华': '旅行者', '雷电将军': '旅行者', '于谦': '郭德纲'}

'''
target = '凉宫春日'

en_name = NAME_DICT[target]

chatbot = ai_roles_obj[en_name]

tester_name = tester[target]

question = datas[0]['chinese']

print(en_name, chatbot, tester_name, question)

"""测试Chatbot.chat"""


response = chatbot.chat(role = tester_name, text = question)


print(response)
'''

query_list = []

stubborn_characters = ['Dumbledore', 'Malfoy', '王语嫣', 'Raj', '旅行者', 'McGonagall', '鸠摩智', 'Sheldon', 'Penny', 'Snape'] 

# 构建查询列表，包含每个顽固角色和问题ID的组合
for target in stubborn_characters: #NAME_DICT.keys():
    for question_id in range(len(datas)):
        query_list.append((target, question_id))

#import random
#query_list = random.sample(query_list, 10)

#print(query_list)
#pdb.set_trace()

# 打印查询列表的长度
print(len(query_list))

#from google.colab import drive
#drive.mount('/content/drive')

#save_name = '/content/drive/MyDrive/Jupyter/mbti_results_open.txt'


save_name = f'mbti_results_stubborn.jsonl'

if_first = True

import json

role_id = {}

previous_response = []

# 如果保存文件存在，读取之前的响应数据
if os.path.exists(save_name):
    with open(save_name, encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            previous_response.append(data)


from tqdm import tqdm

count = 0


for target, question_id in tqdm(query_list):

    if count < len(previous_response):
        count = count + 1
        if_first = False
        continue
    
    en_name = NAME_DICT[target]

    chatbot = ai_roles_obj[en_name]

    # 清空对话历史，准备新的对话
    chatbot.dialogue_history = []
    chatbot.dialogue_history.append(("你好，我即将对你进行一项心理人格测试，你必须配合。请你用中文回答如实我的问题。", "好，请开始吧，我将配合你进行这项心理测试。")) 

    data = datas[question_id]

    question = data['chinese']

    tester_name = tester[target]

    # 与角色进行对话，获取第一个响应
    response_1 = chatbot.chat(role = tester_name, text = question)
    
    # 构建闭合问题提示
    closed_prompt = f"嗯，那对于'{data['chinese']}'这个问题，请你从['完全同意', '基本同意', '部分同意', '既不同意也不否认', '不太同意', '基本不同意', '完全不同意']中选择一个适合你的选项。请务必用中文回答，并用单引号强调你的选项。"

    # 与角色进行对话，获取第二个响应
    response_2 = chatbot.chat(role = tester_name, text = closed_prompt)

    # 检查响应中是否包含任何选项
    options = ['完全同意', '基本同意', '部分同意', '既不同意也不否认', '不太同意', '基本不同意', '完全不同意']
    ans = [ option for option in options if f"{option}" in response_2 ]

    # 如果没有找到合适的选项，打印错误信息并进行调试
    if len(ans) == 0:
        print('意外发生')
        print('Response 1: ', response_1)
        print('Response 2: ', response_2)
        #pdb.set_trace()

    # 写入模式根据是否为第一次进行调整
    file_mode = 'w' if if_first else 'a'

    if_first = False
    # 使用指定的文件名和文件模式打开文件，并使用 utf-8 编码方式
    with open(save_name, file_mode, encoding='utf-8') as f:
        # 准备要写入文件的数据，包括 id、问题、开放式回答、闭合式回答、因素和测试者名称
        data = {
            'id': data['id'],  # 使用给定数据中的 id
            'question': data['chinese'],  # 使用给定数据中的中文问题
            'response_open': response_1,  # 使用给定的开放式回答
            'response_closed': response_2,  # 使用给定的闭合式回答
            'factor': data['type'],  # 使用给定数据中的类型
            'test_role': tester_name  # 使用给定的测试者名称
        }
        # 将数据以 JSON 格式写入文件中，确保不转义非 ASCII 字符
        json.dump(data, f, ensure_ascii=False)
        # 在文件末尾写入一个换行符，以确保每次写入的数据都单独占据一行
        f.write('\n')
```