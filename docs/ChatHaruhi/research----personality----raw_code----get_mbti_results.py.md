# `.\Chat-Haruhi-Suzumiya\research\personality\raw_code\get_mbti_results.py`

```py
# -*- coding: utf-8 -*-
# 定义脚本的编码格式为 UTF-8

"""mbti_exp.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1tqCgRc3d2rWQoic5oV3AKqU-l_PCF1aU

读取数据
"""

import pdb  # 导入调试工具 pdb

input_name = 'mbti_questions.jsonl'  # 设置输入文件名为 mbti_questions.jsonl

import json  # 导入 JSON 模块

datas = []  # 初始化一个空列表用于存储数据

with open(input_name, encoding='utf-8') as f:
    # 打开文件 input_name，使用 UTF-8 编码读取
    for line in f:
        data = json.loads(line)  # 解析每一行 JSON 数据
        datas.append(data)  # 将解析后的数据添加到 datas 列表中

print(len(datas))  # 打印数据列表的长度

"""设置环境"""

import os  # 导入操作系统相关的模块
import openai  # 导入 openai 模块

os.environ["OPENAI_API_KEY"] = "sk-"  # 设置 OpenAI API 密钥

#!pip -q install gradio wget openai chromadb==0.4.7 langchain transformers tiktoken zhipuai

# IPython 魔法命令被注释掉以确保 Python 兼容性
# %cd content/Haruhi-2-Dev

# IPython 魔法命令被注释掉以确保 Python 兼容性
# !mkdir content
# %cd content
# !rm -rf /content/Haruhi-2-Dev
# !git clone https://github.com/LC1332/Haruhi-2-Dev
# %cd Haruhi-2-Dev
# %pwd

"""设置ChatHaruhi"""
haruhi_path = './content/Haruhi-2-Dev'  # 设置 Haruhi 路径为当前目录下的 content/Haruhi-2-Dev

import zipfile  # 导入处理 ZIP 文件的模块
from chatharuhi import ChatHaruhi  # 导入自定义的 ChatHaruhi 模块

import os  # 重新导入操作系统相关的模块

NAME_DICT = {'汤师爷': 'tangshiye', '慕容复': 'murongfu', '李云龙': 'liyunlong', 'Luna': 'Luna', '王多鱼': 'wangduoyu',
             'Ron': 'Ron', '鸠摩智': 'jiumozhi', 'Snape': 'Snape',
             '凉宫春日': 'haruhi', 'Malfoy': 'Malfoy', '虚竹': 'xuzhu', '萧峰': 'xiaofeng', '段誉': 'duanyu',
             'Hermione': 'Hermione', 'Dumbledore': 'Dumbledore', '王语嫣': 'wangyuyan',
             'Harry': 'Harry', 'McGonagall': 'McGonagall', '白展堂': 'baizhantang', '佟湘玉': 'tongxiangyu',
             '郭芙蓉': 'guofurong', '旅行者': 'wanderer', '钟离': 'zhongli',
             '胡桃': 'hutao', 'Sheldon': 'Sheldon', 'Raj': 'Raj', 'Penny': 'Penny', '韦小宝': 'weixiaobao',
             '乔峰': 'qiaofeng', '神里绫华': 'ayaka', '雷电将军': 'raidenShogun', '于谦': 'yuqian'}

ai_roles_obj = {}  # 初始化一个空字典用于存储角色对象

for ai_role_en in NAME_DICT.values():
    zip_file_path = f"{haruhi_path}/data/character_in_zip/{ai_role_en}.zip"
    if not os.path.exists(zip_file_path):
        # 如果 ZIP 文件路径不存在，打印未找到提示信息并继续下一个角色
        print('unfound zip file ', zip_file_path)
        continue

    destination_folder = f"characters/{ai_role_en}"  # 设置解压目标文件夹路径

    with zipfile.ZipFile(zip_file_path, 'r') as zip_ref:
        zip_ref.extractall(destination_folder)  # 解压 ZIP 文件到目标文件夹

    db_folder = f"{haruhi_path}/characters/{ai_role_en}/content/{ai_role_en}"  # 设置角色数据库文件夹路径
    system_prompt = f"{haruhi_path}/characters/{ai_role_en}/content/system_prompt.txt"  # 设置系统提示文件路径
    ai_roles_obj[ai_role_en] = ChatHaruhi(system_prompt=system_prompt,
                                          llm="openai",
                                          story_db=db_folder,
                                          verbose=True)  # 创建 ChatHaruhi 对象并存储到字典中

print(ai_roles_obj)  # 打印所有创建的角色对象

for key in ai_roles_obj.keys():
    ai_roles_obj[key].llm.chat.temperature = 0  # 针对每个角色对象，设置对话温度为 0
# 创建一个字典，包含测试人员的昵称及其对应的真实姓名
tester = {'汤师爷': '张牧之', '慕容复': '王语嫣', \
          '李云龙': '赵刚', 'Luna': 'Harry', '王多鱼': '夏竹',
          'Ron': 'Hermione', '鸠摩智': '慕容复', 'Snape': 'Dumbledore',
          '凉宫春日': '阿虚', 'Malfoy': 'Crabbe', \
          '虚竹': '乔峰', '萧峰': '阿朱', '段誉': '乔峰',\
          'Hermione': 'Harry', 'Dumbledore': 'McGonagall', '王语嫣': '段誉',\
          'Harry': 'Hermione', 'McGonagall': 'Dumbledore', '白展堂': '佟湘玉',\
          '佟湘玉': '白展堂',
          '郭芙蓉': '白展堂', '旅行者': '派蒙', '钟离': '旅行者',
          '胡桃': '旅行者', 'Sheldon': 'Leonard', 'Raj': 'Leonard', 'Penny': 'Leonard', \
          '韦小宝': '双儿',
          '乔峰': '阿朱', '神里绫华': '旅行者', '雷电将军': '旅行者', '于谦': '郭德纲'}

# 创建一个空列表 query_list 用于存储所有可能的测试人员和问题组合
query_list = []

# 遍历 NAME_DICT 中的每个测试人员
for target in NAME_DICT.keys():
    # 遍历 datas 列表中的每个问题索引
    for question_id in range(len(datas)):
        # 将每个测试人员和问题索引组成的元组添加到 query_list 中
        query_list.append((target, question_id))

# 导入 tqdm 模块，用于显示循环进度条
from tqdm import tqdm

# 初始化计数器 count 为 0
count = 0

# 遍历 query_list 中的每个测试人员和问题组合，并显示进度条
for target, question_id in tqdm(query_list):

    # 如果 count 小于等于之前已保存的响应数量，则跳过当前循环
    if count < len(previous_response):
        count = count + 1
        if_first = False
        continue
    
    # 获取测试人员的英文名字
    en_name = NAME_DICT[target]

    # 根据英文名字从 ai_roles_obj 中获取相应的聊天机器人对象
    chatbot = ai_roles_obj[en_name]

    # 清空聊天机器人的对话历史记录
    chatbot.dialogue_history = []

    # 获取当前问题的详细数据
    data = datas[question_id]

    # 获取当前问题的中文描述作为问题文本
    question = data['chinese']

    # 获取当前测试人员的真实姓名
    tester_name = tester[target]

    # 聊天机器人根据测试人员和问题文本进行第一轮对话，获取开放式回答
    response_1 = chatbot.chat(role = tester_name, text = question)
    
    # 构造一个封闭式问题的提示文本
    closed_prompt = f"嗯，那对于'{data['chinese']}'这个问题，请你从['完全同意', '基本同意', '部分同意', '既不同意也不否认', '不太同意', '基本不同意', '完全不同意']中选择一个适合你的选项。请务必用中文回答，并用单引号强调你的选项。"

    # 聊天机器人根据测试人员和封闭式问题提示进行第二轮对话，获取封闭式回答
    response_2 = chatbot.chat(role = tester_name, text = closed_prompt)

    # 如果是第一次写入文件，则使用写入模式 'w'，否则使用追加模式 'a'
    file_mode = 'w' if if_first else 'a'

    # 更新 if_first 标志为 False，表示已经不是第一次写入
    if_first = False

    # 打开文件 save_name，写入当前问题的测试结果数据
    with open(save_name, file_mode, encoding= 'utf-8') as f:
        data = {
            'id': data['id'],
            'question': data['chinese'],
            'response_open': response_1,
            'response_closed': response_2,
            'factor': data['type'],
            'test_role': tester_name
        }
        # 将数据以 JSON 格式写入文件，并确保中文不乱码
        json.dump(data, f, ensure_ascii=False)
        # 写入换行符以分隔不同的数据条目
        f.write('\n')
```