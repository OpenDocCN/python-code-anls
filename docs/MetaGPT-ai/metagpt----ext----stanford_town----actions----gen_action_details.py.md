
# `.\MetaGPT\metagpt\ext\stanford_town\actions\gen_action_details.py` è¯¦ç»†è®¾è®¡æ–‡æ¡£

è¯¥æ–‡ä»¶æ˜¯MetaGPTæ¡†æ¶ä¸­Stanford Townæ‰©å±•çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…å«ä¸€ç³»åˆ—ç”¨äºç”Ÿæˆè§’è‰²åŠ¨ä½œè¯¦ç»†ä¿¡æ¯çš„ç±»ã€‚è¿™äº›ç±»ç»§æ‰¿è‡ªSTActionåŸºç±»ï¼Œé€šè¿‡è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰æ¥ç”ŸæˆåŠ¨ä½œçš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬å‘ç”Ÿåœ°ç‚¹ï¼ˆä¸–ç•Œã€åŒºåŸŸã€åœºæ‰€ï¼‰ã€å¯¹è±¡ã€å‘éŸ³ç¬¦å·ã€äº‹ä»¶ä¸‰å…ƒç»„ä»¥åŠå¯¹è±¡æè¿°ç­‰ï¼Œæœ€ç»ˆç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œè¯¦æƒ…å­—å…¸ã€‚

## æ•´ä½“æµç¨‹

```mermaid
graph TD
    A[å¼€å§‹: GenActionDetails.run] --> B[è·å–è§’è‰²å½“å‰åæ ‡çš„è®¿é—®ä¿¡æ¯]
    B --> C[è°ƒç”¨GenActionSectorç”ŸæˆåŠ¨ä½œåŒºåŸŸ]
    C --> D[è°ƒç”¨GenActionArenaç”ŸæˆåŠ¨ä½œåœºæ‰€]
    D --> E{åœºæ‰€æ˜¯å¦æœ‰å¯è®¿é—®å¯¹è±¡?}
    E -- å¦ --> F[è®¾ç½®åŠ¨ä½œä¸ºéšæœºå¯¹è±¡]
    E -- æ˜¯ --> G[è°ƒç”¨GenActionObjectç”ŸæˆåŠ¨ä½œå¯¹è±¡]
    F --> H[ç»„åˆåŠ¨ä½œåœ°å€]
    G --> H
    H --> I[è°ƒç”¨GenPronunciatioç”ŸæˆåŠ¨ä½œå‘éŸ³ç¬¦å·]
    I --> J[è°ƒç”¨GenEventTripleç”ŸæˆåŠ¨ä½œäº‹ä»¶ä¸‰å…ƒç»„]
    J --> K[è°ƒç”¨GenActObjDescriptionç”Ÿæˆå¯¹è±¡æè¿°]
    K --> L[è°ƒç”¨GenPronunciatioç”Ÿæˆå¯¹è±¡å‘éŸ³ç¬¦å·]
    L --> M[è°ƒç”¨GenObjEventTripleç”Ÿæˆå¯¹è±¡äº‹ä»¶ä¸‰å…ƒç»„]
    M --> N[ç»„è£…æ‰€æœ‰ä¿¡æ¯ä¸ºç»“æœå­—å…¸]
    N --> O[ç»“æŸå¹¶è¿”å›ç»“æœ]
```

## ç±»ç»“æ„

```
STAction (åŸºç±»)
â”œâ”€â”€ GenActionSector (ç”ŸæˆåŠ¨ä½œåŒºåŸŸ)
â”œâ”€â”€ GenActionArena (ç”ŸæˆåŠ¨ä½œåœºæ‰€)
â”œâ”€â”€ GenActionObject (ç”ŸæˆåŠ¨ä½œå¯¹è±¡)
â”œâ”€â”€ GenPronunciatio (ç”Ÿæˆå‘éŸ³ç¬¦å·)
â”œâ”€â”€ GenEventTriple (ç”Ÿæˆäº‹ä»¶ä¸‰å…ƒç»„)
â”œâ”€â”€ GenActObjDescription (ç”Ÿæˆå¯¹è±¡æè¿°)
â”œâ”€â”€ GenObjEventTriple (ç”Ÿæˆå¯¹è±¡äº‹ä»¶ä¸‰å…ƒç»„)
â””â”€â”€ GenActionDetails (ç”ŸæˆåŠ¨ä½œè¯¦æƒ…ï¼Œåè°ƒè°ƒç”¨ä¸Šè¿°ç±»)
```

## å…¨å±€å˜é‡åŠå­—æ®µ




### `GenActionSector.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenActionArena.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenActionObject.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenPronunciatio.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenEventTriple.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenActObjDescription.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenObjEventTriple.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    


### `GenActionDetails.name`
    
åŠ¨ä½œç±»çš„æ ‡è¯†åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åŠ¨ä½œç”Ÿæˆå™¨ã€‚

ç±»å‹ï¼š`str`
    
    

## å…¨å±€å‡½æ•°åŠæ–¹æ³•

### `GenActionSector._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è¿”å›çš„å“åº”å­—ç¬¦ä¸²ã€‚å®ƒé€šè¿‡æˆªå–ç¬¬ä¸€ä¸ªå³èŠ±æ‹¬å· `}` ä¹‹å‰çš„éƒ¨åˆ†æ¥æå–æœ‰æ•ˆå†…å®¹ï¼Œæ—¨åœ¨å»é™¤å“åº”ä¸­å¯èƒ½å­˜åœ¨çš„å¤šä½™æ ¼å¼æˆ–æ— å…³æ–‡æœ¬ï¼Œç¡®ä¿è¿”å›çš„å­—ç¬¦ä¸²æ˜¯å¹²å‡€ã€å¯ç”¨çš„ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»å¤§è¯­è¨€æ¨¡å‹è·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œæ¸…ç†åçš„å“åº”å­—ç¬¦ä¸²ï¼Œå³åŸå§‹å“åº”ä¸­ç¬¬ä¸€ä¸ª `}` å­—ç¬¦ä¹‹å‰çš„éƒ¨åˆ†ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¾“å…¥å‚æ•° llm_resp]
    B --> C{llm_resp æ˜¯å¦åŒ…å« '}'?}
    C -- æ˜¯ --> D[ä½¿ç”¨ split æ–¹æ³•ä»¥ '}' åˆ†å‰²å­—ç¬¦ä¸²]
    D --> E[å–åˆ†å‰²åçš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸º cleaned_response]
    E --> F[è¿”å› cleaned_response]
    C -- å¦ --> G[è¿”å›ç©ºå­—ç¬¦ä¸² '']
    G --> H[ç»“æŸ]
    F --> H
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str):
    # ä½¿ç”¨ split æ–¹æ³•ï¼Œä»¥å³èŠ±æ‹¬å· '}' ä¸ºåˆ†éš”ç¬¦åˆ†å‰² llm_resp å­—ç¬¦ä¸²ã€‚
    # åˆ†å‰²åè¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆç´¢å¼•0ï¼‰ï¼Œå³ç¬¬ä¸€ä¸ª '}' ä¹‹å‰çš„æ‰€æœ‰å†…å®¹ã€‚
    # è¿™é€šå¸¸ç”¨äºæå– LLM å“åº”ä¸­ JSON æ ¼å¼æˆ–å…¶ä»–ç»“æ„åŒ–æ•°æ®çš„ä¸»ä½“éƒ¨åˆ†ã€‚
    cleaned_response = llm_resp.split("}")[0]
    # è¿”å›æ¸…ç†åçš„å­—ç¬¦ä¸²ã€‚
    return cleaned_response
```

### `GenActionSector._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹ç‰¹å®šæç¤ºè¯ï¼ˆpromptï¼‰çš„å“åº”ï¼ˆ`llm_resp`ï¼‰æ˜¯å¦ç¬¦åˆé¢„æœŸçš„æ ¼å¼è¦æ±‚ã€‚å®ƒæ‰§è¡Œä¸€ç³»åˆ—ç®€å•çš„æ ¼å¼æ£€æŸ¥ï¼Œç¡®ä¿å“åº”éç©ºã€åŒ…å«ç‰¹å®šå­—ç¬¦ä¸”ä¸åŒ…å«ç‰¹å®šå­—ç¬¦ï¼Œä»¥åˆ¤æ–­å“åº”æ˜¯å¦æœ‰æ•ˆã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹æ–‡æœ¬å“åº”ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯æ–‡æœ¬ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”é€šè¿‡æ‰€æœ‰æ ¼å¼æ£€æŸ¥åˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹éªŒè¯] --> B{llm_resp.strip() é•¿åº¦ < 1?};
    B -- æ˜¯ --> C[è¿”å› False];
    B -- å¦ --> D{llm_resp åŒ…å« '}'?};
    D -- å¦ --> C;
    D -- æ˜¯ --> E{llm_resp åŒ…å« ','?};
    E -- æ˜¯ --> C;
    E -- å¦ --> F[è¿”å› True];
    C --> G[ç»“æŸ];
    F --> G;
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_validate(self, llm_resp: str, prompt: str):
        # æ£€æŸ¥1: å»é™¤é¦–å°¾ç©ºæ ¼åï¼Œå“åº”æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²
        if len(llm_resp.strip()) < 1:
            return False
        # æ£€æŸ¥2: å“åº”ä¸­æ˜¯å¦åŒ…å«ç»“æŸå¤§æ‹¬å· '}'
        if "}" not in llm_resp:
            return False
        # æ£€æŸ¥3: å“åº”ä¸­æ˜¯å¦åŒ…å«é€—å· ',' (å¯èƒ½ç”¨äºé˜²æ­¢åˆ—è¡¨å½¢å¼çš„æ— æ•ˆå“åº”)
        if "," in llm_resp:
            return False
        # æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œè¿”å› True è¡¨ç¤ºå“åº”æœ‰æ•ˆ
        return True
```

### `GenActionSector._func_fail_default_resp`

è¯¥æ–¹æ³•ç”¨äºåœ¨ç”Ÿæˆè¡ŒåŠ¨åŒºåŸŸï¼ˆSectorï¼‰å¤±è´¥æ—¶ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤çš„è¿”å›å€¼ã€‚å®ƒä¸æ¥æ”¶ä»»ä½•å‚æ•°ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç¡¬ç¼–ç çš„å­—ç¬¦ä¸² `"kitchen"`ï¼Œä½œä¸ºé»˜è®¤çš„è¡ŒåŠ¨åŒºåŸŸã€‚

å‚æ•°ï¼š
- æ— 

è¿”å›å€¼ï¼š`str`ï¼Œè¿”å›ä¸€ä¸ªå›ºå®šçš„å­—ç¬¦ä¸² `"kitchen"`ï¼Œè¡¨ç¤ºé»˜è®¤çš„è¡ŒåŠ¨åŒºåŸŸã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¿”å›é»˜è®¤å€¼ 'kitchen']
    B --> C[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_fail_default_resp(self):
    fs = "kitchen"  # å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ fsï¼Œèµ‹å€¼ä¸º "kitchen"
    return fs  # è¿”å› fs ä½œä¸ºé»˜è®¤çš„è¡ŒåŠ¨åŒºåŸŸ
```


### `GenActionSector.run`

è¯¥æ–¹æ³•æ ¹æ®è§’è‰²ï¼ˆSTRoleï¼‰ã€å¯è®¿é—®çš„ç“¦ç‰‡ä¿¡æ¯ï¼ˆaccess_tileï¼‰å’ŒåŠ¨ä½œæè¿°ï¼ˆact_despï¼‰ï¼Œåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰ç”Ÿæˆæˆ–ç¡®å®šä¸€ä¸ªæœ€é€‚åˆæ‰§è¡Œè¯¥åŠ¨ä½œçš„â€œåŒºåŸŸâ€ï¼ˆSectorï¼‰ã€‚å…¶æ ¸å¿ƒé€»è¾‘æ˜¯ï¼šé¦–å…ˆæ„å»ºä¸€ä¸ªæç¤ºè¯ï¼ˆpromptï¼‰ï¼Œå…¶ä¸­åŒ…å«è§’è‰²ä¿¡æ¯ã€ç”Ÿæ´»åŒºåŸŸã€å¯è®¿é—®åŒºåŸŸä»¥åŠåŠ¨ä½œæè¿°ï¼›ç„¶åå°†æ­¤æç¤ºè¯å‘é€ç»™LLMè·å–å»ºè®®çš„åŒºåŸŸï¼›æœ€åå¯¹LLMçš„è¾“å‡ºè¿›è¡ŒéªŒè¯å’Œæ¸…æ´—ï¼Œå¹¶ç¡®ä¿è¿”å›çš„åŒºåŸŸåœ¨è§’è‰²å®é™…å¯è®¿é—®çš„èŒƒå›´å†…ï¼Œå¦‚æœä¸åœ¨åˆ™ä½¿ç”¨è§’è‰²çš„ç”Ÿæ´»åŒºåŸŸä½œä¸ºé»˜è®¤å€¼ã€‚

å‚æ•°ï¼š

-  `role`ï¼š`STRole`ï¼Œæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼ŒåŒ…å«å…¶è®°å¿†ã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚
-  `access_tile`ï¼š`dict[str, str]`ï¼Œä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«è§’è‰²å½“å‰æ‰€åœ¨æˆ–å¯è®¿é—®çš„ç“¦ç‰‡ä¿¡æ¯ï¼Œä¾‹å¦‚ `{'world': 'ä¸–ç•Œå', 'sector': 'åŒºåŸŸå'}`ã€‚
-  `act_desp`ï¼š`str`ï¼Œå¯¹å°†è¦æ‰§è¡Œçš„åŠ¨ä½œçš„æ–‡æœ¬æè¿°ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œç”Ÿæˆçš„æˆ–æœ€ç»ˆç¡®å®šçš„åŠ¨ä½œæ‰§è¡ŒåŒºåŸŸï¼ˆSectorï¼‰åç§°ã€‚

#### æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹: run(role, access_tile, act_desp)] --> B[è°ƒç”¨ create_prompt_input<br>æ„å»ºæç¤ºè¯è¾“å…¥åˆ—è¡¨]
    B --> C[ä½¿ç”¨ prompt_template<br>ç”Ÿæˆå®Œæ•´æç¤ºè¯ prompt]
    C --> D[è®¾ç½®å¤±è´¥é»˜è®¤å“åº”<br>self.fail_default_resp]
    D --> E{å¼‚æ­¥è°ƒç”¨ _run_gpt35_max_tokens<br>è·å–LLMè¾“å‡º}
    E --> F[è·å–è§’è‰²åœ¨ access_tile['world']<br>ä¸­æ‰€æœ‰å¯è®¿é—®åŒºåŸŸåˆ—è¡¨ x]
    F --> G{LLMè¾“å‡º output æ˜¯å¦åœ¨<br>å¯è®¿é—®åˆ—è¡¨ x ä¸­?}
    G -- æ˜¯ --> H[è®°å½•æ—¥å¿—å¹¶è¿”å› output]
    G -- å¦ --> I[å°† output è®¾ç½®ä¸º<br>è§’è‰²çš„ç”Ÿæ´»åŒºåŸŸ]
    I --> H
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", access_tile: dict[str, str], act_desp: str):
    # å†…éƒ¨å‡½æ•°ï¼šæ ¹æ®è¾“å…¥å‚æ•°æ„å»ºå‘é€ç»™LLMçš„æç¤ºè¯æ‰€éœ€çš„è¾“å…¥åˆ—è¡¨ã€‚
    def create_prompt_input(role, access_tile: dict[str, str], act_desp):
        act_world = f"{access_tile['world']}"  # ä»ç“¦ç‰‡ä¿¡æ¯ä¸­æå–ä¸–ç•Œåç§°

        prompt_input = []  # åˆå§‹åŒ–æç¤ºè¯è¾“å…¥åˆ—è¡¨

        # ä»¥ä¸‹ä»£ç å—ï¼ˆè¢«æ³¨é‡Šçš„ï¼‰ä¼¼ä¹æ˜¯æ—©æœŸçš„ã€æ›´å¤æ‚çš„æç¤ºè¯æ„å»ºé€»è¾‘ã€‚
        # å®ƒæ·»åŠ äº†è§’è‰²åã€ç”Ÿæ´»åŒºåŸŸã€å¯è®¿é—®åŒºåŸŸç­‰ä¿¡æ¯ã€‚
        # prompt_input += [role.scratch.get_str_name()]
        # prompt_input += [role.scratch.living_area.split(":")[1]]
        # x = f"{act_world}:{role.scratch.living_area.split(':')[1]}"
        # prompt_input += [role.s_mem.get_str_accessible_sector_arenas(x)]
        # ... (æ›´å¤šè¡Œ)

        # MAR 11 TEMP æ³¨é‡Šè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶ä¿®æ”¹ã€‚
        # æ¸…ç©ºä¹‹å‰çš„è¾“å…¥ï¼Œé‡æ–°æ„å»ºã€‚
        prompt_input = []
        act_world = access_tile["world"]
        # è·å–è§’è‰²åœ¨è¯¥ä¸–ç•Œä¸­æ‰€æœ‰å¯è®¿é—®çš„åŒºåŸŸå­—ç¬¦ä¸²ã€‚
        accessible_sector_str = role.s_mem.get_str_accessible_sectors(act_world)
        curr = accessible_sector_str.split(", ")  # åˆ†å‰²æˆåˆ—è¡¨
        fin_accessible_sectors = []
        for i in curr:
            # ä¸´æ—¶é€»è¾‘ï¼šå¦‚æœåŒºåŸŸååŒ…å«â€œ's houseâ€ï¼Œåˆ™åªä¿ç•™åŒ…å«è§’è‰²å§“æ°çš„åŒºåŸŸã€‚
            # è¿™å¯èƒ½æ˜¯ä¸ºäº†è¿‡æ»¤æ‰å…¶ä»–è§’è‰²çš„æˆ¿å­ã€‚
            if "'s house" in i:
                if role.scratch.last_name in i:
                    fin_accessible_sectors += [i]
            else:
                fin_accessible_sectors += [i]
        # å°†è¿‡æ»¤åçš„åˆ—è¡¨é‡æ–°è¿æ¥æˆå­—ç¬¦ä¸²ã€‚
        accessible_sector_str = ", ".join(fin_accessible_sectors)
        # END MAR 11 TEMP

        # å°†æœ€ç»ˆçš„å¯è®¿é—®åŒºåŸŸå­—ç¬¦ä¸²åŠ å…¥æç¤ºè¯è¾“å…¥ã€‚
        prompt_input += [accessible_sector_str]

        # å¤„ç†åŠ¨ä½œæè¿°ï¼šå¦‚æœåŒ…å«æ‹¬å·ï¼Œåˆ™æ‹†åˆ†ä¸ºä¸»è¦åŠ¨ä½œå’Œå¯¹è±¡/ç›®æ ‡ã€‚
        act_desp_1 = act_desp
        act_desp_2 = act_desp
        if "(" in act_desp:
            act_desp_1 = act_desp.split("(")[0].strip()   # æ‹¬å·å‰éƒ¨åˆ†ï¼Œå¦‚â€œæ­£åœ¨ç¡è§‰â€
            act_desp_2 = act_desp.split("(")[-1][:-1]     # æ‹¬å·å†…éƒ¨åˆ†ï¼Œå¦‚â€œåœ¨åºŠä¸Šâ€
        prompt_input += [role.scratch.get_str_name()]  # è§’è‰²å
        prompt_input += [act_desp_1]  # åŠ¨ä½œæè¿°1
        prompt_input += [act_desp_2]  # åŠ¨ä½œæè¿°2
        prompt_input += [role.scratch.get_str_name()]  # è§’è‰²åï¼ˆå†æ¬¡ï¼‰
        return prompt_input

    # ä½¿ç”¨æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶ç”Ÿæˆå®Œæ•´çš„æç¤ºè¯ã€‚
    prompt_template = "action_location_sector_v1.txt"
    prompt_input = create_prompt_input(role, access_tile, act_desp)
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)

    # è®¾ç½®LLMè°ƒç”¨å¤±è´¥æ—¶çš„é»˜è®¤è¿”å›å€¼ã€‚
    self.fail_default_resp = self._func_fail_default_resp()
    # å¼‚æ­¥è°ƒç”¨GPT-3.5ï¼Œé™åˆ¶æœ€å¤§tokenæ•°ä»¥æ§åˆ¶è¾“å‡ºé•¿åº¦ã€‚
    output = await self._run_gpt35_max_tokens(prompt, max_tokens=15)

    # éªŒè¯LLMè¿”å›çš„åŒºåŸŸæ˜¯å¦åœ¨è§’è‰²å®é™…å¯è®¿é—®çš„åˆ—è¡¨ä¸­ã€‚
    y = f"{access_tile['world']}"
    # è·å–è§’è‰²åœ¨è¯¥ä¸–ç•Œä¸­æ‰€æœ‰å¯è®¿é—®çš„åŒºåŸŸåˆ—è¡¨ã€‚
    x = [i.strip() for i in role.s_mem.get_str_accessible_sectors(y).split(",")]
    if output not in x:
        # å¦‚æœLLMè¿”å›çš„åŒºåŸŸä¸å¯è®¿é—®ï¼Œæœ‰ä¸¤ç§å¤‡é€‰æ–¹æ¡ˆï¼š
        # 1. éšæœºé€‰æ‹©ä¸€ä¸ªå¯è®¿é—®åŒºåŸŸï¼ˆè¢«æ³¨é‡Šæ‰ï¼‰ã€‚
        # output = random.choice(x)
        # 2. ä½¿ç”¨è§’è‰²è‡ªå·±çš„ç”Ÿæ´»åŒºåŸŸä½œä¸ºé»˜è®¤å€¼ï¼ˆå½“å‰é‡‡ç”¨ï¼‰ã€‚
        output = role.scratch.living_area.split(":")[1]
    # è®°å½•æ‰§è¡Œæ—¥å¿—ã€‚
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    # è¿”å›æœ€ç»ˆç¡®å®šçš„åŒºåŸŸåç§°ã€‚
    return output
```


### `GenActionArena._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è·å¾—çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚å…¶æ ¸å¿ƒé€»è¾‘æ˜¯æˆªå–å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ªå³èŠ±æ‹¬å· `}` ä¹‹å‰çš„éƒ¨åˆ†ï¼Œå¹¶è¿”å›è¯¥å­å­—ç¬¦ä¸²ã€‚è¿™æ˜¯ä¸€ç§ç®€å•çš„åå¤„ç†æ­¥éª¤ï¼Œæ—¨åœ¨ä»å¯èƒ½åŒ…å«é¢å¤–æ ¼å¼æˆ–å†…å®¹çš„å“åº”ä¸­æå–å‡ºæ ¸å¿ƒçš„æœ‰æ•ˆä¿¡æ¯ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»å¤§è¯­è¨€æ¨¡å‹è·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œæ¸…ç†åçš„å“åº”å­—ç¬¦ä¸²ï¼Œå³åŸå§‹å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ª `}` ä¹‹å‰çš„éƒ¨åˆ†ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B{è¾“å…¥: llm_resp}
    B --> C[æ‰§è¡Œæ¸…ç†æ“ä½œ: cleaned_response = llm_resp.split('}')[0]]
    C --> D[è¿”å› cleaned_response]
    D --> E[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str):
    # å°†åŸå§‹å“åº”å­—ç¬¦ä¸²æŒ‰å³èŠ±æ‹¬å· '}' åˆ†å‰²ï¼Œå–åˆ†å‰²åçš„ç¬¬ä¸€éƒ¨åˆ†ï¼ˆå³ç¬¬ä¸€ä¸ª '}' ä¹‹å‰çš„å†…å®¹ï¼‰
    cleaned_response = llm_resp.split("}")[0]
    # è¿”å›æ¸…ç†åçš„å­—ç¬¦ä¸²
    return cleaned_response
```

### `GenActionArena._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹ç‰¹å®šæç¤ºè¯ï¼ˆpromptï¼‰çš„å“åº”ï¼ˆ`llm_resp`ï¼‰æ˜¯å¦ç¬¦åˆé¢„æœŸçš„æ ¼å¼è¦æ±‚ã€‚å®ƒæ£€æŸ¥å“åº”å­—ç¬¦ä¸²æ˜¯å¦éç©ºã€æ˜¯å¦åŒ…å«å³èŠ±æ‹¬å· `}` ä»¥åŠæ˜¯å¦ä¸åŒ…å«é€—å· `,`ã€‚åªæœ‰å½“æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³æ—¶ï¼Œæ‰è®¤ä¸ºå“åº”æœ‰æ•ˆã€‚

å‚æ•°ï¼š
- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆæ­¤å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯ã€‚åœ¨æ­¤æ–¹æ³•ä¸­æœªç›´æ¥ä½¿ç”¨ï¼Œä½†ä½œä¸ºæ¥å£çš„ä¸€éƒ¨åˆ†ä¿ç•™ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”å­—ç¬¦ä¸²æ»¡è¶³æ‰€æœ‰éªŒè¯æ¡ä»¶åˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹éªŒè¯] --> B{llm_resp.stripé•¿åº¦ < 1?};
    B -- æ˜¯ --> C[è¿”å› False];
    B -- å¦ --> D{llm_resp åŒ…å« '}'?};
    D -- å¦ --> C;
    D -- æ˜¯ --> E{llm_resp åŒ…å« ','?};
    E -- æ˜¯ --> C;
    E -- å¦ --> F[è¿”å› True];
    C --> G[ç»“æŸ];
    F --> G;
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_validate(self, llm_resp: str, prompt: str):
        # æ£€æŸ¥1: å“åº”å­—ç¬¦ä¸²å»é™¤é¦–å°¾ç©ºæ ¼åæ˜¯å¦ä¸ºç©º
        if len(llm_resp.strip()) < 1:
            return False
        # æ£€æŸ¥2: å“åº”å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«å³èŠ±æ‹¬å· '}'
        if "}" not in llm_resp:
            return False
        # æ£€æŸ¥3: å“åº”å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«é€—å· ','
        if "," in llm_resp:
            return False
        # æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œè¿”å› True
        return True
```

### `GenActionArena._func_fail_default_resp`

è¯¥æ–¹æ³•ç”¨äºåœ¨ç”Ÿæˆè¡ŒåŠ¨åœºæ‰€ï¼ˆArenaï¼‰å¤±è´¥æ—¶ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤çš„å“åº”å€¼ã€‚

å‚æ•°ï¼š
- æ— å‚æ•°

è¿”å›å€¼ï¼š`str`ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸² `"kitchen"`ï¼Œä½œä¸ºé»˜è®¤çš„è¡ŒåŠ¨åœºæ‰€ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¿”å›é»˜è®¤å€¼ 'kitchen']
    B --> C[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_fail_default_resp(self):
    fs = "kitchen"  # å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ fsï¼Œèµ‹å€¼ä¸º "kitchen"
    return fs       # è¿”å› fs ä½œä¸ºé»˜è®¤çš„å¤±è´¥å“åº”
```

### `GenActionArena.run`

è¯¥æ–¹æ³•æ ¹æ®ç»™å®šçš„è§’è‰²ã€åŠ¨ä½œæè¿°ã€ä¸–ç•Œå’ŒåŒºåŸŸï¼Œç”Ÿæˆä¸€ä¸ªåˆé€‚çš„â€œåœºæ‰€â€ï¼ˆArenaï¼‰åç§°ã€‚å®ƒé€šè¿‡æ„å»ºæç¤ºè¯è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰æ¥ç”Ÿæˆå€™é€‰åœºæ‰€ï¼Œå¹¶å¯¹è¾“å‡ºè¿›è¡ŒéªŒè¯å’Œè¿‡æ»¤ï¼Œç¡®ä¿ç”Ÿæˆçš„åœºæ‰€æ˜¯è§’è‰²åœ¨è¯¥ä¸–ç•Œå’ŒåŒºåŸŸå†…å¯è®¿é—®çš„ã€‚

å‚æ•°ï¼š
- `role`ï¼š`STRole`ï¼Œæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼ŒåŒ…å«è§’è‰²çš„è®°å¿†ã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚
- `act_desp`ï¼š`str`ï¼ŒåŠ¨ä½œçš„æè¿°æ–‡æœ¬ï¼Œç”¨äºæŒ‡å¯¼åœºæ‰€çš„ç”Ÿæˆã€‚
- `act_world`ï¼š`str`ï¼ŒåŠ¨ä½œå‘ç”Ÿçš„ä¸–ç•Œåç§°ã€‚
- `act_sector`ï¼š`str`ï¼ŒåŠ¨ä½œå‘ç”Ÿçš„åŒºåŸŸåç§°ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œç”Ÿæˆçš„ã€è§’è‰²å¯è®¿é—®çš„åœºæ‰€åç§°ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹: run] --> B[è°ƒç”¨ create_prompt_input æ„å»ºæç¤ºè¯è¾“å…¥]
    B --> C[ä½¿ç”¨æ¨¡æ¿ action_location_object_vMar11.txt ç”Ÿæˆå®Œæ•´æç¤ºè¯]
    C --> D[è°ƒç”¨ _run_gpt35_max_tokens è¯·æ±‚LLMç”Ÿæˆåœºæ‰€]
    D --> E{LLMè¾“å‡ºæ˜¯å¦æœ‰æ•ˆ?}
    E -- æ˜¯ --> F[è®°å½•æ—¥å¿—å¹¶è¿”å›è¾“å‡º]
    E -- å¦ --> G[ä½¿ç”¨é»˜è®¤å¤±è´¥å“åº”]
    G --> F
    F --> H[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_desp: str, act_world: str, act_sector: str):
    # å†…éƒ¨å‡½æ•°ï¼šæ ¹æ®è¾“å…¥å‚æ•°æ„å»ºå‘é€ç»™LLMçš„æç¤ºè¯å†…å®¹åˆ—è¡¨ã€‚
    def create_prompt_input(role, act_desp, act_world, act_sector):
        prompt_input = []
        prompt_input += [role.scratch.get_str_name()]  # è§’è‰²å
        x = f"{act_world}:{act_sector}"
        prompt_input += [act_sector]  # åŒºåŸŸå

        # MAR 11 TEMP: ä¸´æ—¶é€»è¾‘ï¼Œè¿‡æ»¤è§’è‰²å¯è®¿é—®çš„åœºæ‰€åˆ—è¡¨ã€‚
        # è·å–è§’è‰²åœ¨è¯¥ä¸–ç•Œ-åŒºåŸŸä¸‹å¯è®¿é—®çš„æ‰€æœ‰åœºæ‰€å­—ç¬¦ä¸²ã€‚
        accessible_arena_str = role.s_mem.get_str_accessible_sector_arenas(x)
        curr = accessible_arena_str.split(", ")
        fin_accessible_arenas = []
        for i in curr:
            # å¦‚æœåœºæ‰€ååŒ…å«â€œ's roomâ€ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦å±äºè¯¥è§’è‰²çš„å§“æ°ã€‚
            if "'s room" in i:
                if role.scratch.last_name in i:
                    fin_accessible_arenas += [i]
            else:
                fin_accessible_arenas += [i]
        # å°†è¿‡æ»¤åçš„åˆ—è¡¨é‡æ–°ç»„åˆæˆå­—ç¬¦ä¸²ã€‚
        accessible_arena_str = ", ".join(fin_accessible_arenas)
        # END MAR 11 TEMP
        prompt_input += [accessible_arena_str]  # å¯è®¿é—®çš„åœºæ‰€åˆ—è¡¨

        # å¤„ç†åŠ¨ä½œæè¿°ï¼šå¦‚æœåŒ…å«æ‹¬å·ï¼Œåˆ™æ‹†åˆ†ä¸ºä¸»è¦åŠ¨ä½œå’Œå¯¹è±¡ã€‚
        act_desp_1 = act_desp
        act_desp_2 = act_desp
        if "(" in act_desp:
            act_desp_1 = act_desp.split("(")[0].strip()  # ä¸»è¦åŠ¨ä½œ
            act_desp_2 = act_desp.split("(")[-1][:-1]    # åŠ¨ä½œå¯¹è±¡
        prompt_input += [role.scratch.get_str_name()]  # è§’è‰²åï¼ˆå†æ¬¡ï¼‰
        prompt_input += [act_desp_1]  # ä¸»è¦åŠ¨ä½œæè¿°
        prompt_input += [act_desp_2]  # åŠ¨ä½œå¯¹è±¡æè¿°
        prompt_input += [role.scratch.get_str_name()]  # è§’è‰²åï¼ˆç¬¬ä¸‰æ¬¡ï¼‰

        prompt_input += [act_sector]  # åŒºåŸŸåï¼ˆå†æ¬¡ï¼‰
        prompt_input += [accessible_arena_str]  # å¯è®¿é—®çš„åœºæ‰€åˆ—è¡¨ï¼ˆå†æ¬¡ï¼‰
        return prompt_input

    # æŒ‡å®šä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿æ–‡ä»¶ã€‚
    prompt_template = "action_location_object_vMar11.txt"
    # æ„å»ºæç¤ºè¯è¾“å…¥åˆ—è¡¨ã€‚
    prompt_input = create_prompt_input(role, act_desp, act_world, act_sector)
    # ä½¿ç”¨æ¨¡æ¿å’Œè¾“å…¥ç”Ÿæˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²ã€‚
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)
    # è®¾ç½®é»˜è®¤çš„å¤±è´¥å“åº”ï¼ˆä¾‹å¦‚ï¼Œå½“LLMè°ƒç”¨å¤±è´¥æ—¶è¿”å›â€œkitchenâ€ï¼‰ã€‚
    self.fail_default_resp = self._func_fail_default_resp()
    # è°ƒç”¨GPT-3.5æ¨¡å‹ï¼Œç”Ÿæˆæœ€å¤š15ä¸ªtokençš„å“åº”ã€‚
    output = await self._run_gpt35_max_tokens(prompt, max_tokens=15)
    # è®°å½•ç”Ÿæˆç»“æœåˆ°æ—¥å¿—ã€‚
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    # è¿”å›ç”Ÿæˆçš„åœºæ‰€åç§°ã€‚
    return output
```

### `GenActionObject._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹ç”ŸæˆåŠ¨ä½œå¯¹è±¡ï¼ˆAction Objectï¼‰çš„å“åº”æ˜¯å¦æœ‰æ•ˆã€‚å®ƒæ£€æŸ¥å“åº”å­—ç¬¦ä¸²æ˜¯å¦éç©ºï¼Œä»…æ­¤ä¸€é¡¹æ¡ä»¶æ»¡è¶³å³è§†ä¸ºæœ‰æ•ˆã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆæ­¤å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”å­—ç¬¦ä¸²å»é™¤é¦–å°¾ç©ºæ ¼åé•¿åº¦å¤§äº0ï¼Œåˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B{llm_resp.strip() é•¿åº¦æ˜¯å¦ >= 1?};
    B -- æ˜¯ --> C[è¿”å› True];
    B -- å¦ --> D[è¿”å› False];
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_validate(self, llm_resp: str, prompt: str):
    # æ£€æŸ¥å»é™¤é¦–å°¾ç©ºæ ¼åçš„å“åº”å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦å¤§äº0ã€‚
    # è¿™æ˜¯è¯¥ç±»ä¸­å”¯ä¸€éœ€è¦çš„éªŒè¯æ¡ä»¶ï¼Œä¸åŒæ–‡ä»¶å…¶ä»–ç±»çš„éªŒè¯é€»è¾‘ï¼ˆå¦‚æ£€æŸ¥'}'æˆ–','ï¼‰ä¸åŒã€‚
    if len(llm_resp.strip()) < 1:
        return False
    return True
```

### `GenActionObject._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†å’Œæ ¼å¼åŒ–ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è·å¾—çš„åŸå§‹å“åº”æ–‡æœ¬ã€‚å®ƒé€šè¿‡å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„ç©ºç™½å­—ç¬¦ï¼Œç¡®ä¿è¿”å›ä¸€ä¸ªå¹²å‡€ã€æ— å¤šä½™ç©ºæ ¼çš„å­—ç¬¦ä¸²ã€‚

å‚æ•°ï¼š
- `llm_resp`ï¼š`str`ï¼Œä»LLMè·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆå“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æ­¤æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œæ¸…ç†åçš„å­—ç¬¦ä¸²ï¼Œå·²å»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¾“å…¥ llm_resp]
    B --> C[è°ƒç”¨ llm_resp.strip]
    C --> D[è¿”å› cleaned_response]
    D --> E[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str):
    # ä½¿ç”¨ strip() æ–¹æ³•å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„ç©ºç™½å­—ç¬¦
    cleaned_response = llm_resp.strip()
    # è¿”å›æ¸…ç†åçš„å­—ç¬¦ä¸²
    return cleaned_response
```

### `GenActionObject._func_fail_default_resp`

è¯¥æ–¹æ³•ç”¨äºåœ¨ç”ŸæˆåŠ¨ä½œå¯¹è±¡å¤±è´¥æ—¶ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤çš„å“åº”å€¼ã€‚å®ƒè¿”å›ä¸€ä¸ªç¡¬ç¼–ç çš„å­—ç¬¦ä¸² `"bed"`ï¼Œä½œä¸ºåå¤‡æ–¹æ¡ˆï¼Œä»¥ç¡®ä¿ç³»ç»Ÿåœ¨æ— æ³•ç”Ÿæˆæœ‰æ•ˆå¯¹è±¡æ—¶ä»èƒ½ç»§ç»­è¿è¡Œã€‚

å‚æ•°ï¼š
- æ— 

è¿”å›å€¼ï¼š`str`ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤çš„åŠ¨ä½œå¯¹è±¡åç§°ï¼Œå³å­—ç¬¦ä¸² `"bed"`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¿”å›é»˜è®¤å€¼ 'bed']
    B --> C[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_fail_default_resp(self):
    fs = "bed"  # å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„å¤±è´¥å“åº”å­—ç¬¦ä¸²
    return fs   # è¿”å›è¯¥é»˜è®¤å­—ç¬¦ä¸²
```

### `GenActionObject.run`

è¯¥æ–¹æ³•æ ¹æ®ç»™å®šçš„è§’è‰²ã€åŠ¨ä½œæè¿°å’Œä¸´æ—¶åœ°å€ï¼Œç”Ÿæˆä¸€ä¸ªå…·ä½“çš„åŠ¨ä½œå¯¹è±¡ã€‚å®ƒé¦–å…ˆé€šè¿‡æç¤ºæ¨¡æ¿è°ƒç”¨è¯­è¨€æ¨¡å‹æ¥ç”Ÿæˆå€™é€‰å¯¹è±¡ï¼Œç„¶åéªŒè¯è¯¥å¯¹è±¡æ˜¯å¦åœ¨è§’è‰²å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡åˆ—è¡¨ä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªå¯è®¿é—®çš„å¯¹è±¡ä½œä¸ºè¾“å‡ºã€‚

å‚æ•°ï¼š

- `role`ï¼š`STRole`ï¼Œè¡¨ç¤ºæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼ŒåŒ…å«è§’è‰²çš„è®°å¿†ã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚
- `act_desp`ï¼š`str`ï¼Œè¡¨ç¤ºåŠ¨ä½œçš„æè¿°ï¼Œç”¨äºç”ŸæˆåŠ¨ä½œå¯¹è±¡çš„ä¸Šä¸‹æ–‡ã€‚
- `temp_address`ï¼š`str`ï¼Œè¡¨ç¤ºä¸´æ—¶åœ°å€ï¼Œç”¨äºè·å–è¯¥åœ°å€ä¸‹å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡åˆ—è¡¨ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œè¡¨ç¤ºç”Ÿæˆçš„åŠ¨ä½œå¯¹è±¡åç§°ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è§£æåŠ¨ä½œæè¿°]
    B --> C[æ„å»ºæç¤ºè¾“å…¥]
    C --> D[åŠ è½½æç¤ºæ¨¡æ¿]
    D --> E[è°ƒç”¨è¯­è¨€æ¨¡å‹ç”Ÿæˆå€™é€‰å¯¹è±¡]
    E --> F{å€™é€‰å¯¹è±¡æ˜¯å¦åœ¨å¯è®¿é—®åˆ—è¡¨ä¸­ï¼Ÿ}
    F -->|æ˜¯| G[è¿”å›å€™é€‰å¯¹è±¡]
    F -->|å¦| H[éšæœºé€‰æ‹©å¯è®¿é—®å¯¹è±¡]
    H --> G
    G --> I[è®°å½•æ—¥å¿—]
    I --> J[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_desp: str, temp_address: str):
    # å†…éƒ¨å‡½æ•°ï¼šæ„å»ºæç¤ºè¾“å…¥
    def create_prompt_input(role, act_desp, temp_address):
        prompt_input = []
        # å¦‚æœåŠ¨ä½œæè¿°ä¸­åŒ…å«æ‹¬å·ï¼Œæå–æ‹¬å·å†…çš„å†…å®¹ä½œä¸ºåŠ¨ä½œæè¿°
        if "(" in act_desp:
            act_desp = act_desp.split("(")[-1][:-1]

        # å°†åŠ¨ä½œæè¿°æ·»åŠ åˆ°æç¤ºè¾“å…¥ä¸­
        prompt_input += [act_desp]
        # è·å–ä¸´æ—¶åœ°å€ä¸‹å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡åˆ—è¡¨ï¼Œå¹¶æ·»åŠ åˆ°æç¤ºè¾“å…¥ä¸­
        prompt_input += [role.s_mem.get_str_accessible_arena_game_objects(temp_address)]
        return prompt_input

    # æŒ‡å®šæç¤ºæ¨¡æ¿æ–‡ä»¶
    prompt_template = "action_object_v2.txt"
    # æ„å»ºæç¤ºè¾“å…¥
    prompt_input = create_prompt_input(role, act_desp, temp_address)
    # ç”Ÿæˆå®Œæ•´çš„æç¤ºæ–‡æœ¬
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)
    # è®¾ç½®é»˜è®¤å¤±è´¥å“åº”
    self.fail_default_resp = self._func_fail_default_resp()
    # è°ƒç”¨è¯­è¨€æ¨¡å‹ç”Ÿæˆå€™é€‰å¯¹è±¡ï¼Œé™åˆ¶æœ€å¤§ä»¤ç‰Œæ•°ä¸º15
    output = await self._run_gpt35_max_tokens(prompt, max_tokens=15)
    # è·å–ä¸´æ—¶åœ°å€ä¸‹å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡åˆ—è¡¨ï¼Œå¹¶è½¬æ¢ä¸ºåˆ—è¡¨å½¢å¼
    x = [i.strip() for i in role.s_mem.get_str_accessible_arena_game_objects(temp_address).split(",")]
    # éªŒè¯å€™é€‰å¯¹è±¡æ˜¯å¦åœ¨å¯è®¿é—®åˆ—è¡¨ä¸­
    if output not in x:
        # å¦‚æœä¸åœ¨ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªå¯è®¿é—®å¯¹è±¡ä½œä¸ºè¾“å‡º
        output = random.choice(x)
    # è®°å½•ç”Ÿæˆçš„åŠ¨ä½œå¯¹è±¡æ—¥å¿—
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    # è¿”å›ç”Ÿæˆçš„åŠ¨ä½œå¯¹è±¡
    return output
```

### `GenPronunciatio._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†å’Œæ ¼å¼åŒ–ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è·å–çš„å…³äºåŠ¨ä½œå‘éŸ³ï¼ˆPronunciatioï¼‰çš„å“åº”ã€‚å…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯å»é™¤å“åº”å­—ç¬¦ä¸²é¦–å°¾çš„ç©ºç™½å­—ç¬¦ï¼Œå¹¶ç¡®ä¿è¿”å›çš„å­—ç¬¦ä¸²é•¿åº¦ä¸è¶…è¿‡3ä¸ªå­—ç¬¦ï¼Œä»¥ç¬¦åˆå‘éŸ³ç¬¦å·ï¼ˆé€šå¸¸ä¸ºemojiï¼‰çš„æ ¼å¼è¦æ±‚ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»å¤§è¯­è¨€æ¨¡å‹è·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œæ¸…ç†å’Œæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸è¶…è¿‡3ä¸ªå­—ç¬¦ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¾“å…¥: llm_resp]
    B --> C[å»é™¤llm_respé¦–å°¾ç©ºç™½å­—ç¬¦]
    C --> D{åˆ¤æ–­é•¿åº¦æ˜¯å¦å¤§äº3?}
    D -- æ˜¯ --> E[æˆªå–å‰3ä¸ªå­—ç¬¦]
    D -- å¦ --> F[ä¿æŒåŸå­—ç¬¦ä¸²]
    E --> G[è¿”å›æ¸…ç†åçš„å­—ç¬¦ä¸²]
    F --> G
    G --> H[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str):
    # 1. å»é™¤å“åº”å­—ç¬¦ä¸²é¦–å°¾çš„ç©ºç™½å­—ç¬¦ï¼ˆå¦‚ç©ºæ ¼ã€æ¢è¡Œç¬¦ç­‰ï¼‰
    cr = llm_resp.strip()
    # 2. æ£€æŸ¥æ¸…ç†åå­—ç¬¦ä¸²çš„é•¿åº¦
    if len(cr) > 3:
        # 3. å¦‚æœé•¿åº¦è¶…è¿‡3ï¼Œåˆ™æˆªå–å‰3ä¸ªå­—ç¬¦
        cr = cr[:3]
    # 4. è¿”å›æœ€ç»ˆæ¸…ç†å’Œæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
    return cr
```

### `GenPronunciatio._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹ç”Ÿæˆå‘éŸ³ç¬¦å·ï¼ˆPronunciatioï¼‰è¯·æ±‚çš„å“åº”æ˜¯å¦æœ‰æ•ˆã€‚å®ƒé€šè¿‡å°è¯•æ¸…ç†å“åº”å¹¶æ£€æŸ¥å…¶åŸºæœ¬å®Œæ•´æ€§æ¥ç¡®ä¿å“åº”ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œç‰¹åˆ«æ˜¯ç¡®ä¿å“åº”ä¸ä¸ºç©ºä¸”æ¸…ç†è¿‡ç¨‹ä¸ä¼šå¼•å‘å¼‚å¸¸ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆæ­¤å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªç›´æ¥ä½¿ç”¨ï¼Œä½†ä¸ºä¿æŒæ¥å£ä¸€è‡´è€Œä¿ç•™ï¼‰ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”é€šè¿‡éªŒè¯åˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B{è°ƒç”¨ _func_cleanup æ¸…ç†å“åº”};
    B --> C{æ¸…ç†è¿‡ç¨‹æ˜¯å¦å¼•å‘å¼‚å¸¸?};
    C -->|æ˜¯| D[è¿”å› False];
    C -->|å¦| E{æ¸…ç†åçš„å“åº”é•¿åº¦æ˜¯å¦ä¸º0?};
    E -->|æ˜¯| D;
    E -->|å¦| F[è¿”å› True];
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_validate(self, llm_resp: str, prompt: str):
    try:
        # å°è¯•è°ƒç”¨æ¸…ç†å‡½æ•°æ¥å¤„ç†LLMçš„å“åº”ã€‚
        # æ¸…ç†å‡½æ•°ä¼šå»é™¤é¦–å°¾ç©ºæ ¼ï¼Œå¹¶å°†å“åº”é•¿åº¦é™åˆ¶åœ¨3ä¸ªå­—ç¬¦ä»¥å†…ã€‚
        self._func_cleanup(llm_resp, prompt="")
        # æ£€æŸ¥æ¸…ç†åçš„å“åº”æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²ã€‚
        # å¦‚æœä¸ºç©ºï¼Œè¯´æ˜åŸå§‹å“åº”æ— æ•ˆï¼ˆä¾‹å¦‚ï¼Œå¯èƒ½åªåŒ…å«ç©ºç™½å­—ç¬¦ï¼‰ã€‚
        if len(llm_resp) == 0:
            return False
    except Exception:
        # å¦‚æœåœ¨æ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼ˆä¾‹å¦‚ï¼Œå“åº”æ ¼å¼æ„å¤–å¯¼è‡´æ¸…ç†å‡½æ•°å‡ºé”™ï¼‰ï¼Œ
        # åˆ™è®¤ä¸ºå“åº”æ— æ•ˆã€‚
        return False
    # å¦‚æœå“åº”æˆåŠŸé€šè¿‡æ¸…ç†ä¸”ä¸ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºå®ƒæ˜¯æœ‰æ•ˆçš„ã€‚
    return True
```

### `GenPronunciatio._func_fail_default_resp`

è¯¥æ–¹æ³•ç”¨äºåœ¨ç”Ÿæˆè§’è‰²åŠ¨ä½œçš„â€œå‘éŸ³â€ï¼ˆPronunciatioï¼Œå³è¡¨æƒ…ç¬¦å·è¡¨ç¤ºï¼‰å¤±è´¥æ—¶ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤çš„è¿”å›å€¼ã€‚å®ƒæ˜¯`GenPronunciatio`ç±»ä¸­LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰è°ƒç”¨å¤±è´¥æ—¶çš„åå¤‡æ–¹æ¡ˆã€‚

å‚æ•°ï¼š
- æ— å‚æ•°

è¿”å›å€¼ï¼š`str`ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤çš„è¡¨æƒ…ç¬¦å·å­—ç¬¦ä¸² "ğŸ˜‹"ã€‚

#### æµç¨‹å›¾

```mermaid
flowchart TD
    Start[å¼€å§‹] --> Process[è¿”å›é»˜è®¤å­—ç¬¦ä¸² â€œğŸ˜‹â€]
    Process --> End[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_fail_default_resp(self):
    # å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„å¤±è´¥å“åº”å­—ç¬¦ä¸²ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªâ€œå¥½åƒâ€çš„è¡¨æƒ…ç¬¦å·ã€‚
    fs = "ğŸ˜‹"
    # è¿”å›è¿™ä¸ªé»˜è®¤å­—ç¬¦ä¸²ã€‚
    return fs
```

### `GenPronunciatio.run`

è¯¥æ–¹æ³•æ ¹æ®ç»™å®šçš„åŠ¨ä½œæè¿°ï¼ˆact_despï¼‰ç”Ÿæˆå¯¹åº”çš„è¡¨æƒ…ç¬¦å·ï¼ˆemojiï¼‰è¡¨ç¤ºï¼Œç”¨äºåœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸­å¯è§†åŒ–è§’è‰²çš„åŠ¨ä½œã€‚å®ƒé€šè¿‡è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰æ¥ç”Ÿæˆä¸åŠ¨ä½œæè¿°ç›¸åŒ¹é…çš„ã€æœ€å¤šåŒ…å«ä¸‰ä¸ªå­—ç¬¦çš„è¡¨æƒ…ç¬¦å·ä¸²ã€‚å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œåˆ™è¿”å›é»˜è®¤çš„â€œğŸ˜‹â€è¡¨æƒ…ã€‚

å‚æ•°ï¼š

- `role`ï¼š`STRole`ï¼Œè¡¨ç¤ºæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼ŒåŒ…å«è§’è‰²çš„çŠ¶æ€å’Œè®°å¿†ä¿¡æ¯ã€‚
- `act_desp`ï¼š`str`ï¼Œè¡¨ç¤ºåŠ¨ä½œçš„æè¿°æ–‡æœ¬ï¼Œä¾‹å¦‚â€œtaking a bathâ€ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œè¿”å›ä¸€ä¸ªè¡¨ç¤ºåŠ¨ä½œçš„è¡¨æƒ…ç¬¦å·å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚â€œğŸ›ğŸ§–â€â™€ï¸â€ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è°ƒç”¨ create_prompt_input å‡½æ•°<br>å¤„ç† act_desp å‚æ•°]
    B --> C[ä½¿ç”¨ prompt_template å’Œ prompt_input<br>ç”Ÿæˆå®Œæ•´çš„æç¤ºè¯ prompt]
    C --> D[è®¾ç½® fail_default_resp ä¸º ğŸ˜‹]
    D --> E[å¼‚æ­¥è°ƒç”¨ _run_gpt35 æ–¹æ³•<br>ä¼ å…¥ prompt, example_output, special_instruction]
    E --> F{LLM å“åº”æ˜¯å¦æœ‰æ•ˆï¼Ÿ}
    F -- æ˜¯ --> G[è°ƒç”¨ _func_cleanup æ¸…ç†å“åº”<br>é™åˆ¶é•¿åº¦ä¸º3ä¸ªå­—ç¬¦]
    G --> H[è®°å½•æ—¥å¿—å¹¶è¿”å›æ¸…ç†åçš„è¡¨æƒ…ç¬¦å·]
    F -- å¦ --> I[è¿”å›é»˜è®¤çš„ fail_default_resp ğŸ˜‹]
    I --> H
    H --> J[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_desp: str):
    # å†…éƒ¨å‡½æ•°ï¼šæ ¹æ®åŠ¨ä½œæè¿°åˆ›å»ºæç¤ºè¯è¾“å…¥
    def create_prompt_input(act_desp):
        # å¦‚æœåŠ¨ä½œæè¿°ä¸­åŒ…å«æ‹¬å·ï¼Œåˆ™æå–æ‹¬å·å†…çš„å†…å®¹ä½œä¸ºæ ¸å¿ƒæè¿°
        if "(" in act_desp:
            act_desp = act_desp.split("(")[-1].split(")")[0]
        # å°†å¤„ç†åçš„åŠ¨ä½œæè¿°æ”¾å…¥åˆ—è¡¨ä½œä¸ºæç¤ºè¯è¾“å…¥
        prompt_input = [act_desp]
        return prompt_input

    # æŒ‡å®šä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿æ–‡ä»¶å
    prompt_template = "generate_pronunciatio_v1.txt"
    # åˆ›å»ºæç¤ºè¯è¾“å…¥
    prompt_input = create_prompt_input(act_desp)
    # ä½¿ç”¨åŸºç±»æ–¹æ³•ç”Ÿæˆå®Œæ•´çš„æç¤ºè¯
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)
    # è®¾ç½®ç¤ºä¾‹è¾“å‡ºï¼Œç”¨äºæŒ‡å¯¼LLMç”Ÿæˆæ ¼å¼
    example_output = "ğŸ›ğŸ§–â€â™€ï¸"
    # ç‰¹æ®ŠæŒ‡ä»¤ï¼Œè¦æ±‚LLMè¾“å‡ºå¿…é¡»åªåŒ…å«è¡¨æƒ…ç¬¦å·
    special_instruction = "The value for the output must ONLY contain the emojis."
    # è®¾ç½®å¤±è´¥æ—¶çš„é»˜è®¤è¿”å›å€¼
    self.fail_default_resp = self._func_fail_default_resp()
    # å¼‚æ­¥è°ƒç”¨GPT-3.5æ¨¡å‹ç”Ÿæˆè¡¨æƒ…ç¬¦å·
    output = await self._run_gpt35(prompt, example_output, special_instruction)
    # è®°å½•ç”Ÿæˆç»“æœåˆ°æ—¥å¿—
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    # è¿”å›ç”Ÿæˆçš„è¡¨æƒ…ç¬¦å·å­—ç¬¦ä¸²
    return output
```

### `GenEventTriple._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†å’Œæ ¼å¼åŒ–ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œä»£è¡¨ä¸€ä¸ªäº‹ä»¶ä¸‰å…ƒç»„ä¸­çš„åä¸¤ä¸ªå…ƒç´ ï¼ˆä¸»è¯­å’Œè°“è¯­ï¼‰ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»LLMè·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”çš„æç¤ºè¯ï¼ˆåœ¨æ­¤æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`list`ï¼Œä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå­—ç¬¦ä¸²å…ƒç´ çš„åˆ—è¡¨ï¼Œåˆ†åˆ«ä»£è¡¨äº‹ä»¶ä¸‰å…ƒç»„ä¸­çš„åŠ¨ä½œï¼ˆæˆ–çŠ¶æ€ï¼‰å’Œå¯¹è±¡ï¼ˆæˆ–ç›®æ ‡ï¼‰ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[å»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºæ ¼]
    B --> C{å­—ç¬¦ä¸²æ˜¯å¦åŒ…å« ')'?}
    C -- æ˜¯ --> D[æˆªå– ')' ä¹‹å‰çš„éƒ¨åˆ†]
    C -- å¦ --> E[ä½¿ç”¨æ•´ä¸ªå­—ç¬¦ä¸²]
    D --> F[æŒ‰ ',' åˆ†å‰²å­—ç¬¦ä¸²]
    E --> F
    F --> G[å»é™¤æ¯ä¸ªåˆ†å‰²éƒ¨åˆ†çš„ç©ºæ ¼]
    G --> H[è¿”å›æ¸…ç†åçš„åˆ—è¡¨]
    H --> I[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_cleanup(self, llm_resp: str, prompt: str):
        # 1. å»é™¤åŸå§‹å“åº”å­—ç¬¦ä¸²é¦–å°¾çš„ç©ºç™½å­—ç¬¦
        cr = llm_resp.strip()
        # 2. å‡è®¾å“åº”æ ¼å¼ä¸º `(åŠ¨ä½œ, å¯¹è±¡)`ï¼Œæˆªå–ç¬¬ä¸€ä¸ªå³æ‹¬å·ä¹‹å‰çš„éƒ¨åˆ†
        #    è¿™æœ‰åŠ©äºå¤„ç†LLMå¯èƒ½è¿”å›çš„é¢å¤–æ–‡æœ¬æˆ–æ ¼å¼
        cr = [i.strip() for i in cr.split(")")[0].split(",")]
        # 3. è¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼šåŠ¨ä½œå’Œå¯¹è±¡
        return cr
```

### `GenEventTriple._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ç”Ÿæˆçš„å“åº”å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆç”Ÿæˆäº‹ä»¶ä¸‰å…ƒç»„çš„æ ¼å¼è¦æ±‚ã€‚å®ƒé€šè¿‡æ¸…ç†å“åº”å­—ç¬¦ä¸²å¹¶æ£€æŸ¥å…¶ç»“æ„æ¥ç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆå“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼Œåœ¨æœ¬æ–¹æ³•ä¸­æœªç›´æ¥ä½¿ç”¨ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”å­—ç¬¦ä¸²ç»è¿‡æ¸…ç†åæ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œåˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹] --> B{è°ƒç”¨ _func_cleanup æ¸…ç†å“åº”};
    B --> C{æ¸…ç†æ˜¯å¦æˆåŠŸ?};
    C -- æ˜¯ --> D{æ¸…ç†ååˆ—è¡¨é•¿åº¦ == 2?};
    C -- å¦ --> E[è¿”å› False];
    D -- æ˜¯ --> F[è¿”å› True];
    D -- å¦ --> E;
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_validate(self, llm_resp: str, prompt: str):
    try:
        # 1. é¦–å…ˆè°ƒç”¨ _func_cleanup æ–¹æ³•æ¸…ç†å“åº”å­—ç¬¦ä¸²ã€‚
        #    è¯¥æ–¹æ³•ä¼šå»é™¤é¦–å°¾ç©ºæ ¼ï¼ŒæŒ‰ ')' åˆ†å‰²å–ç¬¬ä¸€éƒ¨åˆ†ï¼Œå†æŒ‰ ',' åˆ†å‰²æˆåˆ—è¡¨ã€‚
        llm_resp = self._func_cleanup(llm_resp, prompt="")
        # 2. éªŒè¯æ¸…ç†åçš„ç»“æœæ˜¯å¦ä¸ºæ°å¥½åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ã€‚
        #    è¿™ç¬¦åˆäº‹ä»¶ä¸‰å…ƒç»„ï¼ˆä¸»è¯­ï¼Œ è°“è¯­ï¼‰çš„é¢„æœŸæ ¼å¼ã€‚
        if len(llm_resp) != 2:
            return False
    except Exception:
        # 3. å¦‚æœåœ¨æ¸…ç†æˆ–éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼ˆå¦‚å­—ç¬¦ä¸²æ ¼å¼é”™è¯¯ï¼‰ï¼Œ
        #    åˆ™è®¤ä¸ºå“åº”æ— æ•ˆï¼Œè¿”å› Falseã€‚
        return False
    # 4. æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œè¿”å› True è¡¨ç¤ºå“åº”æœ‰æ•ˆã€‚
    return True
```

### `GenEventTriple._func_fail_default_resp`

è¯¥æ–¹æ³•ä¸º`GenEventTriple`ç±»æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„å¤±è´¥å“åº”ã€‚å½“ç”Ÿæˆäº‹ä»¶ä¸‰å…ƒç»„ï¼ˆä¸»è¯­-è°“è¯­-å®¾è¯­ï¼‰çš„LLMè°ƒç”¨å¤±è´¥æˆ–éªŒè¯ä¸é€šè¿‡æ—¶ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªè¡¨ç¤ºè§’è‰²â€œç©ºé—²â€çŠ¶æ€çš„é»˜è®¤ä¸‰å…ƒç»„ã€‚

å‚æ•°ï¼š
- `role`ï¼š`STRole`ï¼Œè§¦å‘æ­¤å¤±è´¥å“åº”çš„è§’è‰²å¯¹è±¡ã€‚

è¿”å›å€¼ï¼š`tuple`ï¼Œä¸€ä¸ªåŒ…å«ä¸‰ä¸ªå­—ç¬¦ä¸²çš„å…ƒç»„ï¼Œæ ¼å¼ä¸º`(è§’è‰²å, "is", "idle")`ï¼Œè¡¨ç¤ºè¯¥è§’è‰²å½“å‰å¤„äºç©ºé—²çŠ¶æ€ã€‚

#### æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹] --> B[æ¥æ”¶è§’è‰²å¯¹è±¡ role]
    B --> C[æ„é€ å…ƒç»„ fs = (role.name, 'is', 'idle')]
    C --> D[è¿”å› fs]
    D --> E[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_fail_default_resp(self, role):
        # æ„é€ å¹¶è¿”å›ä¸€ä¸ªé»˜è®¤çš„å¤±è´¥å“åº”å…ƒç»„ã€‚
        # è¯¥å…ƒç»„è¡¨ç¤ºç»™å®šè§’è‰²å¤„äºâ€œç©ºé—²â€çŠ¶æ€ã€‚
        fs = (role.name, "is", "idle")
        return fs
```

### `GenEventTriple.run`

è¯¥æ–¹æ³•ç”¨äºç”Ÿæˆä¸€ä¸ªäº‹ä»¶ä¸‰å…ƒç»„ï¼ˆEvent Tripleï¼‰ï¼Œé€šå¸¸ç”¨äºæè¿°è§’è‰²æ‰§è¡ŒæŸä¸ªåŠ¨ä½œæ—¶äº§ç”Ÿçš„äº‹ä»¶ã€‚å®ƒæ¥æ”¶è§’è‰²å’ŒåŠ¨ä½œæè¿°ä½œä¸ºè¾“å…¥ï¼Œé€šè¿‡è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰ç”Ÿæˆä¸€ä¸ªç”±ä¸»è¯­ã€è°“è¯­å’Œå®¾è¯­ç»„æˆçš„ä¸‰å…ƒç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«è§’è‰²åç§°å’Œç”Ÿæˆçš„ä¸‰å…ƒç»„çš„å…ƒç»„ã€‚

å‚æ•°ï¼š

- `role`ï¼š`STRole`ï¼Œè¡¨ç¤ºæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼ŒåŒ…å«è§’è‰²çš„åç§°ã€è®°å¿†ã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚
- `act_desp`ï¼š`str`ï¼Œè¡¨ç¤ºåŠ¨ä½œçš„æè¿°å­—ç¬¦ä¸²ï¼Œç”¨äºç”Ÿæˆäº‹ä»¶ä¸‰å…ƒç»„ã€‚

è¿”å›å€¼ï¼š`tuple`ï¼Œè¿”å›ä¸€ä¸ªä¸‰å…ƒç»„ï¼Œæ ¼å¼ä¸º `(role.name, predicate, object)`ï¼Œå…¶ä¸­ `predicate` å’Œ `object` æ˜¯é€šè¿‡å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆçš„åŠ¨ä½œè°“è¯­å’Œå®¾è¯­ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è°ƒç”¨ create_prompt_input ç”Ÿæˆæç¤ºè¾“å…¥]
    B --> C[åŠ è½½æç¤ºæ¨¡æ¿ generate_event_triple_v1.txt]
    C --> D[ç”Ÿæˆå®Œæ•´æç¤º]
    D --> E[è°ƒç”¨ _run_gpt35_max_tokens ç”Ÿæˆ LLM å“åº”]
    E --> F{éªŒè¯å“åº”æ˜¯å¦æœ‰æ•ˆï¼Ÿ}
    F -- æ˜¯ --> G[æ¸…ç†å“åº”å¹¶æå–è°“è¯­å’Œå®¾è¯­]
    F -- å¦ --> H[ä½¿ç”¨é»˜è®¤å¤±è´¥å“åº”]
    H --> I[è¿”å›é»˜è®¤ä¸‰å…ƒç»„]
    G --> J[ç»„åˆæˆæœ€ç»ˆä¸‰å…ƒç»„ (role.name, predicate, object)]
    J --> K[è®°å½•æ—¥å¿—]
    K --> L[è¿”å›ä¸‰å…ƒç»„]
    I --> K
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_desp: str):
    # å†…éƒ¨å‡½æ•°ï¼šæ ¹æ®è§’è‰²å’ŒåŠ¨ä½œæè¿°ç”Ÿæˆæç¤ºè¾“å…¥
    def create_prompt_input(role, act_desp):
        # å¦‚æœåŠ¨ä½œæè¿°ä¸­åŒ…å«æ‹¬å·ï¼Œæå–æ‹¬å·å†…çš„å†…å®¹ä½œä¸ºæ ¸å¿ƒæè¿°
        if "(" in act_desp:
            act_desp = act_desp.split("(")[-1].split(")")[0]
        # æç¤ºè¾“å…¥æ ¼å¼ï¼š[è§’è‰²åç§°, åŠ¨ä½œæè¿°, è§’è‰²åç§°]
        prompt_input = [role.name, act_desp, role.name]
        return prompt_input

    # æŒ‡å®šä½¿ç”¨çš„æç¤ºæ¨¡æ¿æ–‡ä»¶å
    prompt_template = "generate_event_triple_v1.txt"
    # ç”Ÿæˆæç¤ºè¾“å…¥
    prompt_input = create_prompt_input(role, act_desp)
    # ä½¿ç”¨æ¨¡æ¿å’Œè¾“å…¥ç”Ÿæˆå®Œæ•´çš„æç¤º
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)
    # è®¾ç½®é»˜è®¤çš„å¤±è´¥å“åº”ï¼Œæ ¼å¼ä¸º (è§’è‰²å, "is", "idle")
    self.fail_default_resp = self._func_fail_default_resp(role)
    # è°ƒç”¨ GPT-3.5 æ¨¡å‹ç”Ÿæˆå“åº”ï¼Œé™åˆ¶æœ€å¤§ token æ•°ä¸º 30
    output = await self._run_gpt35_max_tokens(prompt, max_tokens=30)
    # å°†æ¨¡å‹è¾“å‡ºä¸è§’è‰²åç»„åˆæˆæœ€ç»ˆçš„ä¸‰å…ƒç»„
    output = (role.name, output[0], output[1])
    # è®°å½•ç”Ÿæˆçš„äº‹ä»¶ä¸‰å…ƒç»„åˆ°æ—¥å¿—
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    # è¿”å›ç”Ÿæˆçš„äº‹ä»¶ä¸‰å…ƒç»„
    return output
```

### `GenActObjDescription._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è¿”å›çš„å“åº”å­—ç¬¦ä¸²ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šå»é™¤å­—ç¬¦ä¸²æœ«å°¾çš„å¥ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä»¥ç¡®ä¿è¿”å›çš„æè¿°æ€§çŸ­è¯­æ ¼å¼ç»Ÿä¸€ï¼Œä¸åŒ…å«ç»“æŸæ ‡ç‚¹ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»å¤§è¯­è¨€æ¨¡å‹è·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œæ¸…ç†åçš„å­—ç¬¦ä¸²ï¼Œå·²ç§»é™¤æœ«å°¾çš„å¥ç‚¹ã€‚

#### æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹] --> B{è¾“å…¥: llm_resp}
    B --> C[å»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºç™½å­—ç¬¦]
    C --> D{å­—ç¬¦ä¸²æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯ '.'?}
    D -- æ˜¯ --> E[ç§»é™¤æœ€åä¸€ä¸ªå­—ç¬¦]
    D -- å¦ --> F[ä¿æŒåŸæ ·]
    E --> G[è¿”å›æ¸…ç†åçš„å­—ç¬¦ä¸²]
    F --> G
    G --> H[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str):
    # 1. å»é™¤è¾“å…¥å­—ç¬¦ä¸² `llm_resp` çš„é¦–å°¾ç©ºç™½å­—ç¬¦ã€‚
    cr = llm_resp.strip()
    # 2. æ£€æŸ¥æ¸…ç†åçš„å­—ç¬¦ä¸²æ˜¯å¦ä»¥å¥ç‚¹ '.' ç»“å°¾ã€‚
    if cr[-1] == ".":
        # 3. å¦‚æœæ˜¯ï¼Œåˆ™ç§»é™¤æœ€åä¸€ä¸ªå­—ç¬¦ï¼ˆå³å¥ç‚¹ï¼‰ã€‚
        cr = cr[:-1]
    # 4. è¿”å›å¤„ç†åçš„å­—ç¬¦ä¸²ã€‚
    return cr
```

### `GenActObjDescription._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹ç”ŸæˆåŠ¨ä½œå¯¹è±¡æè¿°çš„å“åº”æ˜¯å¦æœ‰æ•ˆã€‚å®ƒé€šè¿‡å°è¯•è°ƒç”¨æ¸…ç†å‡½æ•°æ¥æ£€æŸ¥å“åº”æ˜¯å¦å¯ä»¥è¢«æ­£ç¡®å¤„ç†ï¼Œå¦‚æœæ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸æˆ–æ¸…ç†åçš„å“åº”æ— æ•ˆï¼Œåˆ™è¿”å› `False`ï¼Œå¦åˆ™è¿”å› `True`ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆå“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªç›´æ¥ä½¿ç”¨ï¼Œä½†ä¸ºä¿æŒæ¥å£ä¸€è‡´è€Œä¿ç•™ï¼‰ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”æœ‰æ•ˆåˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B{å°è¯•è°ƒç”¨ _func_cleanup æ¸…ç† llm_resp};
    B -->|æˆåŠŸ| C[è¿”å› True];
    B -->|æŠ›å‡ºå¼‚å¸¸| D[è¿”å› False];
    C --> E[ç»“æŸ];
    D --> E;
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_validate(self, llm_resp: str, prompt: str):
    try:
        # å°è¯•è°ƒç”¨ _func_cleanup æ–¹æ³•æ¸…ç† llm_respã€‚
        # å¦‚æœæ¸…ç†è¿‡ç¨‹æˆåŠŸï¼ˆå³æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œåˆ™è®¤ä¸ºå“åº”æœ‰æ•ˆã€‚
        llm_resp = self._func_cleanup(llm_resp, prompt="")
    except Exception:
        # å¦‚æœåœ¨æ¸…ç†è¿‡ç¨‹ä¸­æ•è·åˆ°ä»»ä½•å¼‚å¸¸ï¼Œåˆ™è®¤ä¸ºå“åº”æ— æ•ˆï¼Œè¿”å› Falseã€‚
        return False
    # æ¸…ç†æˆåŠŸï¼Œè¿”å› True è¡¨ç¤ºå“åº”æœ‰æ•ˆã€‚
    return True
```

### `GenActObjDescription._func_fail_default_resp`

è¯¥æ–¹æ³•ä¸º`GenActObjDescription`ç±»æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„å¤±è´¥å“åº”ç”Ÿæˆå™¨ã€‚å½“å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„åŠ¨ä½œå¯¹è±¡æè¿°æ—¶ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªåŸºäºç»™å®šåŠ¨ä½œå¯¹è±¡çš„ã€è¡¨ç¤ºâ€œç©ºé—²â€çŠ¶æ€çš„é»˜è®¤æè¿°å­—ç¬¦ä¸²ã€‚

å‚æ•°ï¼š

- `act_game_object`ï¼š`str`ï¼Œéœ€è¦ç”Ÿæˆé»˜è®¤æè¿°çš„åŠ¨ä½œå¯¹è±¡åç§°ã€‚

è¿”å›å€¼ï¼š`str`ï¼Œä¸€ä¸ªæ ¼å¼ä¸ºâ€œ{act_game_object} is idleâ€çš„é»˜è®¤æè¿°å­—ç¬¦ä¸²ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[æ¥æ”¶å‚æ•° act_game_object]
    B --> C[æ„é€ é»˜è®¤å­—ç¬¦ä¸² fs = f'{act_game_object} is idle']
    C --> D[è¿”å› fs]
    D --> E[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_fail_default_resp(self, act_game_object):
        # æ„é€ å¹¶è¿”å›ä¸€ä¸ªé»˜è®¤çš„å¤±è´¥å“åº”å­—ç¬¦ä¸²ã€‚
        # æ ¼å¼ä¸ºï¼š`{åŠ¨ä½œå¯¹è±¡åç§°} is idle`ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡å¤„äºç©ºé—²çŠ¶æ€ã€‚
        fs = f"{act_game_object} is idle"
        return fs
```

### `GenActObjDescription.run`

è¯¥æ–¹æ³•ç”¨äºç”Ÿæˆè§’è‰²å¯¹ç‰¹å®šæ¸¸æˆå¯¹è±¡æ‰§è¡ŒåŠ¨ä½œæ—¶çš„æè¿°æ–‡æœ¬ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæ¸¸æˆå¯¹è±¡å’ŒåŠ¨ä½œæè¿°ï¼Œé€šè¿‡å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆä¸€ä¸ªç®€çŸ­çš„ã€æè¿°æ€§çš„çŸ­è¯­ï¼Œç”¨äºå¡«å……åˆ°ç±»ä¼¼â€œ{æ¸¸æˆå¯¹è±¡} is {æè¿°}â€çš„æ¨¡æ¿ä¸­ã€‚

å‚æ•°ï¼š

- `role`ï¼š`STRole`ï¼Œæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼ŒåŒ…å«è§’è‰²çš„è®°å¿†ã€çŠ¶æ€ç­‰ä¿¡æ¯
- `act_game_object`ï¼š`str`ï¼Œæ¸¸æˆå¯¹è±¡çš„åç§°ï¼Œå¦‚â€œbedâ€ã€â€œkitchen tableâ€ç­‰
- `act_desp`ï¼š`str`ï¼ŒåŠ¨ä½œçš„æè¿°æ–‡æœ¬ï¼Œå¦‚â€œsleepingâ€ã€â€œcooking breakfastâ€ç­‰

è¿”å›å€¼ï¼š`str`ï¼Œè¿”å›ç”Ÿæˆçš„æè¿°çŸ­è¯­ï¼Œå¦‚â€œbeing fixedâ€ã€â€œoccupiedâ€ç­‰

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹: run(role, act_game_object, act_desp)] --> B[è°ƒç”¨create_prompt_input<br>æ„é€ æç¤ºè¯è¾“å…¥]
    B --> C[ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶<br>generate_obj_event_v1.txtç”Ÿæˆå®Œæ•´æç¤ºè¯]
    C --> D[è°ƒç”¨_run_gpt35æ–¹æ³•<br>è¯·æ±‚å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆ]
    D --> E{æ¨¡å‹å“åº”æ˜¯å¦æœ‰æ•ˆ?}
    E -- æ˜¯ --> F[è°ƒç”¨_func_cleanup<br>æ¸…ç†å“åº”æ–‡æœ¬]
    F --> G[è®°å½•æ—¥å¿—å¹¶è¿”å›ç»“æœ]
    E -- å¦ --> H[è¿”å›_func_fail_default_resp<br>ç”Ÿæˆçš„é»˜è®¤å“åº”]
    H --> G
    G --> I[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_game_object: str, act_desp: str):
    # å†…éƒ¨å‡½æ•°ï¼šæ„é€ æç¤ºè¯è¾“å…¥å‚æ•°
    def create_prompt_input(act_game_object, act_desp, role):
        # æç¤ºè¯è¾“å…¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ¸¸æˆå¯¹è±¡ã€è§’è‰²åã€åŠ¨ä½œæè¿°ç­‰å…ƒç´ 
        prompt_input = [act_game_object, role.name, act_desp, act_game_object, act_game_object]
        return prompt_input

    # ä½¿ç”¨æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶æ„é€ æç¤ºè¯
    prompt_template = "generate_obj_event_v1.txt"
    prompt_input = create_prompt_input(act_game_object, act_desp, role)
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)
    
    # è®¾ç½®ç¤ºä¾‹è¾“å‡ºå’Œç‰¹æ®ŠæŒ‡ä»¤ï¼ŒæŒ‡å¯¼æ¨¡å‹ç”Ÿæˆç‰¹å®šæ ¼å¼çš„å“åº”
    example_output = "being fixed"
    special_instruction = "The output should ONLY contain the phrase that should go in <fill in>."
    
    # è®¾ç½®å¤±è´¥æ—¶çš„é»˜è®¤å“åº”
    self.fail_default_resp = self._func_fail_default_resp(act_game_object)
    
    # è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆå“åº”
    output = await self._run_gpt35(prompt, example_output, special_instruction)
    
    # è®°å½•æ‰§è¡Œæ—¥å¿—
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    
    # è¿”å›ç”Ÿæˆçš„æè¿°æ–‡æœ¬
    return output
```

### `GenObjEventTriple._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†å’Œæ ¼å¼åŒ–ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è·å¾—çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œä½œä¸ºäº‹ä»¶ä¸‰å…ƒç»„ä¸­çš„åä¸¤ä¸ªå…ƒç´ ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»LLMè·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`list`ï¼Œä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå­—ç¬¦ä¸²å…ƒç´ çš„åˆ—è¡¨ï¼Œä»£è¡¨äº‹ä»¶ä¸‰å…ƒç»„ä¸­çš„è°“è¯å’Œå®¾è¯­éƒ¨åˆ†ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è¾“å…¥: llm_resp]
    B --> C[å»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºç™½å­—ç¬¦]
    C --> D[ä»¥ç¬¬ä¸€ä¸ª')'å­—ç¬¦ä¸ºç•Œæˆªå–å­—ç¬¦ä¸²]
    D --> E[ä»¥','ä¸ºåˆ†éš”ç¬¦åˆ†å‰²å­—ç¬¦ä¸²]
    E --> F[å»é™¤åˆ†å‰²åæ¯ä¸ªå…ƒç´ çš„ç©ºç™½å­—ç¬¦]
    F --> G[è¿”å›åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨]
    G --> H[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str):
    # 1. å»é™¤åŸå§‹å“åº”å­—ç¬¦ä¸²é¦–å°¾çš„ç©ºç™½å­—ç¬¦
    cr = llm_resp.strip()
    # 2. ä»¥ç¬¬ä¸€ä¸ªå³æ‹¬å· ')' ä¸ºç•Œï¼Œæˆªå–å…¶å‰é¢çš„éƒ¨åˆ†ã€‚
    #    ç„¶åä»¥é€—å· ',' ä¸ºåˆ†éš”ç¬¦ï¼Œå°†å­—ç¬¦ä¸²åˆ†å‰²æˆåˆ—è¡¨ã€‚
    #    æœ€åï¼Œä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼å»é™¤åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„é¦–å°¾ç©ºç™½å­—ç¬¦ã€‚
    cr = [i.strip() for i in cr.split(")")[0].split(",")]
    # 3. è¿”å›å¤„ç†åçš„åˆ—è¡¨ã€‚æ ¹æ® `_func_validate` æ–¹æ³•ï¼Œé¢„æœŸæ­¤åˆ—è¡¨åº”æ°å¥½åŒ…å«ä¸¤ä¸ªå…ƒç´ ã€‚
    return cr
```

### `GenObjEventTriple._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹ç”Ÿæˆå¯¹è±¡äº‹ä»¶ä¸‰å…ƒç»„çš„å“åº”æ˜¯å¦æœ‰æ•ˆã€‚å®ƒé¦–å…ˆå°è¯•æ¸…ç†å“åº”å­—ç¬¦ä¸²ï¼Œç„¶åæ£€æŸ¥æ¸…ç†åçš„ç»“æœæ˜¯å¦ä¸ºæ°å¥½åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ã€‚å¦‚æœæ¸…ç†è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸æˆ–ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™éªŒè¯å¤±è´¥ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆå“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªç›´æ¥ä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”æœ‰æ•ˆåˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B{è°ƒç”¨ _func_cleanup æ¸…ç† llm_resp};
    B --> C{æ˜¯å¦æŠ›å‡ºå¼‚å¸¸?};
    C -->|æ˜¯| D[è¿”å› False];
    C -->|å¦| E{æ¸…ç†åçš„åˆ—è¡¨é•¿åº¦æ˜¯å¦ä¸º 2?};
    E -->|æ˜¯| F[è¿”å› True];
    E -->|å¦| D;
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_validate(self, llm_resp: str, prompt: str):
    try:
        # å°è¯•è°ƒç”¨ _func_cleanup æ–¹æ³•æ¸…ç†å“åº”å­—ç¬¦ä¸²ã€‚
        # _func_cleanup ä¼šå°†å­—ç¬¦ä¸²æŒ‰ ')' å’Œ ',' åˆ†å‰²å¹¶å»é™¤ç©ºæ ¼ã€‚
        llm_resp = self._func_cleanup(llm_resp, prompt="")
        # éªŒè¯æ¸…ç†åçš„ç»“æœæ˜¯å¦ä¸ºæ°å¥½åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ã€‚
        # è¿™ç¬¦åˆäº‹ä»¶ä¸‰å…ƒç»„ï¼ˆä¸»è¯­ï¼Œ è°“è¯­ï¼Œ å®¾è¯­ï¼‰ä¸­åä¸¤ä¸ªå…ƒç´ çš„é¢„æœŸæ ¼å¼ã€‚
        if len(llm_resp) != 2:
            return False
    except Exception:
        # å¦‚æœåœ¨æ¸…ç†æˆ–éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼ˆå¦‚å­—ç¬¦ä¸²æ ¼å¼é”™è¯¯ï¼‰ï¼Œåˆ™éªŒè¯å¤±è´¥ã€‚
        return False
    # æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œè¿”å›éªŒè¯æˆåŠŸã€‚
    return True
```

### `GenObjEventTriple._func_fail_default_resp`

è¯¥æ–¹æ³•ç”¨äºåœ¨ç”Ÿæˆå¯¹è±¡äº‹ä»¶ä¸‰å…ƒç»„å¤±è´¥æ—¶ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤çš„ã€å®‰å…¨çš„å“åº”ã€‚å®ƒè¿”å›ä¸€ä¸ªè¡¨ç¤ºå¯¹è±¡å¤„äºâ€œç©ºé—²â€çŠ¶æ€çš„ä¸‰å…ƒç»„ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿåœ¨LLMå“åº”æ— æ•ˆæ—¶ä»èƒ½ç»§ç»­è¿è¡Œï¼Œé¿å…å› ç©ºå€¼æˆ–å¼‚å¸¸å¯¼è‡´æµç¨‹ä¸­æ–­ã€‚

å‚æ•°ï¼š

- `act_game_object`ï¼š`str`ï¼Œè¡¨ç¤ºå½“å‰åŠ¨ä½œæ‰€æ¶‰åŠçš„æ¸¸æˆå¯¹è±¡åç§°ï¼Œç”¨äºæ„å»ºé»˜è®¤äº‹ä»¶ä¸‰å…ƒç»„çš„ä¸»ä½“ã€‚

è¿”å›å€¼ï¼š`tuple[str, str, str]`ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªå­—ç¬¦ä¸²çš„å…ƒç»„ï¼Œæ ¼å¼ä¸º`(å¯¹è±¡åç§°, "is", "idle")`ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡å¤„äºç©ºé—²çŠ¶æ€ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[æ¥æ”¶å‚æ•° act_game_object]
    B --> C[æ„å»ºé»˜è®¤ä¸‰å…ƒç»„ fs = (act_game_object, 'is', 'idle')]
    C --> D[è¿”å›é»˜è®¤ä¸‰å…ƒç»„ fs]
    D --> E[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_fail_default_resp(self, act_game_object: str):
    # æ„å»ºä¸€ä¸ªé»˜è®¤çš„äº‹ä»¶ä¸‰å…ƒç»„ï¼Œè¡¨ç¤ºå¯¹è±¡å¤„äºâ€œç©ºé—²â€çŠ¶æ€ã€‚
    # å½“LLMæ— æ³•ç”Ÿæˆæœ‰æ•ˆå“åº”æ—¶ï¼Œæ­¤æ–¹æ³•æä¾›ä¸€ä¸ªå®‰å…¨çš„å›é€€å€¼ã€‚
    fs = (act_game_object, "is", "idle")
    return fs
```

### `GenObjEventTriple.run`

è¯¥æ–¹æ³•ç”¨äºç”Ÿæˆä¸æ¸¸æˆå¯¹è±¡ç›¸å…³çš„äº‹ä»¶ä¸‰å…ƒç»„ï¼ˆä¸»è¯­ã€è°“è¯­ã€å®¾è¯­ï¼‰ï¼ŒåŸºäºç»™å®šçš„æ¸¸æˆå¯¹è±¡å’Œå¯¹è±¡æè¿°ï¼Œé€šè¿‡è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰ç”Ÿæˆä¸€ä¸ªæè¿°è¯¥å¯¹è±¡çŠ¶æ€æˆ–è¡Œä¸ºçš„ç®€çŸ­äº‹ä»¶ã€‚

å‚æ•°ï¼š

- `role`ï¼š`STRole`ï¼Œè¡¨ç¤ºå½“å‰æ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡ï¼Œç”¨äºæ—¥å¿—è®°å½•å’Œå¯èƒ½çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
- `act_game_object`ï¼š`str`ï¼Œè¡¨ç¤ºæ¸¸æˆå¯¹è±¡çš„åç§°æˆ–æ ‡è¯†ç¬¦ï¼Œå°†ä½œä¸ºäº‹ä»¶ä¸‰å…ƒç»„çš„ä¸»è¯­ã€‚
- `act_obj_desp`ï¼š`str`ï¼Œè¡¨ç¤ºæ¸¸æˆå¯¹è±¡çš„æè¿°ï¼Œç”¨äºç”Ÿæˆäº‹ä»¶ä¸‰å…ƒç»„çš„è°“è¯­å’Œå®¾è¯­ã€‚

è¿”å›å€¼ï¼š`tuple`ï¼Œè¿”å›ä¸€ä¸ªä¸‰å…ƒç»„ `(act_game_object, predicate, object)`ï¼Œå…¶ä¸­ `predicate` å’Œ `object` æ˜¯ç”±å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆçš„è°“è¯­å’Œå®¾è¯­ï¼Œæè¿°æ¸¸æˆå¯¹è±¡çš„çŠ¶æ€æˆ–è¡Œä¸ºã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[åˆ›å»ºæç¤ºè¾“å…¥<br>act_game_object, act_obj_desp]
    B --> C[åŠ è½½æç¤ºæ¨¡æ¿<br>generate_event_triple_v1.txt]
    C --> D[ç”Ÿæˆå®Œæ•´æç¤º]
    D --> E[è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ GPT-3.5<br>max_tokens=30]
    E --> F{æ¨¡å‹å“åº”æ˜¯å¦æœ‰æ•ˆï¼Ÿ}
    F -- æ˜¯ --> G[æ¸…ç†å“åº”<br>åˆ†å‰²ä¸ºä¸¤éƒ¨åˆ†]
    G --> H[æ„å»ºä¸‰å…ƒç»„<br>act_game_object, predicate, object]
    H --> I[è®°å½•æ—¥å¿—]
    I --> J[è¿”å›ä¸‰å…ƒç»„]
    F -- å¦ --> K[ä½¿ç”¨é»˜è®¤å“åº”<br>act_game_object, 'is', 'idle']
    K --> I
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_game_object, act_obj_desp):
    # å†…éƒ¨å‡½æ•°ï¼šæ ¹æ®æ¸¸æˆå¯¹è±¡å’Œå¯¹è±¡æè¿°åˆ›å»ºæç¤ºè¾“å…¥
    def create_prompt_input(act_game_object, act_obj_desp):
        prompt_input = [act_game_object, act_obj_desp, act_game_object]
        return prompt_input

    # æŒ‡å®šä½¿ç”¨çš„æç¤ºæ¨¡æ¿æ–‡ä»¶å
    prompt_template = "generate_event_triple_v1.txt"
    # åˆ›å»ºæç¤ºè¾“å…¥
    prompt_input = create_prompt_input(act_game_object, act_obj_desp)
    # ä½¿ç”¨æ¨¡æ¿å’Œè¾“å…¥ç”Ÿæˆå®Œæ•´çš„æç¤º
    prompt = self.generate_prompt_with_tmpl_filename(prompt_input, prompt_template)
    # è®¾ç½®é»˜è®¤å¤±è´¥å“åº”ï¼Œå½“æ¨¡å‹å“åº”æ— æ•ˆæ—¶ä½¿ç”¨
    self.fail_default_resp = self._func_fail_default_resp(act_game_object)
    # è°ƒç”¨ GPT-3.5 æ¨¡å‹ï¼Œé™åˆ¶æœ€å¤§ token æ•°ä¸º 30
    output = await self._run_gpt35_max_tokens(prompt, max_tokens=30)
    # å°†æ¨¡å‹è¾“å‡ºä¸æ¸¸æˆå¯¹è±¡ç»„åˆæˆä¸‰å…ƒç»„
    output = (act_game_object, output[0], output[1])
    # è®°å½•æ‰§è¡Œæ—¥å¿—
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {output}")
    # è¿”å›ç”Ÿæˆçš„äº‹ä»¶ä¸‰å…ƒç»„
    return output
```

### `GenActionDetails._func_cleanup`

è¯¥æ–¹æ³•ç”¨äºæ¸…ç†å’Œæ ¼å¼åŒ–ä»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è¿”å›çš„å“åº”å­—ç¬¦ä¸²ã€‚å…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯æ¥æ”¶åŸå§‹çš„LLMå“åº”ï¼Œé€šè¿‡ç‰¹å®šçš„å¤„ç†é€»è¾‘ï¼ˆå¦‚åˆ†å‰²ã€å»é™¤ç‰¹å®šå­—ç¬¦ç­‰ï¼‰å°†å…¶è½¬æ¢ä¸ºæ›´å¹²å‡€ã€ç»“æ„åŒ–çš„æ ¼å¼ï¼Œä»¥ä¾›åç»­æ­¥éª¤ä½¿ç”¨ã€‚å½“å‰å®ç°ä¸­ï¼Œè¯¥æ–¹æ³•ä»…åŒ…å«ä¸€ä¸ªå ä½ç¬¦ `pass` è¯­å¥ï¼Œè¡¨æ˜å…¶å…·ä½“æ¸…ç†é€»è¾‘å°šæœªå®šä¹‰ï¼Œéœ€è¦æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œå¡«å……ã€‚

å‚æ•°ï¼š

- `llm_resp`ï¼š`str`ï¼Œä»å¤§è¯­è¨€æ¨¡å‹è·å–çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆè¯¥å“åº”æ—¶ä½¿ç”¨çš„æç¤ºè¯ã€‚

è¿”å›å€¼ï¼š`list`ï¼Œæ¸…ç†åçš„å“åº”ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªåˆ—è¡¨æˆ–å…¶ä»–ç»“æ„åŒ–æ•°æ®ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[æ¥æ”¶å‚æ•° llm_resp å’Œ prompt]
    B --> C[æ‰§è¡Œæ¸…ç†é€»è¾‘]
    C --> D[è¿”å›æ¸…ç†åçš„ç»“æœ]
    D --> E[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
def _func_cleanup(self, llm_resp: str, prompt: str) -> list:
    pass  # TODO: å®ç°å…·ä½“çš„æ¸…ç†é€»è¾‘ï¼Œä¾‹å¦‚åˆ†å‰²å­—ç¬¦ä¸²ã€å»é™¤ç‰¹å®šå­—ç¬¦ç­‰
```

### `GenActionDetails._func_validate`

è¯¥æ–¹æ³•ç”¨äºéªŒè¯å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯¹`GenActionDetails`åŠ¨ä½œç”Ÿæˆçš„å“åº”å­—ç¬¦ä¸²ï¼ˆ`llm_resp`ï¼‰æ˜¯å¦æœ‰æ•ˆã€‚å…¶æ ¸å¿ƒé€»è¾‘æ˜¯å°è¯•è°ƒç”¨æ¸…ç†å‡½æ•°`_func_cleanup`æ¥å¤„ç†å“åº”ï¼Œå¦‚æœæ¸…ç†è¿‡ç¨‹æˆåŠŸï¼ˆå³æœªæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œåˆ™è®¤ä¸ºå“åº”æœ‰æ•ˆï¼›å¦åˆ™è®¤ä¸ºå“åº”æ— æ•ˆã€‚

å‚æ•°ï¼š
- `llm_resp`ï¼š`str`ï¼Œå¤§è¯­è¨€æ¨¡å‹è¿”å›çš„åŸå§‹å“åº”å­—ç¬¦ä¸²ã€‚
- `prompt`ï¼š`str`ï¼Œç”Ÿæˆæ­¤å“åº”æ‰€ä½¿ç”¨çš„æç¤ºè¯ï¼ˆåœ¨æœ¬æ–¹æ³•ä¸­æœªä½¿ç”¨ï¼‰ã€‚

è¿”å›å€¼ï¼š`bool`ï¼Œå¦‚æœå“åº”å­—ç¬¦ä¸²å¯ä»¥è¢«æˆåŠŸæ¸…ç†ï¼Œåˆ™è¿”å›`True`ï¼Œå¦åˆ™è¿”å›`False`ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B{å°è¯•è°ƒç”¨ _func_cleanup(llm_resp)}ï¼›
    B -- æˆåŠŸ --> C[è¿”å› True]ï¼›
    B -- æŠ›å‡ºå¼‚å¸¸ --> D[è¿”å› False]ï¼›
    C --> E[ç»“æŸ]ï¼›
    D --> Eï¼›
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_validate(self, llm_resp: str, prompt: str) -> bool:
        # TODO -- this sometimes generates error
        try:
            # æ ¸å¿ƒéªŒè¯é€»è¾‘ï¼šå°è¯•è°ƒç”¨æ¸…ç†å‡½æ•°ã€‚
            # å¦‚æœæ¸…ç†å‡½æ•°èƒ½æ­£å¸¸æ‰§è¡Œï¼ˆä¸æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œåˆ™è®¤ä¸ºå“åº”æ ¼å¼åŸºæœ¬æœ‰æ•ˆã€‚
            self._func_cleanup(llm_resp)
        except Exception:
            # å¦‚æœåœ¨æ¸…ç†è¿‡ç¨‹ä¸­æ•è·åˆ°ä»»ä½•å¼‚å¸¸ï¼Œåˆ™è®¤ä¸ºå“åº”æ— æ•ˆã€‚
            return False
        # æ¸…ç†æˆåŠŸï¼Œè¿”å›æœ‰æ•ˆæ ‡å¿—ã€‚
        return True
```

### `GenActionDetails._func_fail_default_resp`

è¯¥æ–¹æ³•ç”¨äºåœ¨ç”ŸæˆåŠ¨ä½œè¯¦æƒ…çš„LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰è°ƒç”¨å¤±è´¥æ—¶ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤çš„ã€å®‰å…¨çš„ç©ºå“åº”ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹ä»èƒ½è¿”å›ä¸€ä¸ªç»“æ„åŒ–çš„ç»“æœï¼Œé¿å…åç»­å¤„ç†æµç¨‹å› æ•°æ®ç¼ºå¤±è€Œä¸­æ–­ã€‚

å‚æ•°ï¼š
-  `self`ï¼š`GenActionDetails`ï¼Œç±»å®ä¾‹è‡ªèº«ï¼Œç”¨äºè®¿é—®ç±»å±æ€§å’Œæ–¹æ³•ã€‚

è¿”å›å€¼ï¼š`dict`ï¼Œè¿”å›ä¸€ä¸ªç©ºçš„Pythonå­—å…¸ `{}`ï¼Œä½œä¸ºç”ŸæˆåŠ¨ä½œè¯¦æƒ…å¤±è´¥æ—¶çš„é»˜è®¤å“åº”ã€‚

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[åˆ›å»ºç©ºå­—å…¸ fs = {}]
    B --> C[è¿”å› fs]
    C --> D[ç»“æŸ]
```

#### å¸¦æ³¨é‡Šæºç 

```python
    def _func_fail_default_resp(self):
        # åˆ›å»ºä¸€ä¸ªç©ºå­—å…¸ä½œä¸ºé»˜è®¤çš„å¤±è´¥å“åº”
        fs = {}
        # è¿”å›è¯¥ç©ºå­—å…¸
        return fs
```

### `GenActionDetails.run`

è¯¥æ–¹æ³•ç”¨äºç”Ÿæˆè§’è‰²åŠ¨ä½œçš„è¯¦ç»†æè¿°ï¼ŒåŒ…æ‹¬åŠ¨ä½œå‘ç”Ÿçš„åœ°ç‚¹ã€å¯¹è±¡ã€æŒç»­æ—¶é—´ã€å‘éŸ³ã€äº‹ä»¶ç­‰ã€‚å®ƒé€šè¿‡è°ƒç”¨å¤šä¸ªå­åŠ¨ä½œç”Ÿæˆå™¨æ¥æ„å»ºä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œå­—å…¸ï¼Œæœ€ç»ˆè¿”å›åŒ…å«æ‰€æœ‰åŠ¨ä½œç»†èŠ‚çš„å­—å…¸ã€‚

å‚æ•°ï¼š

- `role`ï¼š`STRole`ï¼Œè¡¨ç¤ºæ‰§è¡ŒåŠ¨ä½œçš„è§’è‰²å¯¹è±¡
- `act_desp`ï¼š`str`ï¼Œè¡¨ç¤ºåŠ¨ä½œçš„æè¿°å­—ç¬¦ä¸²
- `act_dura`ï¼š`int`ï¼Œè¡¨ç¤ºåŠ¨ä½œçš„æŒç»­æ—¶é—´

è¿”å›å€¼ï¼š`dict`ï¼ŒåŒ…å«åŠ¨ä½œçš„è¯¦ç»†ä¿¡æ¯çš„å­—å…¸ï¼Œå¦‚åŠ¨ä½œåœ°å€ã€æŒç»­æ—¶é—´ã€æè¿°ã€å‘éŸ³ã€äº‹ä»¶ç­‰

#### æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹] --> B[è·å–è§’è‰²å½“å‰ç“¦ç‰‡ä¿¡æ¯]
    B --> C[ç”ŸæˆåŠ¨ä½œåŒºåŸŸ]
    C --> D[ç”ŸæˆåŠ¨ä½œåœºæ‰€]
    D --> E[ç”ŸæˆåŠ¨ä½œåœ°å€]
    E --> F{æ£€æŸ¥å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡}
    F -->|æ— | G[è®¾ç½®åŠ¨ä½œä¸ºéšæœº]
    F -->|æœ‰| H[ç”ŸæˆåŠ¨ä½œå¯¹è±¡]
    G --> I[ç”ŸæˆåŠ¨ä½œå‘éŸ³]
    H --> I
    I --> J[ç”ŸæˆåŠ¨ä½œäº‹ä»¶]
    J --> K[ç”ŸæˆåŠ¨ä½œå¯¹è±¡æè¿°]
    K --> L[ç”ŸæˆåŠ¨ä½œå¯¹è±¡å‘éŸ³]
    L --> M[ç”ŸæˆåŠ¨ä½œå¯¹è±¡äº‹ä»¶]
    M --> N[æ„å»ºç»“æœå­—å…¸]
    N --> O[è®°å½•æ—¥å¿—]
    O --> P[è¿”å›ç»“æœå­—å…¸]
```

#### å¸¦æ³¨é‡Šæºç 

```python
async def run(self, role: "STRole", act_desp: str, act_dura):
    # è·å–è§’è‰²å½“å‰ç“¦ç‰‡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸–ç•Œå’ŒåŒºåŸŸ
    access_tile = role.rc.env.observe(
        obs_params=EnvObsParams(obs_type=EnvObsType.GET_TITLE, coord=role.scratch.curr_tile)
    )
    act_world = access_tile["world"]
    
    # ç”ŸæˆåŠ¨ä½œå‘ç”Ÿçš„åŒºåŸŸ
    act_sector = await GenActionSector().run(role, access_tile, act_desp)
    
    # ç”ŸæˆåŠ¨ä½œå‘ç”Ÿçš„åœºæ‰€
    act_arena = await GenActionArena().run(role, act_desp, act_world, act_sector)
    
    # æ„å»ºåŠ¨ä½œåœ°å€
    act_address = f"{act_world}:{act_sector}:{act_arena}"
    
    # æ£€æŸ¥è¯¥åœ°å€æ˜¯å¦æœ‰å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¾ç½®ä¸ºéšæœº
    if not role.s_mem.get_str_accessible_arena_game_objects(act_address):
        act_game_object = "<random>"
    else:
        # ç”ŸæˆåŠ¨ä½œå¯¹è±¡
        act_game_object = await GenActionObject().run(role, act_desp, act_address)
    
    # æ„å»ºæ–°çš„åŠ¨ä½œåœ°å€ï¼ŒåŒ…å«æ¸¸æˆå¯¹è±¡
    new_address = f"{act_world}:{act_sector}:{act_arena}:{act_game_object}"
    
    # ç”ŸæˆåŠ¨ä½œçš„å‘éŸ³
    act_pron = await GenPronunciatio().run(role, act_desp)
    
    # ç”ŸæˆåŠ¨ä½œçš„äº‹ä»¶
    act_event = await GenEventTriple().run(role, act_desp)
    
    # ç”ŸæˆåŠ¨ä½œå¯¹è±¡çš„æè¿°
    act_obj_desp = await GenActObjDescription().run(role, act_game_object, act_desp)
    
    # ç”ŸæˆåŠ¨ä½œå¯¹è±¡çš„å‘éŸ³
    act_obj_pron = await GenPronunciatio().run(role, act_obj_desp)
    
    # ç”ŸæˆåŠ¨ä½œå¯¹è±¡çš„äº‹ä»¶
    act_obj_event = await GenObjEventTriple().run(role, act_game_object, act_obj_desp)
    
    # æ„å»ºåŒ…å«æ‰€æœ‰åŠ¨ä½œç»†èŠ‚çš„å­—å…¸
    result_dict = {
        "action_address": new_address,
        "action_duration": int(act_dura),
        "action_description": act_desp,
        "action_pronunciatio": act_pron,
        "action_event": act_event,
        "chatting_with": None,
        "chat": None,
        "chatting_with_buffer": None,
        "chatting_end_time": None,
        "act_obj_description": act_obj_desp,
        "act_obj_pronunciatio": act_obj_pron,
        "act_obj_event": act_obj_event,
    }
    
    # è®°å½•æ—¥å¿—
    logger.info(f"Role: {role.name} Action: {self.cls_name} output: {result_dict}")
    
    # è¿”å›ç»“æœå­—å…¸
    return result_dict
```

## å…³é”®ç»„ä»¶


### GenActionSector

æ ¹æ®è§’è‰²å½“å‰çŠ¶æ€ã€å¯è®¿é—®åŒºåŸŸå’ŒåŠ¨ä½œæè¿°ï¼Œç”ŸæˆåŠ¨ä½œå‘ç”Ÿçš„â€œæ‰‡åŒºâ€ï¼ˆSectorï¼‰ä½ç½®ã€‚å®ƒé€šè¿‡æŸ¥è¯¢è§’è‰²çš„ç©ºé—´è®°å¿†ï¼Œæ„å»ºæç¤ºè¯è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¥å†³ç­–ï¼Œå¹¶åŒ…å«å¯¹è¾“å‡ºç»“æœçš„éªŒè¯ã€æ¸…ç†å’Œåå¤‡é€»è¾‘ã€‚

### GenActionArena

åœ¨ç»™å®šçš„ä¸–ç•Œï¼ˆWorldï¼‰å’Œæ‰‡åŒºï¼ˆSectorï¼‰å†…ï¼Œæ ¹æ®åŠ¨ä½œæè¿°ï¼Œç”ŸæˆåŠ¨ä½œå‘ç”Ÿçš„å…·ä½“â€œåœºæ‰€â€ï¼ˆArenaï¼‰ã€‚å®ƒåŒæ ·åŸºäºè§’è‰²çš„ç©ºé—´è®°å¿†å’ŒLLMè¿›è¡Œå†³ç­–ï¼Œå¹¶å¯¹å¯è®¿é—®çš„åœºæ‰€åˆ—è¡¨è¿›è¡Œè¿‡æ»¤ï¼ˆä¾‹å¦‚ï¼Œåªå…è®¸è®¿é—®åŒå§“è§’è‰²çš„æˆ¿é—´ï¼‰ã€‚

### GenActionObject

åœ¨æŒ‡å®šçš„åœ°å€ï¼ˆåŒ…å«ä¸–ç•Œã€æ‰‡åŒºã€åœºæ‰€ï¼‰å†…ï¼Œæ ¹æ®åŠ¨ä½œæè¿°ï¼Œç”ŸæˆåŠ¨ä½œæ‰€é’ˆå¯¹çš„å…·ä½“â€œæ¸¸æˆå¯¹è±¡â€ï¼ˆGame Objectï¼‰ã€‚å®ƒæŸ¥è¯¢è¯¥åœ°å€ä¸‹æ‰€æœ‰å¯è®¿é—®çš„å¯¹è±¡ï¼Œå¹¶é€šè¿‡LLMé€‰æ‹©æœ€ç›¸å…³çš„ä¸€ä¸ªï¼Œå¦‚æœLLMè¾“å‡ºæ— æ•ˆåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªã€‚

### GenPronunciatio

æ ¹æ®åŠ¨ä½œæè¿°ï¼Œç”Ÿæˆä»£è¡¨è¯¥åŠ¨ä½œçš„â€œå‘éŸ³ç¬¦å·â€ï¼ˆPronunciatioï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨æƒ…ç¬¦å·ï¼ˆEmojiï¼‰ã€‚å®ƒé€šè¿‡LLMå°†è‡ªç„¶è¯­è¨€æè¿°è½¬åŒ–ä¸ºç®€æ´çš„ç¬¦å·è¡¨ç¤ºã€‚

### GenEventTriple

æ ¹æ®è§’è‰²å’ŒåŠ¨ä½œæè¿°ï¼Œç”Ÿæˆæè¿°è¯¥åŠ¨ä½œçš„â€œäº‹ä»¶ä¸‰å…ƒç»„â€ï¼ˆEvent Tripleï¼‰ï¼Œæ ¼å¼ä¸ºï¼ˆä¸»è¯­ï¼Œè°“è¯­ï¼Œå®¾è¯­ï¼‰ã€‚å®ƒç”¨äºä»¥ç»“æ„åŒ–çš„æ–¹å¼è®°å½•è§’è‰²è¡Œä¸ºã€‚

### GenActObjDescription

æ ¹æ®åŠ¨ä½œæè¿°å’ŒåŠ¨ä½œå¯¹è±¡ï¼Œç”Ÿæˆæè¿°è¯¥å¯¹è±¡åœ¨åŠ¨ä½œä¸­çŠ¶æ€çš„â€œå¯¹è±¡äº‹ä»¶æè¿°â€ï¼ˆAct Object Descriptionï¼‰ã€‚ä¾‹å¦‚ï¼Œâ€œåºŠâ€åœ¨â€œç¡è§‰â€åŠ¨ä½œä¸­å¯èƒ½è¢«æè¿°ä¸ºâ€œè¢«ä½¿ç”¨â€ã€‚

### GenObjEventTriple

æ ¹æ®åŠ¨ä½œå¯¹è±¡åŠå…¶çŠ¶æ€æè¿°ï¼Œç”Ÿæˆæè¿°è¯¥å¯¹è±¡çŠ¶æ€å˜åŒ–çš„â€œå¯¹è±¡äº‹ä»¶ä¸‰å…ƒç»„â€ï¼ˆObject Event Tripleï¼‰ï¼Œæ ¼å¼ä¸ºï¼ˆå¯¹è±¡ï¼ŒçŠ¶æ€ï¼Œæè¿°ï¼‰ã€‚å®ƒç”¨äºä»¥ç»“æ„åŒ–æ–¹å¼è®°å½•å¯¹è±¡çš„çŠ¶æ€å˜åŒ–ã€‚

### GenActionDetails

åŠ¨ä½œç»†èŠ‚ç”Ÿæˆçš„æ€»åè°ƒå™¨ã€‚å®ƒæŒ‰é¡ºåºè°ƒç”¨ä¸Šè¿°å„ä¸ªç»„ä»¶ï¼ˆGenActionSector, GenActionArena, GenActionObject, GenPronunciatio, GenEventTriple, GenActObjDescription, GenObjEventTripleï¼‰ï¼Œæ•´åˆæ‰€æœ‰ç”Ÿæˆçš„ä¿¡æ¯ï¼ˆå¦‚åœ°å€ã€æŒç»­æ—¶é—´ã€æè¿°ã€ç¬¦å·ã€äº‹ä»¶ä¸‰å…ƒç»„ç­‰ï¼‰ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œç»†èŠ‚å­—å…¸ã€‚


## é—®é¢˜åŠå»ºè®®


### å·²çŸ¥é—®é¢˜

1.  **ç¡¬ç¼–ç çš„æ¨¡æ¿æ–‡ä»¶åå’Œé»˜è®¤å€¼**ï¼šå¤šä¸ªç±»ï¼ˆå¦‚ `GenActionSector`, `GenActionArena`ï¼‰åœ¨ `run` æ–¹æ³•ä¸­ç›´æ¥ç¡¬ç¼–ç äº†æ¨¡æ¿æ–‡ä»¶åï¼ˆå¦‚ `"action_location_sector_v1.txt"`ï¼‰å’Œå¤±è´¥é»˜è®¤è¿”å›å€¼ï¼ˆå¦‚ `"kitchen"`, `"bed"`ï¼‰ã€‚è¿™ä½¿å¾—ä»£ç éš¾ä»¥ç»´æŠ¤å’Œé€‚åº”å˜åŒ–ï¼Œä¾‹å¦‚å½“éœ€è¦æ›´æ¢æç¤ºæ¨¡æ¿æˆ–é»˜è®¤è¡Œä¸ºæ—¶ï¼Œéœ€è¦ä¿®æ”¹å¤šå¤„æºä»£ç ã€‚
2.  **é‡å¤çš„éªŒè¯å’Œæ¸…ç†é€»è¾‘**ï¼š`GenActionSector` å’Œ `GenActionArena` ç±»çš„ `_func_validate` å’Œ `_func_cleanup` æ–¹æ³•é€»è¾‘å®Œå…¨ä¸€è‡´ï¼Œ`GenEventTriple` å’Œ `GenObjEventTriple` ä¹Ÿå­˜åœ¨é«˜åº¦ç›¸ä¼¼çš„é€»è¾‘ã€‚è¿™è¿åäº† DRYï¼ˆDonâ€˜t Repeat Yourselfï¼‰åŸåˆ™ï¼Œå¢åŠ äº†ç»´æŠ¤æˆæœ¬å’Œå‡ºé”™é£é™©ã€‚
3.  **ä¸´æ—¶æ€§ä»£ç æ³¨é‡Š**ï¼š`GenActionSector` å’Œ `GenActionArena` çš„ `run` æ–¹æ³•ä¸­å­˜åœ¨è¢«æ³¨é‡Šæ‰çš„ä»£ç å—ï¼ˆæ ‡è®°ä¸º `# MAR 11 TEMP`ï¼‰ï¼Œè¿™äº›ä»£ç è™½ç„¶è¢«æ³¨é‡Šï¼Œä½†å¢åŠ äº†ä»£ç çš„æ··ä¹±åº¦ï¼Œå¯èƒ½è¡¨ç¤ºæœªå®Œæˆçš„é‡æ„æˆ–é—ç•™çš„è°ƒè¯•ä»£ç ï¼Œå½±å“å¯è¯»æ€§ã€‚
4.  **è„†å¼±çš„å­—ç¬¦ä¸²è§£æ**ï¼šå¤šä¸ªæ–¹æ³•ï¼ˆå¦‚ `create_prompt_input`ï¼‰ä¾èµ–å­—ç¬¦ä¸²åˆ†å‰²ï¼ˆå¦‚ `split("(")`ï¼‰æ¥è§£æ `act_desp` å‚æ•°ã€‚è¿™ç§è§£ææ–¹å¼éå¸¸è„†å¼±ï¼Œå¦‚æœè¾“å…¥æ ¼å¼ç¨æœ‰å˜åŒ–ï¼ˆä¾‹å¦‚æ‹¬å·ä¸åŒ¹é…ã€é¢å¤–ç©ºæ ¼ï¼‰ï¼Œå°±å¯èƒ½å¯¼è‡´é”™è¯¯æˆ–äº§ç”Ÿæ„å¤–çš„ç»“æœã€‚
5.  **æœªå®ç°çš„æ¸…ç†æ–¹æ³•**ï¼š`GenActionDetails` ç±»çš„ `_func_cleanup` æ–¹æ³•ä»…åŒ…å« `pass` è¯­å¥ï¼Œæ²¡æœ‰å®é™…å®ç°ã€‚è€Œå…¶ `_func_validate` æ–¹æ³•è°ƒç”¨äº†è¿™ä¸ªæœªå®ç°çš„æ¸…ç†æ–¹æ³•ï¼Œè¿™å¯èƒ½å¯¼è‡´éªŒè¯é€»è¾‘æ— æ•ˆæˆ–æŠ›å‡ºå¼‚å¸¸ã€‚
6.  **æ½œåœ¨çš„å¾ªç¯ä¾èµ–ä¸ç´§è€¦åˆ**ï¼š`GenActionDetails.run` æ–¹æ³•ç›´æ¥å®ä¾‹åŒ–å¹¶è°ƒç”¨äº†å…¶ä»–å¤šä¸ª `STAction` å­ç±»ï¼ˆå¦‚ `GenActionSector().run(...)`ï¼‰ã€‚è¿™ç§ç´§è€¦åˆä½¿å¾— `GenActionDetails` ç±»ä¾èµ–äºæ‰€æœ‰è¿™äº›å…·ä½“ç±»çš„å®ç°ï¼Œé™ä½äº†æ¨¡å—çš„ç‹¬ç«‹æ€§å’Œå¯æµ‹è¯•æ€§ã€‚
7.  **é­”æ³•æ•°å­—ï¼ˆMagic Numbersï¼‰**ï¼šåœ¨è°ƒç”¨ `_run_gpt35_max_tokens` æ—¶ï¼Œå¤šå¤„ä½¿ç”¨äº†ç¡¬ç¼–ç çš„ `max_tokens=15` æˆ– `max_tokens=30`ã€‚è¿™äº›æ•°å­—ç¼ºä¹è§£é‡Šï¼Œå…¶åˆç†æ€§éš¾ä»¥è¯„ä¼°ï¼Œè°ƒæ•´æ—¶éœ€è¦æœç´¢æ‰€æœ‰å‡ºç°çš„åœ°æ–¹ã€‚
8.  **å¼‚å¸¸å¤„ç†ä¸è¶³**ï¼š`_func_validate` å’Œ `_func_cleanup` æ–¹æ³•ä¸­æ™®éä½¿ç”¨ `try...except Exception` æ¥æ•è·å¼‚å¸¸å¹¶è¿”å› `False` æˆ–é»˜è®¤å€¼ã€‚è¿™ç§å¤„ç†æ–¹å¼è¿‡äºå®½æ³›ï¼Œå¯èƒ½æ©ç›–äº†çœŸæ­£çš„ç¼–ç¨‹é”™è¯¯æˆ–å¤–éƒ¨æœåŠ¡å¼‚å¸¸ï¼Œä¸åˆ©äºè°ƒè¯•å’Œé—®é¢˜å®šä½ã€‚
9.  **æ—¥å¿—ä¿¡æ¯ä¸ä¸€è‡´**ï¼šæ‰€æœ‰ `run` æ–¹æ³•éƒ½ä½¿ç”¨ `logger.info` è®°å½•æ—¥å¿—ï¼Œä½†æ ¼å¼ç•¥æœ‰ä¸åŒï¼ˆæœ‰çš„ä½¿ç”¨ `self.cls_name`ï¼Œæœ‰çš„ç›´æ¥å†™ç±»åï¼‰ã€‚`GenActionSector` ä¸­æœ‰ä¸€è¡Œè¢«æ³¨é‡Šæ‰çš„ `output = random.choice(x)`ï¼Œè¿™å¯èƒ½æ˜¯å¤‡ç”¨çš„é™çº§ç­–ç•¥ï¼Œä½†å½“å‰æœªå¯ç”¨ï¼Œé€»è¾‘ä¸Šç›´æ¥ä½¿ç”¨äº†å±…ä½åŒºåŸŸï¼Œè¿™å¯èƒ½å¹¶éæœ€ä½³åå¤‡æ–¹æ¡ˆã€‚

### ä¼˜åŒ–å»ºè®®

1.  **é…ç½®åŒ–ä¸ä¾èµ–æ³¨å…¥**ï¼š
    *   å°†æç¤ºæ¨¡æ¿æ–‡ä»¶åã€å¤±è´¥é»˜è®¤å€¼ã€`max_tokens` ç­‰é…ç½®é¡¹æå–åˆ°ç±»å±æ€§æˆ–å¤–éƒ¨é…ç½®æ–‡ä»¶ä¸­ã€‚
    *   è€ƒè™‘ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶æˆ–å·¥å‚æ¨¡å¼æ¥ç®¡ç† `GenActionDetails` å¯¹å…¶å­åŠ¨ä½œçš„ä¾èµ–ï¼Œå°†å…·ä½“ç±»çš„å®ä¾‹åŒ–ç§»è‡³å¤–éƒ¨ï¼Œæ³¨å…¥æ¥å£æˆ–æŠ½è±¡åŸºç±»ï¼Œä»¥é™ä½è€¦åˆåº¦ã€‚
2.  **æŠ½è±¡ä¸é‡æ„é‡å¤é€»è¾‘**ï¼š
    *   åˆ›å»ºä¸€ä¸ªåŸºç±»æˆ–æ··å…¥ç±»ï¼ˆMixinï¼‰ï¼Œå°† `_func_validate` å’Œ `_func_cleanup` çš„é€šç”¨é€»è¾‘ï¼ˆå¦‚æ£€æŸ¥é•¿åº¦ã€ç‰¹å®šå­—ç¬¦ï¼‰å°è£…å…¶ä¸­ã€‚å„ä¸ªå­ç±»å¯ä»¥ç»§æ‰¿æˆ–ç»„åˆè¿™ä¸ªç±»ï¼Œå¹¶è¦†ç›–éœ€è¦å®šåˆ¶åŒ–çš„éƒ¨åˆ†ã€‚
    *   å¯¹äº `GenEventTriple` å’Œ `GenObjEventTriple`ï¼Œå¯ä»¥å°è¯•åˆå¹¶å…±æ€§ï¼Œé€šè¿‡å‚æ•°åŒ–å·®å¼‚éƒ¨åˆ†ã€‚
3.  **æ¸…ç†ä»£ç åº“**ï¼š
    *   å®¡æŸ¥å¹¶ç§»é™¤æ‰€æœ‰æ ‡è®°ä¸º `TEMP` çš„æ³¨é‡Šä»£ç å—ã€‚å¦‚æœå®ƒä»¬æ˜¯å¿…è¦çš„é€»è¾‘ï¼Œåº”å°†å…¶æ­£å¼åŒ–å¹¶å–æ¶ˆæ³¨é‡Šï¼›å¦‚æœæ˜¯è°ƒè¯•æ®‹ç•™ï¼Œåˆ™åº”åˆ é™¤ã€‚
    *   ç»Ÿä¸€æ‰€æœ‰ç±»çš„æ—¥å¿—æ ¼å¼ï¼Œä¾‹å¦‚éƒ½ä½¿ç”¨ `self.__class__.__name__` æˆ–ä¸€ä¸ªç»Ÿä¸€çš„å±æ€§æ¥è·å–åŠ¨ä½œåç§°ã€‚
4.  **å¢å¼ºè¾“å…¥å¤„ç†çš„é²æ£’æ€§**ï¼š
    *   ä½¿ç”¨æ›´å¥å£®çš„æ–¹æ³•æ¥è§£æ `act_desp`ï¼Œä¾‹å¦‚æ­£åˆ™è¡¨è¾¾å¼ï¼Œæˆ–è€…åœ¨æ¥å—å‚æ•°æ—¶è¿›è¡Œé¢„å¤„ç†å’ŒéªŒè¯ã€‚
    *   è€ƒè™‘ä¸ºå¤æ‚çš„è¾“å…¥å®šä¹‰æ˜ç¡®çš„æ•°æ®ç»“æ„æˆ–ä½¿ç”¨ Pydantic ç­‰åº“è¿›è¡ŒéªŒè¯ï¼Œè€Œéä¾èµ–åŸå§‹çš„å­—ç¬¦ä¸²æ“ä½œã€‚
5.  **å®ç°æˆ–æ˜ç¡®æ¸…ç†æ–¹æ³•**ï¼š
    *   å®Œæˆ `GenActionDetails._func_cleanup` æ–¹æ³•çš„å®ç°ï¼Œæˆ–è€…å¦‚æœç¡®å®ä¸éœ€è¦ï¼Œåº”å°†å…¶ä»çˆ¶ç±»è¦æ±‚ä¸­ç§»é™¤ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œæˆ–è‡³å°‘è®© `_func_validate` ä¸ä¾èµ–å®ƒã€‚
6.  **æ”¹è¿›å¼‚å¸¸å¤„ç†ç­–ç•¥**ï¼š
    *   å°†å®½æ³›çš„ `except Exception` æ›¿æ¢ä¸ºæ›´å…·ä½“çš„å¼‚å¸¸ç±»å‹æ•è·ã€‚
    *   åœ¨æ•è·å¼‚å¸¸åï¼Œå¯ä»¥è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚åŸå§‹å“åº”ã€æç¤ºå†…å®¹ï¼‰åˆ°æ—¥å¿—ï¼ˆDEBUG æˆ– WARNING çº§åˆ«ï¼‰ï¼Œä»¥ä¾¿äºé—®é¢˜è¯Šæ–­ï¼ŒåŒæ—¶å¯¹å¤–è¿”å›å®šä¹‰è‰¯å¥½çš„å¤±è´¥å“åº”ã€‚
7.  **å®šä¹‰å¸¸é‡ä¸é…ç½®**ï¼š
    *   å°†é­”æ³•æ•°å­—ï¼ˆå¦‚ 15, 30ï¼‰å®šä¹‰ä¸ºç±»å¸¸é‡æˆ–æ¨¡å—çº§å¸¸é‡ï¼Œå¹¶é™„ä¸Šæ³¨é‡Šè¯´æ˜å…¶å«ä¹‰å’Œè®¾å®šä¾æ®ã€‚
8.  **å®Œå–„åå¤‡æœºåˆ¶**ï¼š
    *   é‡æ–°è¯„ä¼° `GenActionSector` ä¸­å½“ LLM è¾“å‡ºæ— æ•ˆæ—¶çš„åå¤‡é€»è¾‘ã€‚è¢«æ³¨é‡Šçš„ `random.choice(x)` å’Œå½“å‰ä½¿ç”¨çš„ `role.scratch.living_area` å“ªä¸ªæ›´åˆç†ï¼Ÿæ˜ç¡®åå¤‡ç­–ç•¥å¹¶ä½¿å…¶å¯é…ç½®ã€‚
9.  **å¢åŠ å•å…ƒæµ‹è¯•**ï¼š
    *   ä¸ºæ¯ä¸ª `_func_validate`, `_func_cleanup`, `_func_fail_default_resp` å’Œ `create_prompt_input` æ–¹æ³•ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–æ­£å¸¸ã€è¾¹ç•Œå’Œå¼‚å¸¸æƒ…å†µï¼Œç¡®ä¿å­—ç¬¦ä¸²å¤„ç†å’ŒéªŒè¯é€»è¾‘çš„å¯é æ€§ã€‚
10. **è€ƒè™‘å¼‚æ­¥ä¼˜åŒ–**ï¼š
    *   åœ¨ `GenActionDetails.run` æ–¹æ³•ä¸­ï¼Œå¤šä¸ª `await` è°ƒç”¨æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚å¦‚æœè¿™äº›å­åŠ¨ä½œä¹‹é—´æ²¡æœ‰ä¸¥æ ¼çš„å…ˆåä¾èµ–ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ `asyncio.gather` å¹¶å‘æ‰§è¡Œï¼Œä»¥é™ä½æ€»ä½“å»¶è¿Ÿã€‚


## å…¶å®ƒ


### è®¾è®¡ç›®æ ‡ä¸çº¦æŸ

æœ¬æ¨¡å—çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºä¸€ç»„æ™ºèƒ½ä½“ï¼ˆè§’è‰²ï¼‰ç”Ÿæˆå…¶å…·ä½“åŠ¨ä½œçš„è¯¦ç»†æè¿°å’Œå…ƒæ•°æ®ã€‚è¿™äº›åŠ¨ä½œå‘ç”Ÿåœ¨æ¨¡æ‹Ÿçš„â€œæ–¯å¦ç¦å°é•‡â€ç¯å¢ƒä¸­ã€‚æ ¸å¿ƒçº¦æŸåŒ…æ‹¬ï¼šå¿…é¡»ä¸åº•å±‚ç¯å¢ƒï¼ˆ`EnvSpace`ï¼‰å’Œè§’è‰²è®°å¿†ç³»ç»Ÿï¼ˆ`STRole.s_mem`ï¼‰é›†æˆï¼›å¿…é¡»ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆGPT-3.5ï¼‰ä½œä¸ºæ ¸å¿ƒæ¨ç†å¼•æ“æ¥ç”Ÿæˆè‡ªç„¶è¯­è¨€å’Œç»“æ„åŒ–è¾“å‡ºï¼›ç”Ÿæˆçš„è¾“å‡ºï¼ˆå¦‚åœ°ç‚¹ã€å¯¹è±¡ã€è¡¨æƒ…ç¬¦å·ã€äº‹ä»¶ä¸‰å…ƒç»„ï¼‰å¿…é¡»ç¬¦åˆç¯å¢ƒå¯è¾¾æ€§å’Œè§’è‰²èƒŒæ™¯çš„çº¦æŸï¼›ä»£ç éœ€è¦å…·å¤‡ä¸€å®šçš„å®¹é”™æ€§ï¼Œå½“LLMè¾“å‡ºä¸ç¬¦åˆé¢„æœŸæ—¶ï¼Œèƒ½æä¾›åˆç†çš„é»˜è®¤å€¼æˆ–å›é€€é€»è¾‘ã€‚

### é”™è¯¯å¤„ç†ä¸å¼‚å¸¸è®¾è®¡

æ¨¡å—çš„é”™è¯¯å¤„ç†ä¸»è¦å›´ç»•LLMå“åº”çš„éªŒè¯å’Œæ¸…ç†å±•å¼€ã€‚æ¯ä¸ª`STAction`å­ç±»éƒ½å®ç°äº†`_func_validate`å’Œ`_func_cleanup`æ–¹æ³•ï¼Œç”¨äºæ£€æŸ¥LLMè¿”å›çš„å­—ç¬¦ä¸²æ ¼å¼æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶è¿›è¡Œæ¸…æ´—ä»¥æå–æ‰€éœ€éƒ¨åˆ†ã€‚å¦‚æœéªŒè¯å¤±è´¥ï¼Œ`_func_fail_default_resp`æ–¹æ³•ä¼šæä¾›ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤è¿”å›å€¼ã€‚åœ¨`run`æ–¹æ³•ä¸­ï¼Œéƒ¨åˆ†ç±»ï¼ˆå¦‚`GenActionSector`, `GenActionObject`ï¼‰åœ¨LLMè¾“å‡ºåï¼Œä¼šå†æ¬¡ä¸ç¯å¢ƒæˆ–è®°å¿†ä¸­çš„å¯è¾¾é›†åˆè¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœè¾“å‡ºä¸åœ¨æœ‰æ•ˆé›†åˆå†…ï¼Œåˆ™ä½¿ç”¨éšæœºé€‰æ‹©æˆ–å›é€€åˆ°è§’è‰²ç”Ÿæ´»åŒºåŸŸç­‰ç­–ç•¥ã€‚æ•´ä½“ä¸Šï¼Œå¼‚å¸¸è¢«æ§åˆ¶åœ¨ç±»å†…éƒ¨å¤„ç†ï¼Œ`run`æ–¹æ³•å¯¹å¤–è¿”å›æœ‰æ•ˆå€¼ï¼Œä¸å‘ä¸ŠæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼Œä¿è¯äº†è°ƒç”¨é“¾çš„ç¨³å®šæ€§ã€‚æ—¥å¿—ç³»ç»Ÿè®°å½•äº†æ¯ä¸ªåŠ¨ä½œçš„è¾“å…¥å’Œè¾“å‡ºï¼Œä¾¿äºè¿½è¸ªé—®é¢˜ã€‚

### æ•°æ®æµä¸çŠ¶æ€æœº

æ•°æ®æµå§‹äº`GenActionDetails.run`æ–¹æ³•ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªåŠ¨ä½œæè¿°(`act_desp`)å’ŒæŒç»­æ—¶é—´(`act_dura`)ã€‚æµç¨‹æ˜¯é¡ºåºä¸”ä¾èµ–çš„ï¼šé¦–å…ˆè·å–è§’è‰²å½“å‰æ‰€åœ¨ç“¦ç‰‡çš„ç¯å¢ƒä¿¡æ¯(`access_tile`)ï¼Œç„¶åä¾æ¬¡è°ƒç”¨`GenActionSector` -> `GenActionArena` -> `GenActionObject` æ¥é€çº§ç¡®å®šåŠ¨ä½œå‘ç”Ÿçš„ä¸–ç•Œã€åŒºåŸŸã€åœºæ™¯å’Œå¯¹è±¡ï¼Œæ„å»ºå‡ºå®Œæ•´çš„åŠ¨ä½œåœ°å€(`action_address`)ã€‚æ¥ç€ï¼Œå¹¶è¡Œæˆ–é¡ºåºç”ŸæˆåŠ¨ä½œçš„å‘éŸ³ç¬¦å·(`act_pron`)ã€äº‹ä»¶ä¸‰å…ƒç»„(`act_event`)ã€å¯¹è±¡æè¿°(`act_obj_desp`)ã€å¯¹è±¡å‘éŸ³ç¬¦å·(`act_obj_pron`)å’Œå¯¹è±¡äº‹ä»¶ä¸‰å…ƒç»„(`act_obj_event`)ã€‚æ¯ä¸ªå­ç”Ÿæˆå™¨éƒ½æ¥æ”¶ä¸Šæ¸¸æ•°æ®ï¼ˆä¸»è¦æ˜¯`act_desp`å’Œè§’è‰²ä¿¡æ¯ï¼‰å¹¶äº§ç”Ÿè¾“å‡ºã€‚æ•´ä¸ªæµç¨‹æ²¡æœ‰å¤æ‚çš„å¾ªç¯æˆ–æ¡ä»¶çŠ¶æ€è½¬ç§»ï¼Œæ˜¯ä¸€ä¸ªçº¿æ€§çš„ã€ä»¥æ•°æ®ä¸ºé©±åŠ¨çš„ç®¡é“ï¼Œæœ€ç»ˆå°†æ‰€æœ‰ç»“æœæ±‡æ€»åˆ°ä¸€ä¸ªå­—å…¸ä¸­è¿”å›ã€‚è§’è‰²å¯¹è±¡(`role`)å’Œå…¶è®°å¿†(`s_mem`, `scratch`)ä½œä¸ºå…±äº«çš„ä¸Šä¸‹æ–‡çŠ¶æ€è´¯ç©¿å§‹ç»ˆã€‚

### å¤–éƒ¨ä¾èµ–ä¸æ¥å£å¥‘çº¦

1.  **LLMæœåŠ¡**ï¼šä¾èµ–çˆ¶ç±»`STAction`æä¾›çš„`_run_gpt35`å’Œ`_run_gpt35_max_tokens`æ–¹æ³•è°ƒç”¨GPT-3.5æ¨¡å‹ã€‚å¥‘çº¦æ˜¯è¿™äº›æ–¹æ³•éœ€è¦æ¥æ”¶æç¤ºè¯(`prompt`)å¹¶è¿”å›å­—ç¬¦ä¸²å“åº”ã€‚
2.  **ç¯å¢ƒæ¥å£**ï¼šä¾èµ–`role.rc.env.observe`æ–¹æ³•ï¼Œé€šè¿‡`EnvObsParams`æŸ¥è¯¢ç¯å¢ƒä¿¡æ¯ã€‚å¥‘çº¦æ˜¯è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…å«`world`ã€`sector`ç­‰é”®çš„å­—å…¸(`access_tile`)ã€‚
3.  **è§’è‰²è®°å¿†æ¥å£**ï¼šå¼ºä¾èµ–`STRole`å¯¹è±¡çš„å¤šä¸ªæ–¹æ³•ï¼š
    *   `s_mem.get_str_accessible_sectors(world)`: è¿”å›æŒ‡å®šä¸–ç•Œå†…è§’è‰²å¯è®¿é—®çš„åŒºåŸŸå­—ç¬¦ä¸²åˆ—è¡¨ã€‚
    *   `s_mem.get_str_accessible_sector_arenas(address)`: è¿”å›æŒ‡å®šåœ°å€ï¼ˆä¸–ç•Œ:åŒºåŸŸï¼‰å†…å¯è®¿é—®çš„åœºæ™¯å­—ç¬¦ä¸²åˆ—è¡¨ã€‚
    *   `s_mem.get_str_accessible_arena_game_objects(address)`: è¿”å›æŒ‡å®šåœ°å€ï¼ˆä¸–ç•Œ:åŒºåŸŸ:åœºæ™¯ï¼‰å†…å¯è®¿é—®çš„æ¸¸æˆå¯¹è±¡å­—ç¬¦ä¸²åˆ—è¡¨ã€‚
    *   `scratch`å±æ€§ä¸‹çš„`get_str_name()`, `living_area`, `last_name`, `get_str_daily_plan_req()`, `curr_tile`ç­‰ï¼Œæä¾›è§’è‰²çš„å³æ—¶çŠ¶æ€å’ŒèƒŒæ™¯ä¿¡æ¯ã€‚
4.  **æ¨¡æ¿æ–‡ä»¶**ï¼šä¾èµ–å¤–éƒ¨çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆå¦‚`action_location_sector_v1.txt`ï¼‰ä½œä¸ºLLMæç¤ºè¯æ¨¡æ¿ã€‚å¥‘çº¦æ˜¯è¿™äº›æ–‡ä»¶å­˜åœ¨äºç‰¹å®šè·¯å¾„ï¼Œä¸”åŒ…å«ç‰¹å®šå ä½ç¬¦ä¾›`generate_prompt_with_tmpl_filename`æ–¹æ³•å¡«å……ã€‚
5.  **æ—¥å¿—ç³»ç»Ÿ**ï¼šä¾èµ–`metagpt.logs.logger`è¿›è¡Œä¿¡æ¯è®°å½•ã€‚

### å®‰å…¨ä¸åˆè§„è€ƒè™‘

1.  **æç¤ºè¯æ³¨å…¥**ï¼šä»£ç é€šè¿‡ç¡¬ç¼–ç çš„æ¨¡æ¿å’Œå‚æ•°åˆ—è¡¨æ„å»ºæç¤ºè¯ï¼Œ`prompt_input`åˆ—è¡¨ä¸­çš„ç”¨æˆ·è¾“å…¥ï¼ˆ`act_desp`ï¼‰åœ¨æ‹¼æ¥å‰ç»è¿‡äº†ç®€å•çš„å­—ç¬¦ä¸²åˆ†å‰²å¤„ç†ï¼ˆæå–æ‹¬å·å†…å†…å®¹ï¼‰ï¼Œä½†æœªè¿›è¡Œä¸¥æ ¼çš„æ¸…æ´—æˆ–è½¬ä¹‰ã€‚å¦‚æœ`act_desp`å®Œå…¨æ¥è‡ªä¸å¯ä¿¡æºï¼Œå¯èƒ½å­˜åœ¨æç¤ºè¯æ³¨å…¥é£é™©ï¼Œå½±å“LLMè¾“å‡ºæˆ–äº§ç”Ÿéé¢„æœŸå†…å®¹ã€‚å½“å‰ä¸Šä¸‹æ–‡ï¼ˆæ–¯å¦ç¦å°é•‡æ¨¡æ‹Ÿï¼‰ä¸­ï¼Œ`act_desp`å¯èƒ½ç”±ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†ç”Ÿæˆï¼Œé£é™©ç›¸å¯¹å¯æ§ï¼Œä½†ä»éœ€æ³¨æ„ã€‚
2.  **å†…å®¹å®‰å…¨**ï¼šä¾èµ–çš„GPT-3.5æ¨¡å‹è‡ªèº«å…·å¤‡ä¸€å®šçš„å†…å®¹å®‰å…¨ç­–ç•¥ã€‚ç”Ÿæˆçš„è¾“å‡ºï¼ˆå¦‚äº‹ä»¶æè¿°ã€è¡¨æƒ…ç¬¦å·ï¼‰åœ¨æ¨¡æ‹Ÿç¯å¢ƒå†…éƒ¨ä½¿ç”¨ï¼Œé€šå¸¸ä¸ç›´æ¥é¢å‘æœ€ç»ˆç”¨æˆ·ï¼Œä½†è‹¥ç»“æœç”¨äºç”Ÿæˆå…¬å¼€å†…å®¹ï¼Œåˆ™éœ€è¦é¢å¤–çš„å®¡æ ¸å±‚ã€‚
3.  **æ•°æ®éšç§**ï¼šä»£ç å¤„ç†æ¨¡æ‹Ÿè§’è‰²æ•°æ®ï¼Œä¸æ¶‰åŠçœŸå®ç”¨æˆ·ä¸ªäººä¿¡æ¯ã€‚
4.  **èµ„æºä½¿ç”¨**ï¼šé¢‘ç¹è°ƒç”¨LLMï¼ˆä¸€ä¸ªå®Œæ•´åŠ¨ä½œç”Ÿæˆéœ€è°ƒç”¨çº¦7æ¬¡ï¼‰å¯èƒ½äº§ç”Ÿæ˜¾è‘—çš„æˆæœ¬å’Œå»¶è¿Ÿã€‚ä»£ç ä¸­ä½¿ç”¨äº†`max_tokens`å‚æ•°è¿›è¡Œé™åˆ¶ï¼Œä½†æ•´ä½“ä¼˜åŒ–ä¾èµ–äºä¸Šæ¸¸è°ƒåº¦ã€‚

### æµ‹è¯•ç­–ç•¥å»ºè®®

1.  **å•å…ƒæµ‹è¯•**ï¼š
    *   **éªŒè¯ä¸æ¸…ç†é€»è¾‘**ï¼šä¸ºæ¯ä¸ª`_func_validate`å’Œ`_func_cleanup`æ–¹æ³•ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æœ‰æ•ˆå“åº”ã€è¾¹ç•Œæƒ…å†µï¼ˆç©ºå­—ç¬¦ä¸²ã€ç‰¹æ®Šå­—ç¬¦ï¼‰å’Œæ— æ•ˆå“åº”ã€‚
    *   **é»˜è®¤å“åº”**ï¼šæµ‹è¯•`_func_fail_default_resp`è¿”å›å€¼çš„åˆç†æ€§å’Œç±»å‹ã€‚
    *   **æç¤ºè¯æ„å»º**ï¼šæµ‹è¯•`create_prompt_input`å‡½æ•°ï¼ŒéªŒè¯å…¶æ ¹æ®ä¸åŒè¾“å…¥ï¼ˆå¦‚å¸¦æ‹¬å·/ä¸å¸¦æ‹¬å·çš„`act_desp`ï¼Œä¸åŒçš„`role`çŠ¶æ€ï¼‰ç”Ÿæˆçš„`prompt_input`åˆ—è¡¨æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚
    *   **å›é€€é€»è¾‘**ï¼šæ¨¡æ‹ŸLLMè¿”å›æ— æ•ˆæˆ–ä¸åœ¨å¯è¾¾é›†åˆå†…çš„è¾“å‡ºï¼Œæµ‹è¯•`GenActionSector`å’Œ`GenActionObject`ä¸­çš„å›é€€é€»è¾‘ï¼ˆå¦‚ä½¿ç”¨`random.choice`æˆ–å›é€€åˆ°`living_area`ï¼‰æ˜¯å¦æ­£ç¡®è§¦å‘ã€‚
2.  **é›†æˆæµ‹è¯•**ï¼š
    *   **å®Œæ•´æµç¨‹**ï¼šæ¨¡æ‹Ÿä¸€ä¸ª`STRole`å¯¹è±¡åŠå…¶è®°å¿†ã€ç¯å¢ƒæ¥å£ï¼Œè°ƒç”¨`GenActionDetails.run`ï¼ŒéªŒè¯å…¶è¿”å›çš„å­—å…¸ç»“æ„æ­£ç¡®ï¼Œä¸”å†…éƒ¨å„å­åŠ¨ä½œç”Ÿæˆå™¨çš„è°ƒç”¨é¡ºåºå’Œæ•°æ®ä¼ é€’æ­£ç¡®ã€‚
    *   **å¤–éƒ¨ä¾èµ–Mock**ï¼šä½¿ç”¨Mockå¯¹è±¡æ›¿ä»£çœŸå®çš„`_run_gpt35`ã€`env.observe`å’Œ`s_mem`æ–¹æ³•ï¼Œæ³¨å…¥é¢„è®¾çš„è¿”å›å€¼ï¼Œæµ‹è¯•æ•´ä¸ªæ¨¡å—åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡Œä¸ºã€‚
3.  **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šåœ¨å®Œæ•´çš„æ–¯å¦ç¦å°é•‡æ¨¡æ‹Ÿç¯å¢ƒä¸­ï¼Œè§¦å‘è§’è‰²è§„åˆ’åŠ¨ä½œï¼ŒéªŒè¯`GenActionDetails`ç”Ÿæˆçš„è¡ŒåŠ¨ç»†èŠ‚èƒ½å¦è¢«ç¯å¢ƒæ­£ç¡®æ‰§è¡Œå’Œå‘ˆç°ã€‚
4.  **æ€§èƒ½æµ‹è¯•**ï¼šè¯„ä¼°ç”Ÿæˆä¸€ä¸ªå®Œæ•´åŠ¨ä½œè¯¦æƒ…æ‰€éœ€çš„å¹³å‡æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯LLMè°ƒç”¨çš„å»¶è¿Ÿï¼Œä¸ºç³»ç»Ÿå®æ—¶æ€§æä¾›å‚è€ƒã€‚

    