# `.\pytorch\c10\xpu\XPUStream.h`

```
      // 返回此流的唯一标识符，类型为 int64_t，由其类型和索引生成
      return stream_.id();
    }

    /// Unwrap the underlying c10::Stream object.
    const Stream& unwrap() const {
      return stream_;
    }

    /// Unwrap the underlying c10::Stream object.
    Stream& unwrap() {
      return stream_;
    }

    /// Get the SYCL queue associated with this XPUStream.
    sycl::queue& queue() const {
      return stream_.sycl_queue();
    }

    /// Get the priority of the stream.
    StreamPriority priority() const {
      return stream_.priority();
    }

    /// Check if the stream is valid.
    bool valid() const {
      return stream_.valid();
    }

    /// Wait for all tasks submitted to this stream to complete.
    void synchronize() const {
      stream_.synchronize();
    }

 private:
    // 内部封装的 c10::Stream 对象
    Stream stream_;
};

} // namespace c10::xpu
  /// Return the unique identifier of the underlying stream.
  return stream_.id();
}

/// Return true if all enqueued tasks in this stream have been completed,
/// otherwise return false.
bool query() const {
  return queue().ext_oneapi_empty();
}

/// Performs a blocking wait for the completion of all enqueued tasks in this
/// stream.
void synchronize() const {
  queue().wait_and_throw();
  const c10::impl::PyInterpreter* interp = c10::impl::GPUTrace::get_trace();
  if (C10_UNLIKELY(interp)) {
    (*interp)->trace_gpu_stream_synchronization(
        c10::kXPU, reinterpret_cast<uintptr_t>(&queue()));
  }
}

/// Return the priority that this stream is associated with. Lower numbers
/// represent higher priority.
int priority() const;

/// Explicit conversion to sycl::queue&.
sycl::queue& queue() const;

/// Explicit conversion to Stream.
Stream unwrap() const {
  return stream_;
}

/// Reversibly pack a XPUStream into a struct representation. The XPUStream
/// can be unpacked using unpack3().
struct c10::StreamData3 pack3() const {
  return stream_.pack3();
}

/// Unpack a XPUStream from the 3 fields generated by pack3().
static XPUStream unpack3(
    StreamId stream_id,
    DeviceIndex device_index,
    DeviceType device_type) {
  return XPUStream(Stream::unpack3(stream_id, device_index, device_type));
}

/// Return the range of priority **supported by PyTorch**.
static std::tuple<int, int> priority_range() {
  return std::make_tuple(0, -max_compile_time_stream_priorities + 1);
}
/**
 * 结束命名空间 c10::xpu，标记其作用域的结束。
 */
};

/**
 * 以循环方式从池中获取一个流。
 *
 * 通过将 isHighPriority 设置为 true 来请求最高优先级池中的流。
 * 如果未指定设备索引，则默认为当前设备。
 */
C10_XPU_API XPUStream
getStreamFromPool(const bool isHighPriority = false, DeviceIndex device = -1);

/**
 * 以循环方式从池中获取一个流。
 *
 * 通过为特定设备设置优先级值来请求流。
 * 优先级数值越低，优先级越高。
 * 如果未指定设备索引，则默认为当前设备。
 */
C10_XPU_API XPUStream
getStreamFromPool(const int priority, DeviceIndex device = -1);

/**
 * 获取当前 XPU 设备的当前流，如果未传递设备索引，则为当前设备的流。
 */
C10_XPU_API XPUStream getCurrentXPUStream(DeviceIndex device = -1);

/**
 * 将传入流的设备上的当前流设置为传入的流。
 */
C10_XPU_API void setCurrentXPUStream(XPUStream stream);

/**
 * 重载运算符 << ，用于将 XPUStream 输出到 std::ostream。
 */
C10_XPU_API std::ostream& operator<<(std::ostream& stream, const XPUStream& s);

/**
 * 阻塞设备上流池中所有保留的 SYCL 队列，并等待它们同步。
 * 如果未指定设备索引，则默认为当前设备。
 */
C10_XPU_API void syncStreamsOnDevice(DeviceIndex device = -1);

/**
 * 定义 std 命名空间中的 hash 结构，用于 XPUStream 类型的哈希计算。
 */
namespace std {
template <>
struct hash<c10::xpu::XPUStream> {
  size_t operator()(c10::xpu::XPUStream s) const noexcept {
    return std::hash<c10::Stream>{}(s.unwrap());
  }
};
} // namespace std
```